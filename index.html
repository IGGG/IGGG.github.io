<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta name="theme-color" content="#1b7aca">
  <link rel="icon" href="/images/IGGG_l.png">
  <meta name="application-name" content="群馬大学電子計算機研究会 IGGG">
  <meta name="msapplication-TileColor" content="#1b7aca">
  <meta name="msapplication-square70x70logo" content="/images/IGGG_l.png">
  <meta name="msapplication-square150x150logo" content="/images/IGGG_l.png">
  <meta name="msapplication-wide310x150logo" content="/images/IGGG_l.png">
  <meta name="msapplication-square310x310logo" content="/images/IGGG_l.png">
  <meta name="msapplication-notification" content="frequency=30; polling-uri=/atom.xml">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="/images/IGGG_l.png">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-startup-image" href="/images/IGGG_l.png">

  
  <title>群馬大学電子計算機研究会 IGGG</title>
  <meta name="author" content="IGGG">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="群馬大学電子計算機研究会 IGGG">

  
    <meta property="og:image" content="/IGGG_l.png">
  

  <link rel="alternate" href="/atom.xml" title="群馬大学電子計算機研究会 IGGG" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
    <link href="/css/animate.css" rel="stylesheet">
  
  
    <script src="/js/jquery-2.0.3.min.js"></script>
  
</head>
</html>

<body>
<!--[if lt IE9]>
<script>
alert("Please Update Your IE \n请升级您的IE浏览器");
</script>
< ![endif]-->
  <header id="header" class="header header--fixed hide-from-print animated slideInDown"><div class="alignleft backtohome">
  <a href="/">
    <img id="icon-photo-small" class="personal-photo  animated rotateIn" src="/images/IGGG_l.png" alt="IGGG">
  </a>
  <h1 id="title-mini" class=""><a href="/">群馬大学電子計算機研究会 IGGG</a></h1>
</div>
<a target="_blank" id="mini-toggle" class="more icon alignright"></a>
<nav id="main-nav" class="alignright animated slideInRight">

    
    
      <a target="_blank" class="icon twitter" href="http://twitter.com/IGGGorg"></a>
    
    
    
    
      <a target="_blank" class="icon github" href="http://github.com/IGGG"></a>
    
    
    
    
    
    
    
  <div class="clearfix"></div>
</nav>

</header>
  <aside id="sidebar" class="alignleft animated slideInLeft"><div class="personal-info">
  <figure>
    
    <div  class="backtohome">
      <a href="/">
        <img id="icon-photo-normal" class="personal-photo animated rotateIn" src="/images/IGGG_l.png" alt="IGGG">
      </a>
    </div>
    
    <figcaption>
      <h3 class=>IGGG</h3>
      <p>Information technology researching society</p><p> of the Gunmer,</p><p> by the Gunmer,</p><p> for the Gunmer</p>
    </figcaption>
  </figure>
  <section class="social">
    
    
      <a target="_blank" class="icon twitter depth" href="http://twitter.com/IGGGorg"></a>
    
    
    
    
      <a target="_blank" class="icon github depth" href="http://github.com/IGGG"></a>
    
    
    
    
    
    
    
  </section>
</div>
<div class="theme-info">
  <a target="_blank" href="https://github.com/heruoxin/hexo-persona-color" class="html5"> Persona Color Theme</a> 
  &copy; - 2019 IGGG
  
</div>
</aside>
  <div id="content" class="inner">
    <p id="header-fix"></p>
    <div id="main-col" class="alignright"><div id="wrapper">
  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2019/11/03/tweet-by-gh-actions/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2019/11/03/tweet-by-gh-actions/">GitHub Actions でブログの更新をツイートする</a></h2>
            
            <time class="time title depth" datetime="2019-11-03T01:00:00.000Z">2019-11-03</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2019/10/13/replase-iggg-org-2/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2019/10/13/replase-iggg-org-2/">iggg.org を移行する その２</a></h2>
            
            <time class="time title depth" datetime="2019-10-13T11:00:00.000Z">2019-10-13</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2019/10/11/use-github-actions/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2019/10/11/use-github-actions/">GitHub Actions を使ってみた</a></h2>
            
            <time class="time title depth" datetime="2019-10-10T15:00:00.000Z">2019-10-11</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2019/09/25/libnss-json/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2019/09/25/libnss-json/">libnss-json 始めました</a></h2>
            
            <time class="time title depth" datetime="2019-09-24T15:00:00.000Z">2019-09-25</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2018/12/24/esa-io/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2018/12/24/esa-io/">esaの利用をはじめました</a></h2>
            
            <time class="time title depth" datetime="2018-12-23T15:00:00.000Z">2018-12-24</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2018/12/22/replace-iggg-org/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2018/12/22/replace-iggg-org/">iggg.org を移行する</a></h2>
            
            <time class="time title depth" datetime="2018-12-21T15:00:00.000Z">2018-12-22</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2018/12/15/update-circleci-2/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2018/12/15/update-circleci-2/">CircleCI の設定ファイルを 2.0 に更新</a></h2>
            
            <time class="time title depth" datetime="2018-12-14T17:00:00.000Z">2018-12-15</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2017/06/01/make-tweet-slack-bot/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2017/06/01/make-tweet-slack-bot/">Slack から特定のアカウントでツイートする Bot を作った</a></h2>
            
            <time class="time title depth" datetime="2017-06-01T14:29:36.000Z">2017-06-01</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2017/05/17/make-manager-bot-for-slack/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2017/05/17/make-manager-bot-for-slack/">Slack と GAS と GitHub を使って部内の問題・情報管理を円滑にしたい話</a></h2>
            
            <time class="time title depth" datetime="2017-05-16T15:29:36.000Z">2017-05-17</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2017/05/11/iggg-ghio-on-docker/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2017/05/11/iggg-ghio-on-docker/">IGGG の GitHub Pages の開発環境の Dockerイメージを作る</a></h2>
            
            <time class="time title depth" datetime="2017-05-10T15:29:36.000Z">2017-05-11</time>
          </header>
      </div>
    </article>
  </div>




  <div class="animated fadeIn" idplus="GitHubActionsでブログの更新をツイートする" style="display: none;">
    <div idplusp="GitHubActionsでブログの更新をツイートする">
      <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      
        <img s1c="/images/tweet-by-gh-actions/gh-actions-log.jpg">
      
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2019-11-03T01:00:00.000Z"><a href="#">2019-11-03</a></time>
      
      
  
    <h1 class="depth title">GitHub Actions でブログの更新をツイートする</h1>
  

    </header>
    <div class="entry depth">
      
        <p><img s1c="/images/tweet-by-gh-actions/ikisatsu.jpg" alt></p>
<p>面白そうだったので先に作っちゃいました。<br><a href="https://iggg.github.io/2019/10/11/use-github-actions">GitHub Actions 自体はすでに導入した</a>ので、あとは Tweet をできるようにするだけです。</p>
<h2 id="ツイートメッセージを組み立てる"><a href="#ツイートメッセージを組み立てる" class="headerlink" title="ツイートメッセージを組み立てる"></a>ツイートメッセージを組み立てる</h2><p>こういう感じにツイートしたい:</p>
<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">【ブログを更新しました】libnss-json 始めました <a href="https://t.co/M6g35h7vuj" target="_blank" rel="noopener">https://t.co/M6g35h7vuj</a></p>&mdash; IGGG(群馬大学電子計算機研究会) (@IGGGorg) <a href="https://twitter.com/IGGGorg/status/1176865665635930112?ref_src=twsrc%5Etfw" target="_blank" rel="noopener">September 25, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>このためには</p>
<ol>
<li>記事のタイトル</li>
<li>記事のリンク</li>
</ol>
<p>が必要ですね。これらを git の差分などから構築するために THE シェル芸します。</p>
<p>ブログは Hexo で作っており、記事は <code>source/_posts/hoge.md</code> に追加します。最終的なリンクは <code>[base_url]/YYYY/MM/DD/hoge</code> となるので、リンクを得るには日付の情報とファイル名が必要です。</p>
<p>マークダウンには front matter でタイトルや日付が書いてあります:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: GitHub Actions を使ってみた</span><br><span class="line">date: 2019-10-11 00:00:00</span><br><span class="line">tags:</span><br><span class="line">  - GitHub</span><br><span class="line">categories: Web</span><br><span class="line">cover: "/images/use-github-actions/actions.jpg"</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">IGGG ソフトウェア基盤部のひげです。</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>これをよしなにパースします:</p>
<ol>
<li>更新の有無: <code>git diff fdd0928^...fdd0928 --name-only --diff-filter=A -- source/_posts/*.md</code></li>
<li>(1) のファイルパス <code>path/to/file</code> からタイトル取得: <code>head path/to/file | grep &#39;^title:&#39; | sed &#39;s/^title: *//g&#39;</code></li>
<li>(1) のファイルパスから日付を取得: <code>head path/to/file | grep &#39;^date:&#39; | sed -e &#39;s/^date: *\([0-9]\{4\}\)-\([0-9]\{2\}\)-\([0-9]\{2\}\) .*$/\1\/\2\/\3/g&#39;</code></li>
<li>(1) のファイルパスから拡張子抜きのファイル名を取得: <code>echo path/to/file | sed -e &#39;s/source\/_posts\/\(.*\)\.md/\1/&#39;</code></li>
<li>(3) の日付と (5) のファイル名から URL を取得: <code>echo &quot;https://iggg,github.io/${date}/${file_name}&quot;</code></li>
</ol>
<p>これらをするシェルスクリプトがこちら:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">BASE_URL=<span class="string">"https://iggg.github.io"</span></span><br><span class="line">TWEET_MESSAGE=<span class="string">""</span></span><br><span class="line">LATEST=0</span><br><span class="line"></span><br><span class="line">DIFF_FILES=`git diff <span class="variable">$&#123;TARGET_BRANCH&#125;</span> --name-only --diff-filter=A -- <span class="built_in">source</span>/_posts/*.md`</span><br><span class="line"><span class="keyword">for</span> FILE_PATH <span class="keyword">in</span> <span class="variable">$DIFF_FILES</span> ; <span class="keyword">do</span></span><br><span class="line">  TITLE=`head <span class="variable">$&#123;FILE_PATH&#125;</span> | grep <span class="string">'^title:'</span> | sed <span class="string">'s/^title: *//g'</span>`</span><br><span class="line">  DATE=`head <span class="variable">$&#123;FILE_PATH&#125;</span> | grep <span class="string">'^date:'</span> | sed -e <span class="string">'s/^date: *\([0-9]\&#123;4\&#125;\)-\([0-9]\&#123;2\&#125;\)-\([0-9]\&#123;2\&#125;\) .*$/\1\/\2\/\3/g'</span>`</span><br><span class="line">  FILE_NAME=`<span class="built_in">echo</span> <span class="variable">$&#123;FILE_PATH&#125;</span> | sed -e <span class="string">'s/source\/_posts\/\(.*\)\.md/\1/'</span>`</span><br><span class="line">  MESSAGE=<span class="string">"<span class="variable">$&#123;TITLE&#125;</span> <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;DATE&#125;</span>/<span class="variable">$&#123;FILE_NAME&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">  DATE_TIME=`date -d <span class="string">"<span class="variable">$&#123;DATE&#125;</span>"</span> <span class="string">'+%s'</span>`</span><br><span class="line">  <span class="keyword">if</span> [ <span class="variable">$DATE_TIME</span> -gt <span class="variable">$LATEST</span> ] ; <span class="keyword">then</span></span><br><span class="line">    TWEET_MESSAGE=<span class="string">"【ブログを更新しました】<span class="variable">$&#123;MESSAGE&#125;</span>"</span></span><br><span class="line">    LATEST=<span class="variable">$&#123;DATE_TIME&#125;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;TWEET_MESSAGE&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>TARGET_BRANCH</code> だけ外から与えます。ループしているのは、(1) で複数投稿があった場合に最新のものだけを拾うためです。</p>
<h2 id="ツイートする"><a href="#ツイートする" class="headerlink" title="ツイートする"></a>ツイートする</h2><p>最初は curl で API でも叩けばいいかなぁって思ってたけど Twitter API は意外とめんどい。そこでひらめく、せっかく GitHub Actions だし、アクションを使えばいいんだと(天才)。</p>
<p>ググってもなさそうだったので作りました:</p>
<ul>
<li><a href="https://github.com/matsubara0507/actions/tree/master/tweet" target="_blank" rel="noopener">actions/tweet at master · matsubara0507/actions</a></li>
</ul>
<p>Python の <a href="https://www.tweepy.org/" target="_blank" rel="noopener"><code>tweepy</code></a> を使っています。理由は (1) スクリプト系の言語で (2) 扱いが簡単(クライアントオブジェクト生成してメソッド叩くだけ)で (3) 今でもメンテナンスされているのがちょうどこれだったからです(Ruby の <a href="https://rubygems.org/gems/twitter" target="_blank" rel="noopener"><code>twitter</code></a> gem は2017から更新止まってた)。</p>
<p>使い方はこんな感じ:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">uses:</span> <span class="string">matsubara0507/actions/tweet@master</span></span><br><span class="line"><span class="attr">with:</span></span><br><span class="line"><span class="attr">  consumer_key:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.TWITTER_CONSUMER_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  consumer_secret:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.TWITTER_CONSUMER_SECRET</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  access_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.TWITTER_ACCESS_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  access_token_secret:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.TWITTER_ACCESS_TOKEN_SECRET</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  message:</span> <span class="string">'This is test tweet by GitHub Actions'</span></span><br></pre></td></tr></table></figure>

<p>ここで問題が1つ。どうやってさっき生成したツイートメッセージを <code>with.message</code> に渡すか。<br>ここで、なんかしらのコマンドの実行を与えることはどうやらできないっぽい:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Build</span> <span class="string">tweet</span> <span class="string">message</span></span><br><span class="line">  <span class="comment"># この結果を</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">./.github/scripts/tweet-message.bash</span></span><br><span class="line"><span class="attr">  shell:</span> <span class="string">bash</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Tweet</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">matsubara0507/actions/tweet@master</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    message:</span> <span class="comment"># ここに与えたい</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>この位置で変数を使うには <code>steps.[step_id].outputs.hoge</code> を作る必要がある。<br>しかし、これはアクション側で事前に設定するもの(少なくとも現在は)で、独自で定義することはできない:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># こう言うのができれば良いのに</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Build</span> <span class="string">tweet</span> <span class="string">message</span></span><br><span class="line"><span class="attr">  id:</span> <span class="string">message</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">./.github/scripts/tweet-message.bash</span></span><br><span class="line"><span class="attr">  shell:</span> <span class="string">bash</span></span><br><span class="line"><span class="attr">  output:</span> <span class="string">result</span> <span class="comment"># こんな構文は無い</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Tweet</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">matsubara0507/actions/tweet@master</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    message:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.message.outputs.result</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>だったら、なんかスクリプト実行してその出力を outputs に退避させるアクションを使えばいいんだと(天才)。<br>はい、ググってなさそうだったんで、ないなら作る精神:</p>
<ul>
<li><a href="https://github.com/matsubara0507/actions/tree/master/outputs" target="_blank" rel="noopener">actions/outputs at master · matsubara0507/actions</a></li>
</ul>
<p>これを利用するとこんな感じでツイートできました:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  tweet:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-18.04</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">    - uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Build</span> <span class="string">tweet</span> <span class="string">message</span></span><br><span class="line"><span class="attr">      uses:</span> <span class="string">matsubara0507/actions/outputs@master</span></span><br><span class="line"><span class="attr">      id:</span> <span class="string">message</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        TARGET_BRANCH:</span> <span class="string">HEAD^</span></span><br><span class="line"><span class="attr">      with:</span></span><br><span class="line"><span class="attr">        script_path:</span> <span class="string">./.github/scripts/tweet-message.bash</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Tweet</span></span><br><span class="line"><span class="attr">      uses:</span> <span class="string">matsubara0507/actions/tweet@master</span></span><br><span class="line"><span class="attr">      with:</span></span><br><span class="line"><span class="attr">        consumer_key:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.TWITTER_CONSUMER_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">        consumer_secret:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.TWITTER_CONSUMER_SECRET</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">        access_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.TWITTER_ACCESS_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">        access_token_secret:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.TWITTER_ACCESS_TOKEN_SECRET</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">        message:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.message.outputs.result</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="おまけ-アクションの作り方"><a href="#おまけ-アクションの作り方" class="headerlink" title="おまけ: アクションの作り方"></a>おまけ: アクションの作り方</h2><p>作り方は2つあります。JavaScript (TypeScript) を使う方法と Docker を使う方法。</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">JavaScript</th>
<th align="center">Docker</th>
</tr>
</thead>
<tbody><tr>
<td align="center">仮想環境</td>
<td align="center">Linux, MacOS, Windows</td>
<td align="center">Linux</td>
</tr>
<tr>
<td align="center">起動速度</td>
<td align="center">速い</td>
<td align="center">遅い(pull or build)</td>
</tr>
<tr>
<td align="center">依存関係</td>
<td align="center">前後に影響(たぶん)</td>
<td align="center">アクションで独立</td>
</tr>
</tbody></table>
<p>Docker の方が簡単ですが、JavaScript は次のステップにも影響を与えることができます。<br>ちなみに、<code>outputs</code> アクションは JavaScript で、<code>tweet</code> アクションは Docker で作りました。</p>
<p>両方とも、GitHub リポジトリにあげておけば直接利用できます。</p>
<h3 id="JavaScript-の場合"><a href="#JavaScript-の場合" class="headerlink" title="JavaScript の場合"></a>JavaScript の場合</h3><ul>
<li><a href="https://help.github.com/en/github/automating-your-workflow-with-github-actions/creating-a-javascript-action" target="_blank" rel="noopener">ココを見て</a></li>
<li>アクションのプリミティブなやつはだいたい <a href="https://github.com/actions/toolkit" target="_blank" rel="noopener">actions/toolkit</a> リポジトリにあります</li>
<li>使い方の例が TypeScript だったりするのが罠</li>
</ul>
<h3 id="Docker-の場合"><a href="#Docker-の場合" class="headerlink" title="Docker の場合"></a>Docker の場合</h3><ul>
<li><a href="https://help.github.com/en/github/automating-your-workflow-with-github-actions/creating-a-docker-container-action" target="_blank" rel="noopener">ココを見て</a></li>
<li>GitHub リポジトリの場合は <code>docker build</code></li>
<li>レジストリにあげると <code>docker pull</code></li>
</ul>
<h2 id="おしまい"><a href="#おしまい" class="headerlink" title="おしまい"></a>おしまい</h2><p>GitHub Actions は、いよいよ 11/13 に GA されるんで楽しみです！</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web/">Web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/GitHub/">GitHub</a>, <a href="/tags/JavaScript/">JavaScript</a>, <a href="/tags/Python/">Python</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="iggg.orgを移行するその２" style="display: none;">
    <div idplusp="iggg.orgを移行するその２">
      <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2019-10-13T11:00:00.000Z"><a href="#">2019-10-13</a></time>
      
      
  
    <h1 class="depth title">iggg.org を移行する その２</h1>
  

    </header>
    <div class="entry depth">
      
        <p>これの続きです。</p>
<ul>
<li><a href="/2018/12/21/replace-iggg-org">iggg.org を移行する｜群馬大学電子計算機研究会 IGGG</a></li>
</ul>
<p>半年前…やりきりました。<br>実際に <a href="https://www.iggg.org" target="_blank" rel="noopener">iggg.org</a> はすでに新しくなっており、<a href="https://IGGG/new.iggg.org" target="_blank" rel="noopener">IGGG/new.iggg.org</a> というリポジトリで動いてます。</p>
<p><img s1c="/images/replace-iggg-org/new-iggg-org.jpg" alt></p>
<h2 id="前回からの残タスク"><a href="#前回からの残タスク" class="headerlink" title="前回からの残タスク"></a>前回からの残タスク</h2><p>やったのはこれ</p>
<ol>
<li>NEWSの記事の細かい修正</li>
<li>wiki の移行</li>
<li>コミットから自動生成</li>
<li>ドメインを iggg.org にする</li>
</ol>
<h2 id="1-NEWSの記事の細かい修正"><a href="#1-NEWSの記事の細かい修正" class="headerlink" title="1. NEWSの記事の細かい修正"></a>1. NEWSの記事の細かい修正</h2><p>鬼門その１。<br>いくつか古い記法が残っていました。</p>
<h3 id="埋め込み系"><a href="#埋め込み系" class="headerlink" title="埋め込み系"></a>埋め込み系</h3><p>まずは埋め込み系:</p>
<ul>
<li><a href="https://github.com/IGGG/new.iggg.org/commit/6fa930fcf125c3d370921bc985c8de72a07f080f" target="_blank" rel="noopener">スライド の埋め込み</a> (SlideShare)</li>
<li><a href="https://github.com/IGGG/new.iggg.org/commit/6e5552b94ce77eb81e90d0d9d277ce1c60e77ec2" target="_blank" rel="noopener">Twitter と YouTube の埋め込み</a></li>
</ul>
<p>ええ、この辺りは機械的にやりようがないので。。。</p>
<ol>
<li>問題の箇所がどこか grep</li>
<li>対応する旧ページを見に行く</li>
<li>Embed 記法を書き換える</li>
</ol>
<p>愚直です（たいした数がないのでいいんですけど）。</p>
<h3 id="画像"><a href="#画像" class="headerlink" title="画像"></a>画像</h3><p>そして次は画像。<br>記法の変換は大体できていたのが、サイズがめちゃくちゃデカイので <a href="https://github.com/IGGG/new.iggg.org/commit/e271fd2510d3e49082e60ada56eca556a143f58e" target="_blank" rel="noopener">Hugo のショートコードを設定して直した</a>:</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;&#123; $src := .Get "src" &#125;&#125;</span><br><span class="line">&#123;&#123; $scale := float (default "1" (.Get "scale" )) &#125;&#125;</span><br><span class="line">&#123;&#123; $title := .Get "title" &#125;&#125;</span><br><span class="line">&#123;&#123; $config := imageConfig (printf "/static/%s" $src) &#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">figure</span> <span class="attr">style</span>=<span class="string">"margin: 1em"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; .Site.BaseURL | absLangURL &#125;&#125;&#123;&#123;$src&#125;&#125;"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">style</span>=<span class="string">"max-width: &#123;&#123;mul $config.Width $scale&#125;&#125;px"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">width</span>=<span class="string">"100%"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">alt</span>=<span class="string">"&#123;&#123;$title&#125;&#125;"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">title</span>=<span class="string">"&#123;&#123;$title&#125;&#125;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">figcaption</span>&gt;</span>&#123;&#123;$title&#125;&#125;<span class="tag">&lt;/<span class="name">figcaption</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">figure</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>これを <code>layouts/shortcodes/img.html</code> に保存し、<code>{&lt; img s1c=&quot;/path/to/image&quot; scale=&quot;0.2&quot; title=&quot;タイトル&quot; &gt;}}</code> と書くことでサイズを指定したり、正しいパスに変換してくれたりしてくれる。<br>完璧だ。</p>
<h3 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h3><p>旧ページと新ページでページの URL が変わってしまう。<br>旧はページのタイトルや設定した URL になってるのだが、対して新は日付の URL。<br>さて、どうするか。<br>alias の設定自体は Hugo のフロントマターで指定できます:</p>
<figure class="highlight md"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: "本会の活動拠点が決定しました！"</span><br><span class="line">date: 2014-06-16</span><br><span class="line">aliases:</span><br><span class="line"><span class="bullet">- </span>/news/base-was-decided</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="section">## 場所は…？</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ではどうやって元の URL と新しい URL を対応させるか。<br><strong>根性です。</strong><br><a href="https://github.com/IGGG/new.iggg.org/commit/20016f3b0ce3c7055a6349a57b8a620fd1ba94a0" target="_blank" rel="noopener">根性しました</a>。</p>
<p><img s1c="/images/replace-iggg-org/tesagyo.jpg" alt="根性の様子"></p>
<h2 id="2-wiki-の移行"><a href="#2-wiki-の移行" class="headerlink" title="2. wiki の移行"></a>2. wiki の移行</h2><p>鬼門その２。<br>静的サイトはキッツイので代替の要件から考えた。</p>
<ul>
<li>ページは公開されていい</li>
<li>ユーザー登録は(多少)クローズド</li>
<li>マークダウンか何かでインポートできる</li>
</ul>
<p>以上を踏まえた結果 Scrapbox.io にしました:</p>
<ul>
<li><a href="https://scrapbox.io/iggg/" target="_blank" rel="noopener">IGGG - Scrapbox</a></li>
</ul>
<p>で、以降手順はこんな感じ</p>
<ol>
<li>PukiWiki のデータ全部抜く</li>
<li>PukiWiki から MD に変換</li>
<li>MD 内の wiki へのリンクを Scrapbox に差し替え</li>
<li>画像も Scrapbox にいい感じに</li>
<li>MD を Scrapbox にインポート</li>
</ol>
<h3 id="PukiWiki-のデータ全部抜く"><a href="#PukiWiki-のデータ全部抜く" class="headerlink" title="PukiWiki のデータ全部抜く"></a>PukiWiki のデータ全部抜く</h3><p>自分でセットアップしてないので、まずは PukiWiki のデータを探した:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ls /srv/http/wiki/wiki-data/wiki/ | head</span><br><span class="line">32303137E5B9B4E5BAA620E381A1E381B3E381A3E5AD90E5A4A7E5ADA6.txt</span><br><span class="line">32303138E5B9B4E5BAA620E381A1E381B3E381A3E5AD90E5A4A7E5ADA6.txt</span><br><span class="line">32E3818BE38289E5A78BE381BEE3828BE695B4E695B0E58897.txt</span><br><span class="line">3A526563656E7444656C65746564.txt</span><br><span class="line">3A636F6E6669672F4261644265686176696F72.txt</span><br><span class="line">3A636F6E6669672F617574682F6F70656E69642F6D697869.txt</span><br><span class="line">3A636F6E6669672F6931386E2F746578742F6A615F4A50.txt</span><br><span class="line">3A636F6E6669672F706C7567696E2F6174746163682F6D696D652D74797065.txt</span><br><span class="line">3A636F6E6669672F706C7567696E2F63686172742F64656661756C74.txt</span><br><span class="line">3A636F6E6669672F706C7567696E2F72656665726572.txt</span><br></pre></td></tr></table></figure>

<p>発見。ファイル名はどうやら16進数でエンコードされたURL(タイトル)らしい。<br>Ruby で適当にデコードしてみた:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/srv/http/wiki/wiki-data/wiki</span><br><span class="line">$ find . -name &quot;*.txt&quot; | xargs -INAME ruby -e &apos;puts [ARGV[0].delete(&quot;./&quot;).delete(&quot;.txt&quot;)].pack(&quot;H*&quot;)&apos; NAME</span><br><span class="line">MenuBar</span><br><span class="line">群桐祭 2015</span><br><span class="line">Ren&apos;Pyで遊ぶ(その2)</span><br><span class="line">Help/Plugin/D</span><br><span class="line">Ziyuu</span><br><span class="line">:config/plugin/attach/mime-type</span><br><span class="line">C勉強会2015</span><br><span class="line">ジャンク祭り 2017</span><br><span class="line">ETロボコン2015</span><br><span class="line">arthur63</span><br><span class="line">メンバー会議 20160121</span><br><span class="line">atpons</span><br><span class="line">UML勉強会2018</span><br><span class="line">FrontPage</span><br><span class="line">IGGG Meetup 2016 Winter</span><br><span class="line">CTFの大会</span><br><span class="line">コアメンバー会議 20150327</span><br><span class="line">ジャンク祭り 20150618</span><br><span class="line">ﾄｷｵﾔﾏｸﾞﾁ</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>謎は解けたので後は固めて scp するだけ:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># これは SSH 先</span><br><span class="line">$ sudo tar czvf wiki-data.tar.gz /srv/http/wiki/wiki-data/wiki</span><br><span class="line">...</span><br><span class="line">$ ls -lah wiki-data.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root 249K  9月 30 18:23 wiki-data.tar.gz</span><br><span class="line"></span><br><span class="line"># これはローカル</span><br><span class="line">$ scp hoge@fuga:/path/to/wiki-data.tar.gz .</span><br><span class="line">$ tar xzvf wiki-data.tar.gz</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="PukiWiki-から-MD-に変換"><a href="#PukiWiki-から-MD-に変換" class="headerlink" title="PukiWiki から MD に変換"></a>PukiWiki から MD に変換</h3><p>魔法の sed 芸した:</p>
<ul>
<li><a href="https://qiita.com/yuki-takei/items/152e20f4421333ae8fd9" target="_blank" rel="noopener">PukiWiki の文書を Markdown に変換するワンライナー(一部 crowi-plus 仕様) - Qiita</a></li>
</ul>
<p>とはいえいくつか漏れがある:</p>
<ul>
<li><code>-hoge</code> みたいな h1 要素があり、スペースが無い</li>
<li><code>#contents</code> などもともとマジックワードのようなのがある</li>
<li>画像の形式が変</li>
<li><code>[[xxx:yyy]]</code> 形式のリンク</li>
</ul>
<p>どうしようもないので手動で。。。<br>後、メタっぽいページはいらないので削除した(e.g. <code>Help</code>)。</p>
<p>後、タイトルを Ruby 芸:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ls | grep <span class="string">'.txt'</span> | xargs -IORIG bash -c <span class="string">'ruby -e "puts [ARGV[0].delete(%!.txt!)].pack(%!H*!).gsub(?\s, ?_)" ORIG | xargs -INEW echo mv ORIG NEW.md'</span></span><br></pre></td></tr></table></figure>

<p>これでも漏れがあるので手動で直す。。。(空白とか)</p>
<h3 id="MD-内の-wiki-へのリンクを-Scrapbox-に差し替え"><a href="#MD-内の-wiki-へのリンクを-Scrapbox-に差し替え" class="headerlink" title="MD 内の wiki へのリンクを Scrapbox に差し替え"></a>MD 内の wiki へのリンクを Scrapbox に差し替え</h3><p>参照:</p>
<ul>
<li><a href="https://scrapbox.io/help-jp/ページをリンクする" target="_blank" rel="noopener">ページをリンクする - Scrapbox ヘルプ</a></li>
</ul>
<p>タイトルと同じならこの記法に変換。<br>それ以外は普通のリンクに。</p>
<p><strong>ほぼ手作業で</strong>。</p>
<h3 id="画像も-Scrapbox-にいい感じに"><a href="#画像も-Scrapbox-にいい感じに" class="headerlink" title="画像も Scrapbox にいい感じに"></a>画像も Scrapbox にいい感じに</h3><p>まず画像を持ってくる:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ cd /srv/http/wiki/wiki-data/attach</span><br><span class="line">$ ls | grep -v &apos;.log&apos; | xargs file | grep PNG</span><br><span class="line">32E3818BE38289E5A78BE381BEE3828BE695B4E695B0E58897_696D61676530312E706E67:                                              PNG image data, 225 x 31, 8-bit grayscale, non-interlaced</span><br><span class="line">32E3818BE38289E5A78BE381BEE3828BE695B4E695B0E58897_696D61676530322E706E67:                                              PNG image data, 225 x 31, 8-bit grayscale, non-interlaced</span><br><span class="line">427575_735F646F742E706E67:           PNG image data, 48 x 48, 8-bit/color RGBA, non-interlaced</span><br><span class="line">457863656CE381A7E6A99FE6A2B0E5ADA6E7BF9228E69C80E8BF91E5828DE6B39529E38284E381A3E381A6E381BFE3828B_696D6730312E706E67:  PNG image data, 1462 x 1482, 8-bit/color RGBA, non-interlaced</span><br><span class="line">457863656CE381A7E6A99FE6A2B0E5ADA6E7BF9228E69C80E8BF91E5828DE6B39529E38284E381A3E381A6E381BFE3828B_696D6730322E706E67:  PNG image data, 1456 x 1484, 8-bit/color RGBA, non-interlaced</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>やり方は <code>*.txt</code> と同じ(割愛)。<br>それを同じようにデコード(これは名前を出してみてるだけだけど):</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ls | xargs -I&#123;&#125; ruby -e &apos;puts ARGV[0].split(?_).map&#123;|x| [x].pack(&quot;H*&quot;)&#125;.flatten.join(?/)&apos; &#123;&#125;</span><br><span class="line">2から始まる整数列/image01.png</span><br><span class="line">2から始まる整数列/image02.png</span><br><span class="line">Buu/s_dot.png</span><br><span class="line">Excelで機械学習(最近傍法)やってみる/img01.png</span><br><span class="line">Excelで機械学習(最近傍法)やってみる/img02.png</span><br><span class="line">Excelで機械学習(最近傍法)やってみる/img03.png</span><br><span class="line">Excelで機械学習(最近傍法)やってみる/img04.png</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>画像は Scrapbox にインポートできないっぽいので、大した量じゃないし雑なリポジトリを作って雑にあげた:</p>
<ul>
<li><a href="https://github.com/IGGG/resources" target="_blank" rel="noopener">IGGG/resources - GitHub</a></li>
</ul>
<p>あとは画像のリンクを直すだけ(半ば手作業で)。</p>
<h3 id="MD-を-Scrapbox-にインポート"><a href="#MD-を-Scrapbox-にインポート" class="headerlink" title="MD を Scrapbox にインポート"></a>MD を Scrapbox にインポート</h3><p>参照:</p>
<ul>
<li><a href="https://scrapbox.io/help-jp/ページをインポート・エクスポートする" target="_blank" rel="noopener">ページをインポート・エクスポートする - Scrapbox ヘルプ</a></li>
</ul>
<p>MD から Scrapbox にインポートできる形式に変換するには <code>scrapbox-converter</code> という CLI ツールを使う:</p>
<ul>
<li><a href="https://github.com/pastak/scrapbox-converter" target="_blank" rel="noopener">pastak/scrapbox-converter - GitHub</a></li>
</ul>
<p>ガット変換して、試しにフォーマットして見て変な部分があれば <strong>手作業で</strong> 直してインポート！<br>やったね！</p>
<h3 id="new-iggg-org-側のリンクを修正"><a href="#new-iggg-org-側のリンクを修正" class="headerlink" title="new.iggg.org 側のリンクを修正"></a>new.iggg.org 側のリンクを修正</h3><p>一括置換してみたが記法にいくつか種類があり、<a href="https://github.com/IGGG/new.iggg.org/commit/43b90c9d1f60460f3792e34bcdfad4f4d8725d86" target="_blank" rel="noopener">半ば手作業</a>(完)</p>
<h2 id="3-コミットから自動生成"><a href="#3-コミットから自動生成" class="headerlink" title="3. コミットから自動生成"></a>3. コミットから自動生成</h2><p>せっかくなので GitHub Actions を使った。<br>その辺りは前回の記事に書いた:</p>
<ul>
<li><a href="https://iggg.github.io/2019/10/11/use-github-actions/">GitHub Actions を使ってみた｜群馬大学電子計算機研究会 IGGG</a></li>
</ul>
<h2 id="4-ドメインを-iggg-org-にする"><a href="#4-ドメインを-iggg-org-にする" class="headerlink" title="4. ドメインを iggg.org にする"></a>4. ドメインを iggg.org にする</h2><p>あとはドメインの設定を変えるだけ。<br>リポジトリの Settings で別のカスタムドメインを設定すると勝手に <a href="https://github.com/IGGG/new.iggg.org/commit/c85253722a921fade55422e1b1d20ad1819b370a" target="_blank" rel="noopener"><code>CNAME</code> をプッシュしてくれる</a>。</p>
<h2 id="おしまい"><a href="#おしまい" class="headerlink" title="おしまい"></a>おしまい</h2><p>無事管理するものを減らせたぜ。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web/">Web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/GitHub/">GitHub</a>, <a href="/tags/Hugo/">Hugo</a>, <a href="/tags/Scrapbox-io/">Scrapbox.io</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="GitHubActionsを使ってみた" style="display: none;">
    <div idplusp="GitHubActionsを使ってみた">
      <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2019-10-10T15:00:00.000Z"><a href="#">2019-10-11</a></time>
      
      
  
    <h1 class="depth title">GitHub Actions を使ってみた</h1>
  

    </header>
    <div class="entry depth">
      
        <p>IGGG ソフトウェア基盤部のひげです。<br>GitHub Pages へのデプロイに GitHub Actions を使ってみたので、そのことについて記事を書きます。</p>
<p>ちなみに <a href="https://github.com/IGGG/new.iggg.org" target="_blank" rel="noopener">IGGG/new.iggg.org</a> と <a href="https://github.com/IGGG/IGGG.github.io" target="_blank" rel="noopener">IGGG/IGGG.github.io</a> に GitHub Actions を使ってみました。</p>
<h2 id="GitHub-Actions"><a href="#GitHub-Actions" class="headerlink" title="GitHub Actions"></a>GitHub Actions</h2><p>GitHub が用意した CI/CD。</p>
<p><code>.github/workflows</code> 配下に YAML ファイルで設定を置くことができます。<br>まだベータ版な点に注意。</p>
<ul>
<li><a href="https://github.com/features/actions" target="_blank" rel="noopener">Features • GitHub Actions · GitHub</a></li>
</ul>
<p><img s1c="/images/use-github-actions/actions.jpg" alt></p>
<h2 id="設定する"><a href="#設定する" class="headerlink" title="設定する"></a>設定する</h2><p>やりたいことは2つ:</p>
<ol>
<li>PR では静的サイトを生成できるか試す</li>
<li>メインブランチ(<code>master</code>)なら静的サイトをデプロイする(GitHub Pages)</li>
</ol>
<p>こんな感じにした:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/</span><br><span class="line"> |- .github</span><br><span class="line"> |  |- workflows</span><br><span class="line"> |  |  |- verify.yml</span><br><span class="line"> |  |  \- deploy.yml</span><br><span class="line"> |  \- scripts</span><br><span class="line"> |     \- deploy.bash</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>

<p>うまく Condition を使って一つの YAML にまとめてもよかったんだけど、めんどくさくなったので分けた。<br>ファイル名から察せれる通り、<code>verify.yml</code> が (1) を <code>deploy.yml</code> が (2) のための設定ファイルだ。</p>
<h3 id="verify-yml"><a href="#verify-yml" class="headerlink" title="verify.yml"></a>verify.yml</h3><p><code>verify.yml</code> は次の通り:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Verify</span> <span class="string">PR</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">pull_request</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-18.04</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">    - uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"><span class="attr">      with:</span></span><br><span class="line"><span class="attr">        fetch-depth:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        submodules:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Setup</span> <span class="string">Hugo</span></span><br><span class="line"><span class="attr">      uses:</span> <span class="string">peaceiris/actions-hugo@v2.2.1</span></span><br><span class="line"><span class="attr">      with:</span></span><br><span class="line"><span class="attr">        hugo-version:</span> <span class="string">'0.58.3'</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Build</span></span><br><span class="line"><span class="attr">      run:</span> <span class="string">hugo</span> <span class="bullet">--gc</span> <span class="bullet">--cleanDestinationDir</span> <span class="bullet">--minify</span> <span class="bullet">--config</span> <span class="string">config-prod.toml</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">display</span> <span class="string">status</span></span><br><span class="line"><span class="attr">      uses:</span> <span class="attr">docker://buildpack-deps:18.04-scm</span></span><br><span class="line"><span class="attr">      with:</span></span><br><span class="line"><span class="attr">        entrypoint:</span> <span class="string">git</span></span><br><span class="line"><span class="attr">        args:</span> <span class="string">status</span></span><br></pre></td></tr></table></figure>

<p>(ちなみにこれは IGGG/new.iggg.org の方で、これは Hugo による静的サイト)</p>
<p><code>on: pull_request</code> と記述することで PR に対してのみ動作します。<br><code>jobs</code> 以下が実際の動作の内容で、各ステップでは状態を共有します。<br><code>uses</code> で GitHub Actions で実行するアクション(リポジトリ)を指定できます(<a href="https://github.com/actions" target="_blank" rel="noopener"><code>actions</code> で始まるものは公式です</a>):</p>
<ul>
<li><a href="https://github.com/actions/checkout" target="_blank" rel="noopener">actions/checkout - GitHub</a><ul>
<li>対象のリポジトリのブランチへクローンしてチェックアウトする</li>
<li><code>frtch-depth: 1</code> とすることでシャロークローンしてくれます</li>
<li><code>submodules: true</code> とすることで <code>--recursive</code> オプション付きでクローンしてくれます(Hugo は利用するテーマを submodule として置くことが多い)</li>
</ul>
</li>
<li><a href="https://github.com/peaceiris/actions-hugo" target="_blank" rel="noopener">peaceiris/actions-hugo - GitHub</a><ul>
<li>Hugo をセットアップする</li>
<li><code>hugo-version</code> でバージョンを指定できる</li>
</ul>
</li>
</ul>
<p><code>docker://xxx</code> という指定をすることで、Docker Hub などの Docker イメージのレジストリから直接指定することもできます。<br>で、結局このジョブは、単純に Hugo をビルドしてみてるだけですね。</p>
<h3 id="deploy-yml"><a href="#deploy-yml" class="headerlink" title="deploy.yml"></a>deploy.yml</h3><p>ここからが鬼門。<br>対象は GitHub Pages なので、デプロイするとはすなわち GitHub にプッシュすることですね。<br>その時に CI 側に権限を与える必要があるのですが、個人的にパーソナルトークンを使うのがいやで、可能ならリポジトリごとに設定できる SSH 鍵を使いたい。</p>
<p>そのように設定した <code>deploy.yml</code> は次の通り:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">GitHub</span> <span class="string">Pages</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line"><span class="attr">  push:</span></span><br><span class="line"><span class="attr">    branches:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    paths-ignore:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"docs/**"</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-18.04</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">    - uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"><span class="attr">      with:</span></span><br><span class="line"><span class="attr">        fetch-depth:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        submodules:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Setup</span> <span class="string">Hugo</span></span><br><span class="line"><span class="attr">      uses:</span> <span class="string">peaceiris/actions-hugo@v2.2.1</span></span><br><span class="line"><span class="attr">      with:</span></span><br><span class="line"><span class="attr">        hugo-version:</span> <span class="string">'0.58.3'</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Build</span></span><br><span class="line"><span class="attr">      run:</span> <span class="string">hugo</span> <span class="bullet">--gc</span> <span class="bullet">--cleanDestinationDir</span> <span class="bullet">--minify</span> <span class="bullet">--config</span> <span class="string">config-prod.toml</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">deploy</span></span><br><span class="line"><span class="attr">      uses:</span> <span class="attr">docker://buildpack-deps:18.04-scm</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        DEPLOY_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DEPLOY_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">        GIT_NAME:</span> <span class="string">Bot</span></span><br><span class="line"><span class="attr">        GIT_EMAIL:</span> <span class="string">example@example.com</span></span><br><span class="line"><span class="attr">        TARGET_BRANCH:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">      with:</span></span><br><span class="line"><span class="attr">        entrypoint:</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="attr">        args:</span> <span class="string">.github/scripts/deploy.bash</span></span><br></pre></td></tr></table></figure>

<p><code>on.push.branches</code> でこのワークフローが動作するブランチを指定しています。<br><code>on.push.paths-ignore: [&quot;docs/**&quot;]</code> とすることで、もし <strong>差分が <code>docs</code> 配下にしかない場合は動作しない</strong> ようにしています。<br>この <code>paths-ignore</code> と <code>**</code> は最近追加された機能で、詳しくは後述します。</p>
<p><code>jobs</code> の前半は <code>verify.yml</code> と同じです。<br>違うのは <code>name: deploy</code> のステップだけ。<br>これは <code>.github/scripts/deploy.bash</code> を実行しているだけですね。<br>中身を見てます:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -eux</span><br><span class="line"></span><br><span class="line"><span class="comment"># ssh agent のセットアップ</span></span><br><span class="line"><span class="comment">## DEPLOY_KEY 環境変数に secret から秘密鍵を与える</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">"<span class="variable">$(ssh-agent -s)</span>"</span></span><br><span class="line">mkdir -p /root/.ssh</span><br><span class="line">ssh-keyscan -t rsa github.com &gt; /root/.ssh/known_hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;DEPLOY_KEY&#125;</span>"</span> &gt; /root/.ssh/id_rsa</span><br><span class="line">chmod 400 /root/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line"><span class="comment"># コミットするための準備</span></span><br><span class="line"><span class="comment">## GITHUB_REPOSITORY は GitHub Actions が用意してくれてる環境変数</span></span><br><span class="line">git config user.name <span class="string">"<span class="variable">$&#123;GIT_NAME&#125;</span>"</span></span><br><span class="line">git config user.email <span class="string">"<span class="variable">$&#123;GIT_EMAIL&#125;</span>"</span></span><br><span class="line">git remote <span class="built_in">set</span>-url origin git@github.com:<span class="variable">$&#123;GITHUB_REPOSITORY&#125;</span>.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># docs 配下の差分だけ TARGET_BRANCH にプッシュする</span></span><br><span class="line">git checkout <span class="variable">$&#123;TARGET_BRANCH&#125;</span></span><br><span class="line">git status</span><br><span class="line">git add docs</span><br><span class="line">git diff --staged --quiet || git commit -m <span class="string">"Update docs by GitHub Actions"</span></span><br><span class="line">git push origin <span class="variable">$&#123;TARGET_BRANCH&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>DEPLOY_KEY</code> で指定する SSH 鍵はリポジトリごとに設定するものを指定しています(その方が権限管理が楽で個人的には好みです)。<br><code>git diff --staged --quiet || git commit -m &quot;...&quot;</code> することで <code>docs</code> 配下に差分があった時にだけコミットを作ります。<br>もし差分がなく、コミットを作らなかった場合は <code>git push</code> は変更がなかったとメッセージを吐いて終了します。<br><code>docs</code> 配下に差分があった時だけプッシュすることで <code>on.push.paths-ignore: [&quot;docs/**&quot;]</code> と組み合わさって、GitHub Actions によるプッシュ(デプロイ)で GitHub Actions が再度動作することは無くなります(残念ながら <code>skip ci</code> のような機能は現状無いので)。<br>さて、これでリポジトリごとの SSH 鍵でデプロイする設定ができました！</p>
<p>ちなみに、本当は Secret に秘密鍵を直接置くのは嫌なんですけど、、、まぁとりあえず妥協しました。</p>
<h2 id="躓いたこと-on-push-paths"><a href="#躓いたこと-on-push-paths" class="headerlink" title="躓いたこと: on.push.paths"></a>躓いたこと: on.push.paths</h2><p>公式ドキュメントには当時、以下のようにすれば「<code>docs</code> 配下にのみ差分があったら動作しないようにできる」と書いてありました:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line"><span class="attr">  push:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'*'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'!/docs/*'</span></span><br></pre></td></tr></table></figure>

<p>これではうまくいきません。<br>色々調べた結果、<code>*</code> はディレクトリ階層を掘ってはくれないのです。<br><a href="https://github.community/t5/GitHub-Actions/GitHub-Actions-workflow-not-triggered-with-path/m-p/30321#M400" target="_blank" rel="noopener">これ</a>を読む限り、これはどうやら Go のモジュールの仕様らしいですね。<br>もし <code>*.md</code> の差分だけ動作して欲しい場合は:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line"><span class="attr">  push:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'*.md'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'*/*.md'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'*/*/*.md'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'*/*/*/*.md'</span></span><br></pre></td></tr></table></figure>

<p>みたいなアホな設定をする必要がありました。<br>「ベータだなぁ〜」って思ってた矢先、なんと神アップデートがありました:</p>
<ul>
<li><a href="https://github.blog/changelog/2019-09-30-github-actions-event-filtering-updates" target="_blank" rel="noopener">GitHub Actions – event filtering updates</a></li>
</ul>
<p><code>**</code> でディレクトリ階層を吸収してくれるのです。<br>つまり、<code>**/*.md</code> と書けば任意の深さのマークダウンの差分を検知してくれます。<br>また、<code>paths-ignore</code> は <code>!</code> を省くことができる機能ですね。</p>
<h2 id="おしまい"><a href="#おしまい" class="headerlink" title="おしまい"></a>おしまい</h2><p>GitHub Actions を初めて使ってみましたが、結構満足してます(<code>paths</code> の修正のおかげで)。<br>あとはキャッシュぐらいかな。<br>それと、同じ GitHub 内だし GitHub Actions 用の SSH 鍵を設定する機能を公式が用意して欲しい。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web/">Web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/GitHub/">GitHub</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="libnss-json始めました" style="display: none;">
    <div idplusp="libnss-json始めました">
      <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      
        <img s1c="/images/libnss-json/libnss.png">
      
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2019-09-24T15:00:00.000Z"><a href="#">2019-09-25</a></time>
      
      
  
    <h1 class="depth title">libnss-json 始めました</h1>
  

    </header>
    <div class="entry depth">
      
        <p>こんにちは。IGGG 何もしない部の<a href="https://www.iggg.org/wiki/?atpons" target="_blank" rel="noopener">atpons</a>です。みなさんはサークルのサーバのユーザ管理、どうしていますか？</p>
<p>われわれのサークルは、そこまで規模が大きくないため、サーバの数は少なく、一台のみVPSをレンタルしています。</p>
<p>なので、これまでは手作業でユーザの追加を行ったり、時にはLDAPを用いてユーザを管理していました。しかし、年々メンテナンスをしていくユーザが卒業していき、LDAPなどを全て停止していました。</p>
<p>正しく設定が変更されてLDAPとかが抜けていればいいのですが、実際<code>pam.d</code>以下をちゃんとみて<code>sssd</code>(サークルではSSSDを利用していました)を削除するのがつらく、あるあるなsudo遅い問題（解決しにいくため）などが多発していました。</p>
<h2 id="libnss-jsonを知る"><a href="#libnss-jsonを知る" class="headerlink" title="libnss-jsonを知る"></a>libnss-jsonを知る</h2><p>先日行われた<a href="https://techbookfest.org/" target="_blank" rel="noopener">技術書典7</a>に参加し、<a href="https://trap.jp" target="_blank" rel="noopener">東工大デジタル創作同好会traP</a>のSysAd班が出している「<a href="https://techbookfest.org/event/tbf07/circle/5091367973814272" target="_blank" rel="noopener">traP SysAd TechBook</a>」を買って色々と読んでいたところ、libnss-jsonというのがあると言うことを知りました。</p>
<h3 id="libnssとは"><a href="#libnssとは" class="headerlink" title="libnssとは"></a>libnssとは</h3><p>Linux(*nixにもあるらしい)にはName Service Switch(NSS)と呼ばれる、<code>/etc/passwd</code>などをファイルからどこから読むのかを管理する機構があります。これにLDAPなどを読みに行くようなものを書けば、<code>getent</code>をした際にそこに読みに行きます、というワケです。これらは、NSSサービスとして書くことができます。</p>
<h2 id="libnss-jsonを使う"><a href="#libnss-jsonを使う" class="headerlink" title="libnss-jsonを使う"></a>libnss-jsonを使う</h2><p>これをJSONファイルで定義して、なおかつリモートから読み込んでくれるようなNSSサービスが、<a href="https://github.com/Aklakan/libnss-json" target="_blank" rel="noopener">libnss-json</a>です。導入方法などは上で挙げたtraPの本がとても参考になりました。</p>
<p>実際に導入する際には、導入用のAnsible Playbookを用意したり、Vagrantでしっかりと動作確認できるようにしました。既存のサーバで適用する前に、さまざまなケースを試し、問題ないことを確認した上でデプロイしました。</p>
<p>traPの本では、traPがフォークした<a href="https://github.com/traPtitech/nss" target="_blank" rel="noopener">このリポジトリ</a>を使って紹介されていました。</p>
<h2 id="SSHも便利に使う"><a href="#SSHも便利に使う" class="headerlink" title="SSHも便利に使う"></a>SSHも便利に使う</h2><p>traPの本では、OpenSSHの設定で<code>AuthorizedKeysCommand</code>を上手く使って、上のJSONで定義したユーザ名を使ってGitHubの公開鍵と組み合わせていました。われわれのサークルもこの方式を採用させていただきました。</p>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>Name Service Switchのバックエンドをいろんなモノに差し替えるという発想は、最近だと<a href="https://stns.jp/" target="_blank" rel="noopener">STNS</a>が有名だと思います。ただ、大学のサークル、しかも小規模となると、あまりメンテナンス性とか（抜けることが少ない）、階層性についてこだわりたくないなと思っていました。実際、プロビジョニングツールを書いたりはしていたのですが…。</p>
<p>しかし、このlibnss-jsonでかなり<strong>Lightweight</strong>に管理できて個人的にはとても満足しています。</p>
<p>このlibnss-jsonを自動で展開するAnsible Playbookも書いたので、これで将来サーバが増えても簡単に管理できると思います！</p>
<p>さいごに、有益な情報を書いてくださったtraPのみなさまには感謝しかないです！<br>ありがとうございました。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Infra/">Infra</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/libnss-json/">libnss-json</a>, <a href="/tags/Linux/">Linux</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="esaの利用をはじめました" style="display: none;">
    <div idplusp="esaの利用をはじめました">
      <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2018-12-23T15:00:00.000Z"><a href="#">2018-12-24</a></time>
      
      
  
    <h1 class="depth title">esaの利用をはじめました</h1>
  

    </header>
    <div class="entry depth">
      
        <p>本記事は<a href="http://www.adventar.org/calendars/3217" target="_blank" rel="noopener">IGGG アドベントカレンダー 2018</a> 24日目の記事です。</p>
<p>群馬大学電子計算機研究会 IGGGでは，2018年の2月頃から情報共有の場として<a href="https://esa.io/" target="_blank" rel="noopener">esa</a>を利用させていただいています．</p>
<h2 id="esaとは"><a href="#esaとは" class="headerlink" title="esaとは"></a>esaとは</h2><p><strong>esaは「情報を育てる」という視点で作られた、自律的なチームのための情報共有サービス</strong>（<a href="https://esa.io/" target="_blank" rel="noopener">esa公式ページ</a>より）です．詳しくは公式ページをみていただくとして，とりあえずMarkdownで書けて便利です．</p>
<h2 id="なぜesaか"><a href="#なぜesaか" class="headerlink" title="なぜesaか"></a>なぜesaか</h2><p>IGGGでは，以前から<a href="https://www.iggg.org/wiki/" target="_blank" rel="noopener">PukiWiki</a>が情報共有の場として利用されてきました．これは，外部向けにも閲覧可能であることから，情報発信等には向いていましたが，内部で持っておきたい情報（引き継ぎ・会計等）についてはここには書けない状況になっていました．</p>
<p>先日公開された記事中でも，IGGGがGitHubのissueやWikiをベースとして運営の情報を管理しているということが挙がっていましたが，GitHubを普段利用しないメンバーにとってはなかなか見づらい・使いづらいということが頻繁に起こっていました．</p>
<p>サーバ管理等のコストなどもあり，より良いものに移行していきたい，引き継ぎがうまく出来るようにしたいというところで，esaの存在を知りました．</p>
<h2 id="アカデミックプランの存在"><a href="#アカデミックプランの存在" class="headerlink" title="アカデミックプランの存在"></a>アカデミックプランの存在</h2><p>esaには<a href="https://docs.esa.io/posts/129" target="_blank" rel="noopener">アカデミックプラン</a>が存在しており(2018/12現在)，条件を満たしていれば一定期間無償（再申請可能）で利用することが可能です．</p>
<p>そこで，申請を行い，現在無償で利用させて頂いています．</p>
<h2 id="esaの使いどころ"><a href="#esaの使いどころ" class="headerlink" title="esaの使いどころ"></a>esaの使いどころ</h2><p>個人的には，以下のように使い分けて行っています．</p>
<ul>
<li>esa<ul>
<li>議事録</li>
<li>会計</li>
<li>周知事項など</li>
</ul>
</li>
<li>PukiWiki<ul>
<li>イベント/メンバ向け</li>
</ul>
</li>
<li>GitHub Wiki<ul>
<li>引き継ぎ資料など（esaに移行したいかも？）</li>
</ul>
</li>
</ul>
<p>誰が見たか，記事へのコメント，WIP機能は今までの他のツールにはなく，とても使い勝手が良いです．</p>
<p>副産物として，群馬大学では学内でG Suiteが利用されており，群馬大学のアカウントでログインできるのも，使いやすくて便利です．</p>
<h2 id="所感"><a href="#所感" class="headerlink" title="所感"></a>所感</h2><p>メンバのみなさんには，もっとesaを使って色々書いて行ってみて欲しいです．部内Wikiですから，誰もちょっかい出さないと思うので(笑)，あとバージョニングもあるので戻せますよ！</p>
<p>そろそろ引き継ぎを考える時期になりました．esaをはじめとしたツールを使いこなして，スムーズに引き継ぎが出来るようにがんばります！</p>
<p>最後に，申請を承認していただいたesaのみなさまにはこの場を借りて感謝申し上げます．</p>
<p>記事中の <a href="https://docs.esa.io/posts/79" target="_blank" rel="noopener">esa アイコン</a>は <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">クリエイティブ・コモンズ 表示 - 非営利 - 改変禁止 4.0 国際 ライセンス</a>の下に提供されています。© esa LLC</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Service/">Service</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/esa/">esa</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="iggg.orgを移行する" style="display: none;">
    <div idplusp="iggg.orgを移行する">
      <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2018-12-21T15:00:00.000Z"><a href="#">2018-12-22</a></time>
      
      
  
    <h1 class="depth title">iggg.org を移行する</h1>
  

    </header>
    <div class="entry depth">
      
        <p>本記事は<a href="http://www.adventar.org/calendars/3217" target="_blank" rel="noopener">IGGG アドベントカレンダー 2018</a> 22日目の記事です。</p>
<p>本記事では前々からやろうとしていた <a href="https://iggg.org" target="_blank" rel="noopener">iggg.org</a> の移行作業について書こうと思います。<br>現状ほとんど出来上がっていて、あとは細かいところの確認とドメインの変更を残すだけです。<br>GitHub Pages としてホストしており、下記URLよりアクセスできます。</p>
<ul>
<li><a href="https://iggg.github.io/new.iggg.org/">https://iggg.github.io/new.iggg.org</a></li>
</ul>
<h2 id="なぜ移行するか"><a href="#なぜ移行するか" class="headerlink" title="なぜ移行するか"></a>なぜ移行するか</h2><p>現在(2018/12/22) iggg.org はさくらのマシン上で WordPress を使って動いています。<br>諸々運用・管理がめんどくさくなってきた(アクティブな部員も少なってきたし)ので、(更新しなければ)運用コストゼロの静的サイトにしてしまおうとなったのです。</p>
<h2 id="移行作業"><a href="#移行作業" class="headerlink" title="移行作業"></a>移行作業</h2><p>実はうちには IGGG/management という議論用のプライベートリポジトリがあります。<br>作業はだいたい、そこの Issue に書いてあります。</p>
<p><img s1c="/images/replace-iggg-org/issue.png" alt></p>
<p>社会人になってから Issue に途中作業を雑に書き連ねていく癖がついた。</p>
<h3 id="データを抽出"><a href="#データを抽出" class="headerlink" title="データを抽出"></a>データを抽出</h3><p>まずは WP にあるデータを抽出する必要があります:</p>
<ul>
<li>記事のデータ: 可能なら Markdown として</li>
<li>メディア系(主に画像)</li>
</ul>
<p>記事のデータは最初 <code>wordpress-to-jekyll-exporter</code> を使おうとしましたが、なんかうまくいかず断念。<br>そこで以下の記事を参考にして抽出しました:</p>
<ul>
<li><a href="http://akabeko.me/blog/2016/03/npm-wpxml2md-v1-0-0-release/" target="_blank" rel="noopener">WordPress の Markdown 移行補助ツールを開発してみた - アカベコマイリ</a></li>
</ul>
<p>結構古い記事ですが、ちゃんと動作しました。<br>記事自体は xml2md という自作ツールの紹介ですが、中盤に WordPress を XML としてエクスポートする方法が書かれています。<br>ただ、変な Markdown になっていたり、いらないページまで Markdown になっていたりするので、そこは手作業で間引きます。</p>
<p>さて、次にメディア系です。<br>メディア系の抽出にか以下の記事を参考にしました:</p>
<ul>
<li><a href="https://www.momosiri.info/wppi/export-media-library/" target="_blank" rel="noopener">Wordpressのメディアファイルを一括ダウンロードするプラグイン「Export Media Library」｜Knowledge Base</a></li>
</ul>
<p>このプラグインを利用してローカルにダウンロードしました。<br>あとはこれらを適当に git リポジトリに入れてプッシュすれば抽出完了。</p>
<h3 id="Hugo"><a href="#Hugo" class="headerlink" title="Hugo"></a>Hugo</h3><p>静的サイトジェネレーターには Hugo を使いました。<br>このサイトは Hexo (JS 製)だし、他の IGGG のサイトは Jekyll (Ruby 製)なのですが、せっかくなので使ったことないものを選択してみました。</p>
<p>CSS 職人になって WordPress で利用してたテーマを再現するのは苦行なので、なんとなく構造が似て入ればいいかなぐらいの気持ちで作ります。<br>そのため、なんとなく構造を再現できそうなテーマをベースとして選びました:</p>
<ul>
<li><a href="https://themes.gohugo.io/hugo-theme-dopetrope/" target="_blank" rel="noopener">Hugo Theme Dopetrope｜Hugo Themes</a></li>
</ul>
<p>Hugo 利用するテーマをサブモジュールとして設定するみたいです(多分)。<br>なので、テーマをカスタマイズするためにベースにしたいテーマをフォークしました:</p>
<ul>
<li><a href="https://github.com/IGGG/hugo-theme-dopetrope" target="_blank" rel="noopener">IGGG/hugo-theme-dopetrope - GitHub</a></li>
</ul>
<p>基本的にうちのサイトのホームには:</p>
<ul>
<li>上部にナビゲーター</li>
<li>画像スライダー</li>
<li>最近の記事の更新</li>
<li>IGGGについての説明</li>
<li>イベントボード</li>
<li>Twitter タイムライン</li>
</ul>
<p>があります。<br>ナビゲーターは dopetrope のものを利用しています。<br>ただし，config からナビゲーターの要素を<a href="https://github.com/IGGG/new.iggg.org/blob/c9498f8d30c3ca441708c51493282b12727853e4/config.toml#L15-L67" target="_blank" rel="noopener">次</a>のように指定できるように変更しました:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[params.pages.home]</span></span><br><span class="line">    title = "Home"</span><br><span class="line">    link  = "/"</span><br><span class="line">    internal = true</span><br><span class="line">    order = 0</span><br><span class="line"></span><br><span class="line"><span class="section">[params.pages.about]</span></span><br><span class="line">    title = "About"</span><br><span class="line">    link  = "/about"</span><br><span class="line">    internal = true</span><br><span class="line">    order = 1</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="section">[params.pages.wiki]</span></span><br><span class="line">    title = "Wiki"</span><br><span class="line">    link  = "https://www.iggg.org/wiki/?FrontPage"</span><br><span class="line">    internal = false</span><br><span class="line">    order = 5</span><br></pre></td></tr></table></figure>

<p>順番をうまくコントロールすることができなかったので <code>order</code> というパラメタを持たせています。<br>呼び出し側は<a href="https://github.com/IGGG/hugo-theme-dopetrope/blob/cd4ae533e9e1fdedfecfebb84bca4a3d43d0a787/layouts/partials/nav.html" target="_blank" rel="noopener">次</a>のようになります:</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">id</span>=<span class="string">"nav"</span>&gt;</span></span><br><span class="line">    &#123;&#123; $title   := .Page.Title &#125;&#125;</span><br><span class="line">    &#123;&#123; $relLink := .Page.RelPermalink &#125;&#125;</span><br><span class="line">    &#123;&#123; $baseUrl := .Site.BaseURL &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        &#123;&#123; range $page := sort .Site.Params.Pages "order" &#125;&#125;</span><br><span class="line">            &#123;&#123; if $page.internal &#125;&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> &#123;&#123; <span class="attr">if</span> <span class="attr">or</span> (<span class="attr">eq</span> $<span class="attr">title</span> $<span class="attr">page.title</span>) (<span class="attr">eq</span> $<span class="attr">relLink</span> $<span class="attr">page.link</span>) &#125;&#125; <span class="attr">class</span>=<span class="string">"current"</span> &#123;&#123; <span class="attr">end</span> &#125;&#125;&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; $baseUrl &#125;&#125;&#123;&#123; $page.link &#125;&#125;"</span>&gt;</span>&#123;&#123; $page.title &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;&#123; else &#125;&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; $page.link &#125;&#125;"</span>&gt;</span>&#123;&#123; $page.title &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;&#123; end &#125;&#125;</span><br><span class="line">        &#123;&#123; end &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>sort</code> 関数に配列とパラメタ名を渡すと、そのパラメタでソートしてイテレーターに渡してくれます。<br>Hugo のテンプレートには結構リッチな組み込み関数が多いので面白いですね．<br>結構詰まったのがスコープです。<br><code>$baseUrl := .Site.BaseURL</code> のように <code>range</code> の外で変数に定義しないと、<code>range</code> の中で <code>.Site.BaseURL</code> を呼び出しても想定通り取得できません(もしかしたら別の方法があるかも)。</p>
<p>画像のスライダーには <a href="https://github.com/balaramadurai/hugo-travelify-theme" target="_blank" rel="noopener">balaramadurai/hugo-travelify-theme</a> のモノを拝借しました。<br>ただ、<a href="https://github.com/IGGG/new.iggg.org/blob/c9498f8d30c3ca441708c51493282b12727853e4/config.toml#L69-L82" target="_blank" rel="noopener">次</a>のように config からスライダーの画像を指定できるようにしています:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[params.slider]</span></span><br><span class="line">    enable = true</span><br><span class="line">    slides = [</span><br><span class="line">      "2014/05/DSC03469.jpg",</span><br><span class="line">      "2014/05/DSC08554_.jpg",</span><br><span class="line">      "2014/05/DSC07319.jpg",</span><br><span class="line">      "2014/05/2014-03-19-11.24.19.jpg",</span><br><span class="line">      "2014/05/DSC08222.jpg",</span><br><span class="line">      "2014/06/DSC09428.jpg",</span><br><span class="line">      "2014/06/DSC09437.jpg",</span><br><span class="line">      "2014/06/2014-06-23-17.05.10.jpg",</span><br><span class="line">      "2014/06/2014-06-25-21.20.40.jpg",</span><br><span class="line">      "2014/06/2014-06-28-17.54.04.jpg",</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>

<p>「最近の記事の更新」や「IGGGについての説明」は dopetrope のモノを使い、CSSで調整しています。<br>ちなみに、CSSを変更しても、うまく読み込まれず苦労しました(リロードしたり変更したり、結局正しいやり方は分からず)。<br>イベントボードは自作して、今まで同様に<a href="https://github.com/IGGG/new.iggg.org/blob/c9498f8d30c3ca441708c51493282b12727853e4/data/footer/content.yaml" target="_blank" rel="noopener">外から設定できるように</a>しています:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">sections:</span></span><br><span class="line"><span class="attr">- title:</span> <span class="string">"What's New"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- title:</span> <span class="string">'TWITTER'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- title:</span> <span class="string">'EVENTS'</span></span><br><span class="line"><span class="attr">  events:</span></span><br><span class="line"><span class="attr">  - title:</span> <span class="string">'IGGG ADVENT CALENDAR 2017'</span></span><br><span class="line"><span class="attr">    imagelink:</span> <span class="string">'https://adventar.org/calendars/2300'</span></span><br><span class="line"><span class="attr">    imageurl:</span> <span class="string">'/images/2017/11/igggAC2017.jpg'</span></span><br></pre></td></tr></table></figure>

<p>Twitter のタイムラインは<a href="https://publish.twitter.com" target="_blank" rel="noopener">ここ</a>で生成したモノをただ単純に埋め込んでいます。</p>
<h3 id="GitHub-Pages"><a href="#GitHub-Pages" class="headerlink" title="GitHub Pages"></a>GitHub Pages</h3><p>さて、ここまでくれば後は Public にするだけだ(ここまでは Private リポジトリにしてた)。<br>Settings で Public に変更し、GitHub Pages の設定を <code>docs</code> にしてオンする。<br>意気揚々と <code>iggg.github.io/new.iggg,org</code> にアクセスすると。。。。</p>
<p><img s1c="/images/replace-iggg-org/404-ghpages.png" alt></p>
<p>見れない！<br>あれ、なぜだ？？<br>答えはこれ:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/11577147/how-to-fix-page-404-on-github-page" target="_blank" rel="noopener">How to fix page 404 on Github Page? - Stack Overflow</a></li>
</ul>
<p>コミットしないと GitHub Pages の生成がされないらしい。<br>なので空コミットしたら無事表示された！</p>
<p><img s1c="/images/replace-iggg-org/new-iggg-org-home.png" alt></p>
<h2 id="残タスク"><a href="#残タスク" class="headerlink" title="残タスク"></a>残タスク</h2><ul>
<li>古いページは多分崩れてるので直さないと</li>
<li>DNS を iggg.org にする</li>
<li>コミットから自動生成する仕組み</li>
<li>プレビュー機能</li>
</ul>
<h2 id="おしまい"><a href="#おしまい" class="headerlink" title="おしまい"></a>おしまい</h2><p>Hugo 結構使いやすい。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web/">Web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/GitHub/">GitHub</a>, <a href="/tags/WordPress/">WordPress</a>, <a href="/tags/Hugo/">Hugo</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="CircleCIの設定ファイルを2.0に更新" style="display: none;">
    <div idplusp="CircleCIの設定ファイルを2.0に更新">
      <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2018-12-14T17:00:00.000Z"><a href="#">2018-12-15</a></time>
      
      
  
    <h1 class="depth title">CircleCI の設定ファイルを 2.0 に更新</h1>
  

    </header>
    <div class="entry depth">
      
        <p>IGGG ソフトウェア基盤部のひげです。<br>1年ぶりの更新です。</p>
<p>本記事は<a href="http://www.adventar.org/calendars/3217" target="_blank" rel="noopener">IGGG アドベントカレンダー 2018</a> 15日目の記事です。<br>まぁ今回はほとんど埋まっていませんが(笑)</p>
<p>本当は別の話を書こうと思っていたんだけど、記事を書くためにこのサイトを整備、というかほったらかしにいていた CircleCI 2.0 へのアップデートをしたら思いの外大変だったのでその過程を書きたいと思います。<br>まぁみんな既に 2.0 への更新は済んでそうですけどね。</p>
<h2 id="ここの構成"><a href="#ここの構成" class="headerlink" title="ここの構成"></a>ここの構成</h2><p>このサイトは CircleCI を使って自動デプロイなどを導入している:</p>
<ul>
<li><a href="https://iggg.github.io/2016/05/30/use-circle-ci/">GitHub Pages + Hexo + CircleCI + Heroku で自動デプロイ管理｜群馬大学電子計算機研究会 IGGG</a></li>
</ul>
<p><img s1c="/images/update-circleci-2/iggg-github-io.jpg" alt></p>
<p>実はこれ、 CircleCI 1.0 のままだった。<br>もう2年半近く前だからしょうがないね。<br>元々の設定はこんな感じ:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">machine:</span></span><br><span class="line"><span class="attr">  timezone:</span> <span class="string">Asia/Tokyo</span></span><br><span class="line"><span class="attr">  node:</span></span><br><span class="line"><span class="attr">    version:</span> <span class="number">4.4</span><span class="number">.5</span></span><br><span class="line"><span class="attr">deployment:</span></span><br><span class="line"><span class="attr">  production:</span></span><br><span class="line"><span class="attr">    branch:</span> <span class="string">source</span></span><br><span class="line"><span class="attr">    commands:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.name</span> <span class="string">"IGGGorg"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.email</span> <span class="string">"contact@iggg.org"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">submodule</span> <span class="string">init</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">submodule</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./node_modules/.bin/hexo</span> <span class="string">clean</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./node_modules/.bin/hexo</span> <span class="string">generate</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./node_modules/.bin/hexo</span> <span class="string">deploy</span></span><br><span class="line"><span class="attr">  staging:</span></span><br><span class="line"><span class="attr">    branch:</span> <span class="string">staging</span></span><br><span class="line"><span class="attr">    commands:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.name</span> <span class="string">"IGGGorg"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.email</span> <span class="string">"contcat@iggg.org"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./node_modules/.bin/hexo</span> <span class="string">clean</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./node_modules/.bin/hexo</span> <span class="string">generate</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./node_modules/.bin/hexo</span> <span class="string">deploy</span> <span class="bullet">--branch</span> <span class="string">$CIRCLE_BRANCH</span> <span class="bullet">--config</span> <span class="string">_staging_config.yml</span></span><br><span class="line"><span class="attr">general:</span></span><br><span class="line"><span class="attr">  branches:</span></span><br><span class="line"><span class="attr">    ignore:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<h2 id="更新作業"><a href="#更新作業" class="headerlink" title="更新作業"></a>更新作業</h2><p>ちなみに最終的にこんな感じ:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">defaults:</span> <span class="meta">&amp;defaults</span></span><br><span class="line"><span class="attr">  docker:</span></span><br><span class="line"><span class="attr">    - image:</span> <span class="string">circleci/node:11.4.0</span></span><br><span class="line"><span class="attr">      environment:</span></span><br><span class="line"><span class="attr">        TZ:</span> <span class="string">Asia/Tokyo</span></span><br><span class="line"><span class="attr">  working_directory:</span> <span class="string">~/work</span></span><br><span class="line"></span><br><span class="line"><span class="attr">version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line">    <span class="string">&lt;&lt;:</span> <span class="meta">*defaults</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">checkout</span></span><br><span class="line"><span class="attr">      - restore_cache:</span></span><br><span class="line"><span class="attr">          keys:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">v1-dependencies-&#123;&#123;</span> <span class="string">checksum</span> <span class="string">"package.json"</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="comment"># fallback to using the latest cache if no exact match is found</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">v1-dependencies-</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">node_modules/.bin/hexo</span> <span class="string">clean</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">node_modules/.bin/hexo</span> <span class="string">generate</span></span><br><span class="line"><span class="attr">      - save_cache:</span></span><br><span class="line"><span class="attr">          paths:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">node_modules</span></span><br><span class="line"><span class="attr">          key:</span> <span class="string">v1-dependencies-&#123;&#123;</span> <span class="string">checksum</span> <span class="string">"package.json"</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">      - persist_to_workspace:</span></span><br><span class="line"><span class="attr">          root:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">          paths:</span> <span class="string">[</span> <span class="string">'*'</span> <span class="string">]</span></span><br><span class="line"><span class="attr">  deploy-production:</span></span><br><span class="line">    <span class="string">&lt;&lt;:</span> <span class="meta">*defaults</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - attach_workspace:</span></span><br><span class="line"><span class="attr">          at:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">      - run:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">init</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            git config --global user.name "IGGGorg"</span></span><br><span class="line"><span class="string">            git config --global user.email "contact@iggg.org"</span></span><br><span class="line"><span class="string">            mkdir ~/.ssh/ &amp;&amp; echo -e "Host github.com\n\tStrictHostKeyChecking no\n" &gt; ~/.ssh/config</span></span><br><span class="line"><span class="string">            git submodule init</span></span><br><span class="line"><span class="string">            git submodule update</span></span><br><span class="line"><span class="string"></span><span class="attr">      - run:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">deploy</span> <span class="string">to</span> <span class="string">production</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">./node_modules/.bin/hexo</span> <span class="string">deploy</span></span><br><span class="line"><span class="attr">  deploy-staging:</span></span><br><span class="line">    <span class="string">&lt;&lt;:</span> <span class="meta">*defaults</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - attach_workspace:</span></span><br><span class="line"><span class="attr">          at:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">      - run:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">init</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            git config --global user.name "IGGGorg"</span></span><br><span class="line"><span class="string">            git config --global user.email "contact@iggg.org"</span></span><br><span class="line"><span class="string"></span><span class="attr">      - run:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">deploy</span> <span class="string">to</span> <span class="string">staging</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            mkdir .deploy</span></span><br><span class="line"><span class="string">            cd .deploy</span></span><br><span class="line"><span class="string">            git init</span></span><br><span class="line"><span class="string">            echo "&#123; \"root\": \"public/\" &#125;" &gt; static.json</span></span><br><span class="line"><span class="string">            git add -A</span></span><br><span class="line"><span class="string">            git commit -m "First commit"</span></span><br><span class="line"><span class="string">            cp -r ../public .</span></span><br><span class="line"><span class="string">            git add -A</span></span><br><span class="line"><span class="string">            git commit -m "Site updated"</span></span><br><span class="line"><span class="string">            git push -u https://heroku:$HEROKU_API_KEY@git.heroku.com/iggg-github-io-staging.git master -f</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span><span class="attr">workflows:</span></span><br><span class="line"><span class="attr">  version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  build-and-deploy:</span></span><br><span class="line"><span class="attr">    jobs:</span></span><br><span class="line"><span class="attr">      - build:</span></span><br><span class="line"><span class="attr">          filters:</span></span><br><span class="line"><span class="attr">            branches:</span></span><br><span class="line"><span class="attr">              ignore:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">      - deploy-production:</span></span><br><span class="line"><span class="attr">          requires:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">build</span></span><br><span class="line"><span class="attr">          filters:</span></span><br><span class="line"><span class="attr">            branches:</span></span><br><span class="line"><span class="attr">              only:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">source</span></span><br><span class="line"><span class="attr">      - deploy-staging:</span></span><br><span class="line"><span class="attr">          requires:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">build</span></span><br><span class="line"><span class="attr">          filters:</span></span><br><span class="line"><span class="attr">            branches:</span></span><br><span class="line"><span class="attr">              only:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">staging</span></span><br></pre></td></tr></table></figure>

<p>やっつけでやったからだいぶ余計な部分がありそう。</p>
<h3 id="CircleCI-2-0"><a href="#CircleCI-2-0" class="headerlink" title="CircleCI 2.0"></a>CircleCI 2.0</h3><p>旧バージョンである <a href="https://circleci.com/blog/sunsetting-1-0/" target="_blank" rel="noopener">CircleCI 1.0 は2018年8月31日に終了</a>し、以降は 2.0 でしか CI を回せなくなった（このサイトは2017年3月以降回していない笑）。</p>
<p>変更の仕方はそこまで難しくない。<br>下記の公式ドキュメントにしたがって変更して行けば良い:</p>
<ul>
<li><a href="https://circleci.com/docs/2.0/migrating-from-1-2/" target="_blank" rel="noopener">Migrating a Linux Project from 1.0 to 2.0 - CircleCI</a></li>
</ul>
<p>手順をざっくりと抜粋すると:</p>
<ol>
<li><code>/circle.yml</code> を <code>/.circleci/config.yml</code> に置換</li>
<li><code>version: 2</code> を冒頭に追加</li>
<li><code>deployment</code> は <code>jobs</code> に変更:<ul>
<li><code>commands</code> は <code>steps</code> にする</li>
<li><code>commands</code> のリストの要素は <code>run:</code> にする</li>
</ul>
</li>
<li><code>machine</code> 以下の設定を <code>docker</code> にして <code>jobs</code> に書き加える</li>
<li>適当に <code>workflows</code> を定義<ul>
<li><code>branch</code> の設定はこっちでする</li>
</ul>
</li>
</ol>
<p>あとは <code>checkout</code> やキャッシュ回りの設定、job 間でワークスペースを共有するために <code>persist_to_workspace</code> と <code>attach_workspace</code> を追記した。</p>
<h3 id="Hexo-の更新"><a href="#Hexo-の更新" class="headerlink" title="Hexo の更新"></a>Hexo の更新</h3><p>Node が古すぎて CircleCI の Docker イメージがなかった:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Build-agent version 0.1.1250-22bf9f5d (2018-12-12T11:32:15+0000)</span><br><span class="line">Starting container circleci/node:4.4.5</span><br><span class="line">  image cache not found on this host, downloading circleci/node:4.4.5</span><br><span class="line"></span><br><span class="line">Error response from daemon: manifest for circleci/node:4.4.5 not found</span><br></pre></td></tr></table></figure>

<p>ので、随分古い Node と Hexo を使っていたので更新した。</p>
<ul>
<li>Node: 4.4.5 -&gt; 11.4.0</li>
<li>Hexo: 3.3.5 -&gt; 3.8.0</li>
</ul>
<p>ここは特に問題なく動作した（たぶん）。</p>
<h3 id="Heroku-と-CircleCI"><a href="#Heroku-と-CircleCI" class="headerlink" title="Heroku と CircleCI"></a>Heroku と CircleCI</h3><p>ここからがしんどい。。。</p>
<p>上の手順で適当に書き換えても動かなかった。<br>何がかというと、最終的なデプロイの部分だ。<br>まずは Staging である Heroku の部分。<br>CircleCI でデプロイしてみたら:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create mode 100644 public/tags/Twitter/index.html</span><br><span class="line">create mode 100644 public/tags/guntohfes/index.html</span><br><span class="line">The authenticity of host &apos;heroku.com (50.19.85.156)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is SHA256:XXX/o.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? Step was canceled</span><br></pre></td></tr></table></figure>

<p>という状態で固まってしまった。<br>いろいろ調べてみたら、そもそも過去に設定したやり方はもう古いみたいだ（本当に？）。<br>なので <a href="https://circleci.com/docs/2.0/deployment-integrations/#heroku" target="_blank" rel="noopener">2.0 の資料</a>を参考にし <code>HEROKU_API_KEY</code> を使った方法にしようと思う。</p>
<p>Hexo の Heroku へのデプロイには <a href="https://github.com/hexojs/hexo-deployer-heroku" target="_blank" rel="noopener">hexo-deployer-heroku</a> というライブラリを使っている。<br>このライブラリで <code>HEROKU_API_KEY</code> 環境変数を埋め込むのは難しそうなので、hexo-deployer-heroku のコードを読んで同様の手順を CI で直接実行するようにした:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir .deploy</span><br><span class="line"><span class="built_in">cd</span> .deploy</span><br><span class="line">git init</span><br><span class="line">cp -r ../public .</span><br><span class="line">git add -A</span><br><span class="line">git commit -m <span class="string">"Site updated"</span></span><br><span class="line">git push -u https://heroku:<span class="variable">$HEROKU_API_KEY</span>@git.heroku.com/iggg-github-io-staging.git master -f</span><br></pre></td></tr></table></figure>

<p>しかし、次のようなエラーが出た:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">Writing objects: 100% (171/171), 4.58 MiB | 8.98 MiB/s, done.</span><br><span class="line">Total 171 (delta 33), reused 0 (delta 0)</span><br><span class="line">remote: Compressing source files... done.        </span><br><span class="line">remote: Building source:        </span><br><span class="line">remote:</span><br><span class="line">remote: -----&gt; App not compatible with buildpack: https://buildpack-registry.s3.amazonaws.com/buildpacks/heroku/php.tgz        </span><br><span class="line">remote:                </span><br><span class="line">remote:  !     ERROR: Application not supported by this buildpack!        </span><br><span class="line">remote:  !             </span><br><span class="line">remote:  !     The &apos;heroku/php&apos; buildpack is set on this application, but was        </span><br><span class="line">remote:  !     unable to detect a PHP codebase.        </span><br><span class="line">remote:  !             </span><br><span class="line">remote:  !     A PHP app on Heroku requires a &apos;composer.json&apos; at the root of        </span><br><span class="line">remote:  !     the directory structure, or an &apos;index.php&apos; for legacy behavior.        </span><br><span class="line">remote:  !             </span><br><span class="line">remote:  !     If you are trying to deploy a PHP application, ensure that one        </span><br><span class="line">remote:  !     of these files is present at the top level directory.        </span><br><span class="line">remote:  !             </span><br><span class="line">remote:  !     If you are trying to deploy an application written in another        </span><br><span class="line">remote:  !     language, you need to change the list of buildpacks set on your        </span><br><span class="line">remote:  !     Heroku app using the &apos;heroku buildpacks&apos; command.        </span><br><span class="line">remote:  !             </span><br><span class="line">remote:  !     For more information, refer to the following documentation:        </span><br><span class="line">remote:  !     https://devcenter.heroku.com/articles/buildpacks        </span><br><span class="line">remote:  !     https://devcenter.heroku.com/articles/php-support#activation</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>git push</code> のところで起きている。<br>buildpack に <code>heroku/php</code> を指定しているが、この場合はワークスペースに <code>index.php</code> などがないとダメらしい。<br>hexo-deployer-heroku ではこの <a href="https://github.com/hexojs/hexo-deployer-heroku/tree/08f9fb7feab9a71e983ff0b5a05b6f1183a398f1/assets" target="_blank" rel="noopener">assets</a> の中身をコピーして <code>heroku/php</code> に合わせていた。<br>同じようにしてもいいが、別に PHP ではないので静的サイト用の buildpack に変更するようにした:</p>
<ul>
<li><a href="https://github.com/heroku/heroku-buildpack-static" target="_blank" rel="noopener">heroku/heroku-buildpack-static - GitHub</a></li>
</ul>
<p>heroku-buildpack-static の設定ファイルとして <code>static.json</code> をワークスペースに置く必要がある。<br>なので、下記のコマンドを <code>git init</code> と <code>cp -r ../public .</code> の間で実行する:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"&#123; \"root\": \"public/\" &#125;"</span> &gt; static.json</span><br><span class="line">git add -A</span><br><span class="line">git commit -m <span class="string">"First commit"</span></span><br></pre></td></tr></table></figure>

<p>これで無事 Heroku にデプロイできた！</p>
<h3 id="GitHub-と-CircleCI"><a href="#GitHub-と-CircleCI" class="headerlink" title="GitHub と CircleCI"></a>GitHub と CircleCI</h3><p>こっちも案の定ダメだった。<br>Heroku の時と同様に <code>yes/no</code> と聞かれて止まってしまう。<br>GitHub へのデプロイには <a href="https://github.com/hexojs/hexo-deployer-git" target="_blank" rel="noopener">hexojs/hexo-deployer-git</a> を使っている。<br>Heroku の時みたいに同様の動作を直接書き込んでもいいが、できれば API トークンを使いたくないので、別の方法を調べた。<br>良さそうな CircleCI の質問ページがあった:</p>
<ul>
<li><a href="https://discuss.circleci.com/t/git-clone-fails-in-circle-2-0/15211/10" target="_blank" rel="noopener">Git clone fails in Circle 2.0 - Build Environment - CircleCI Community Discussion</a></li>
</ul>
<p>次のようなのをデプロイする前に書けばいいらしい:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir ~/.ssh/ &amp;&amp; <span class="built_in">echo</span> -e <span class="string">"Host github.com\n\tStrictHostKeyChecking no\n"</span> &gt; ~/.ssh/config</span><br></pre></td></tr></table></figure>

<p>エラーが変わった:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">create mode 100644 tags/guntohfes/index.html</span><br><span class="line">Warning: Permanently added &apos;github.com,192.30.253.112&apos; (RSA) to the list of known hosts.</span><br><span class="line"></span><br><span class="line">ERROR: The key you are authenticating with has been marked as read only.</span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br><span class="line">FATAL Something&apos;s wrong. Maybe you can find the solution here: http://hexo.io/docs/troubleshooting.html</span><br><span class="line">Error: Warning: Permanently added &apos;github.com,192.30.253.112&apos; (RSA) to the list of known hosts.</span><br><span class="line"></span><br><span class="line">ERROR: The key you are authenticating with has been marked as read only.</span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br><span class="line"></span><br><span class="line">   at ChildProcess.&lt;anonymous&gt; (/home/circleci/work/node_modules/hexo-util/lib/spawn.js:37:17)</span><br><span class="line">   at ChildProcess.emit (events.js:189:13)</span><br><span class="line">   at maybeClose (internal/child_process.js:978:16)</span><br><span class="line">   at Socket.stream.socket.on (internal/child_process.js:395:11)</span><br><span class="line">   at Socket.emit (events.js:189:13)</span><br><span class="line">   at Pipe._handle.close (net.js:613:12)</span><br><span class="line">Exited with code 2</span><br></pre></td></tr></table></figure>

<p>これは設定している GitHub の SSH 鍵に書き込み権限が無いせいだ。<br>読み込みだけのやつはコンソールからボタン一つでできたが、書き込み権限付きの鍵は自分で作る必要がある。<br>以下の記事がわかりやすかった（似たような記事はたくさんあると思うけど）:</p>
<ul>
<li><a href="https://qiita.com/boushi-bird/items/6b6eb1d1ed6f6d3341e4" target="_blank" rel="noopener">ircle CI で Github に write access 可能な Deploy key を設定する - Qiita</a></li>
</ul>
<p>これで無事本番にもデプロイできた！</p>
<h2 id="残り作業"><a href="#残り作業" class="headerlink" title="残り作業"></a>残り作業</h2><p>README とか Docker のところとかもほんとは整備しなきゃ。。。</p>
<h2 id="おしまい"><a href="#おしまい" class="headerlink" title="おしまい"></a>おしまい</h2><p>更新は計画的に。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web/">Web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Heroku/">Heroku</a>, <a href="/tags/GitHub/">GitHub</a>, <a href="/tags/CircleCI/">CircleCI</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="Slackから特定のアカウントでツイートするBotを作った" style="display: none;">
    <div idplusp="Slackから特定のアカウントでツイートするBotを作った">
      <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2017-06-01T14:29:36.000Z"><a href="#">2017-06-01</a></time>
      
      
  
    <h1 class="depth title">Slack から特定のアカウントでツイートする Bot を作った</h1>
  

    </header>
    <div class="entry depth">
      
        <p>IGGG ソフトウェア基盤部のひげです。</p>
<p>Slack をインターフェースにして特定の Twitter アカウントでツイートする Slack Bot を GAS で作った話。<br>なんか Bot ばっかり作ってる気がする。</p>
<h2 id="いきさつ"><a href="#いきさつ" class="headerlink" title="いきさつ"></a>いきさつ</h2><p>IGGG は部としての活動はあまりなく、個人での活動が多い(ちなみに、それを支援する部になればなぁと思ってます。)。<br>いっけん何もしてないように見えるが、各々で何かしてる場合があるので、それをもっと広報してみようという話が、この前の Meetup のときにあった。</p>
<p>そこで、個人の活動を PR するための <a href="https://twitter.com/IGGGorg_PR" target="_blank" rel="noopener">Twitter アカウント</a>を作って、活動、例えば、各々のWebサイトの更新や GitHub リポジトリの更新などをツイートしようとなった。</p>
<p>ただ、いちいちログインしてツイートするのはめんどくさい。<br>ということで、Slack の特定のチャンネルで発言すると、それを本文としてツイートできるようにすることにした。</p>
<h2 id="作る"><a href="#作る" class="headerlink" title="作る"></a>作る</h2><p>ステップバイステップに作ったので、せっかくだから、その過程を書いておく。<br>最終的な GAS コードは<a href="https://github.com/IGGG/google-apps-scripts/blob/announcer/announcer/Announcer.gs" target="_blank" rel="noopener">ココ</a>にある。<br>いくつかのプロパティの他に、以下の外部ライブラリを使用した。</p>
<ul>
<li><a href="https://github.com/soundTricker/SlackApp" target="_blank" rel="noopener">SlackApp</a> : <code>M3W5Ut3Q39AaIwLquryEPMwV62A3znfOO</code></li>
<li><a href="https://github.com/googlesamples/apps-script-oauth1" target="_blank" rel="noopener">OAuth1</a> : <code>1CXDCY5sqT9ph64fFwSzVtXnbjpSfWdRymafDrtIZ7Z_hwysTY7IIhi7s</code></li>
<li><a href="https://github.com/simula-innovation/gas-underscore" target="_blank" rel="noopener">Underscore</a> : <code>M3i7wmUA_5n0NSEaa6NnNqOBao7QLBR4j</code></li>
</ul>
<h3 id="1-とりあえずそのままツイート"><a href="#1-とりあえずそのままツイート" class="headerlink" title="1. とりあえずそのままツイート"></a>1. とりあえずそのままツイート</h3><p>まずは何も考えずにそのままツイートしてくれる Slack Bot を作る。<br>GAS なので、<a href="https://iggg.slack.com/apps/A0F7VRG6Q-outgoing-webhooks" target="_blank" rel="noopener">Outgoing Webhook</a> を使う。<br>Bot の名前を <code>announcer</code> にするということにして(Customize Name をいじるわけではない、いじってもいいけど)，<code>@announcer</code> を Trigger Word(s) に設定する。</p>
<p>イメージはこんな感じ</p>
<p><img s1c="/images/make-tweet-slack-bot/image.jpg" alt></p>
<p>と打つと、Twitterで「こんにちは、テスト !!」をつぶやいてくれる。</p>
<ul>
<li><a href="https://ameblo.jp/ponkotsuameba/entry-12206865120.html" target="_blank" rel="noopener">Google Apps ScriptからTwitterに投稿する。｜ポンコツプログラマの開発日記</a></li>
</ul>
<p>を参考にして作った。</p>
<h4 id="1-1-Twitter-API-Token-の取得"><a href="#1-1-Twitter-API-Token-の取得" class="headerlink" title="1-1. Twitter API Token の取得"></a>1-1. Twitter API Token の取得</h4><p>Twitter API を叩くために必要。<br>電話番号が登録されているアカウントでないとダメなので、自分のツイッターアカウントで発行した(ちなみに、こういう開発での用途か ROM 専でしか使ってない、ぼくは)。<br>発行の手順は簡単</p>
<ol>
<li>Twitter にログイン</li>
<li><a href="https://dev.twitter.com/docs" target="_blank" rel="noopener">https://dev.twitter.com/docs</a> にアクセスして上の方にある <code>My apps</code> をクリック</li>
<li><code>Create New App</code> をクリックして必要事項を埋める<ul>
<li><code>Name</code>, <code>Description</code>, <code>Website</code> を埋める必要があるが、正直なんでもいい</li>
<li>アプリで重要なのは <code>Callback URL</code> だが、まだ埋めなくても平気</li>
</ul>
</li>
<li><code>Keys and Access Tokens</code> というタブをクリックすると、そこに必要なトークンがある</li>
</ol>
<p><img s1c="/images/make-tweet-slack-bot/slack_api_keys.jpg" alt></p>
<h4 id="1-2-Bot-を書く！"><a href="#1-2-Bot-を書く！" class="headerlink" title="1-2. Bot を書く！"></a>1-2. Bot を書く！</h4><p><a href="https://github.com/googlesamples/apps-script-oauth1/blob/master/samples/Twitter.gs" target="_blank" rel="noopener">サンプルコード</a>を参考にして、ソースコードはこんな感じ。</p>
<p>ちなみに、プロパティは以下のようになっている</p>
<ul>
<li><code>VERIFY_TOKEN</code>: Outgoing Webhook Slack App の <code>Token</code></li>
<li><code>SLACK_API_TOKEN</code>: <a href="https://api.slack.com/custom-integrations/legacy-tokens" target="_blank" rel="noopener">ココ</a>から発行できる Slack の API トークン</li>
<li><code>ICON_ID</code>: Google Drive にある Slack Bot のアイコンに使う画像の ID (別に無くてもいいし、URL を使うように書き換えたって良い)</li>
<li><code>TWITTER_CONSUMER_KEY</code>: 1-1 で用意した Consumer Key (API Key)</li>
<li><code>TWITTER_CONSUMER_SECRET</code>: 1-1 で用意した Consumer Secret (API Secret)</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doPost</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> prop = PropertiesService.getScriptProperties().getProperties();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prop.VERIFY_TOKEN != e.parameter.token) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'invalid token.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* for Slack */</span></span><br><span class="line">  <span class="keyword">var</span> slackApp = SlackApp.create(prop.SLACK_API_TOKEN);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> BOT_NAME = <span class="string">'announcer'</span>;</span><br><span class="line">  <span class="keyword">const</span> BOT_ICON = <span class="string">'http://drive.google.com/uc?export=view&amp;id='</span> + prop.ICON_ID;</span><br><span class="line">  <span class="keyword">var</span> option = &#123; <span class="attr">username</span> : BOT_NAME, <span class="attr">icon_url</span> : BOT_ICON, <span class="attr">link_names</span> : <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> message = e.parameter.text.split(<span class="string">'\n'</span>);</span><br><span class="line">  <span class="keyword">var</span> channelName = e.parameter.channel_name;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (message[<span class="number">0</span>] != (<span class="string">'@'</span> + BOT_NAME)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'invalid bot name.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> result = postTweet(message.slice(<span class="number">1</span>, message.length).join(<span class="string">'\n'</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> text = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">if</span> (result != <span class="string">'error'</span>) &#123;</span><br><span class="line">    text = <span class="string">'Success!\n'</span> + <span class="string">'https://twitter.com/IGGGorg_PR/status/'</span> + result[<span class="string">'id_str'</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    text = <span class="string">'Denied...'</span></span><br><span class="line">  &#125;</span><br><span class="line">  Logger.log(slackApp.postMessage(channelName, text, option));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Authorizes and makes a request to the Twitter API.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postTweet</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> service = getService();</span><br><span class="line">  <span class="keyword">if</span> (service.hasAccess()) &#123;</span><br><span class="line">    <span class="keyword">var</span> url = <span class="string">'https://api.twitter.com/1.1/statuses/update.json'</span>;</span><br><span class="line">    <span class="keyword">var</span> payload = &#123;</span><br><span class="line">      status: text</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> response = service.fetch(url, &#123;</span><br><span class="line">      method: <span class="string">'post'</span>,</span><br><span class="line">      payload: payload</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> result = <span class="built_in">JSON</span>.parse(response.getContentText());</span><br><span class="line">    Logger.log(<span class="built_in">JSON</span>.stringify(result, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> authorizationUrl = service.authorize();</span><br><span class="line">    Logger.log(<span class="string">'Open the following URL and re-run the script: %s'</span>,</span><br><span class="line">        authorizationUrl);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'error'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reset the authorization state, so that it can be re-tested.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reset</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> service = getService();</span><br><span class="line">  service.reset();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Configures the service.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getService</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> prop = PropertiesService.getScriptProperties().getProperties();  </span><br><span class="line">  <span class="keyword">return</span> OAuth1.createService(<span class="string">'Twitter'</span>)</span><br><span class="line">      <span class="comment">// Set the endpoint URLs.</span></span><br><span class="line">      .setAccessTokenUrl(<span class="string">'https://api.twitter.com/oauth/access_token'</span>)</span><br><span class="line">      .setRequestTokenUrl(<span class="string">'https://api.twitter.com/oauth/request_token'</span>)</span><br><span class="line">      .setAuthorizationUrl(<span class="string">'https://api.twitter.com/oauth/authorize'</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Set the consumer key and secret.</span></span><br><span class="line">      .setConsumerKey(prop.TWITTER_CONSUMER_KEY)</span><br><span class="line">      .setConsumerSecret(prop.TWITTER_CONSUMER_SECRET)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Set the name of the callback function in the script referenced</span></span><br><span class="line">      <span class="comment">// above that should be invoked to complete the OAuth flow.</span></span><br><span class="line">      .setCallbackFunction(<span class="string">'authCallback'</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Set the property store where authorized tokens should be persisted.</span></span><br><span class="line">      .setPropertyStore(PropertiesService.getUserProperties());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handles the OAuth callback.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">authCallback</span>(<span class="params">request</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> service = getService();</span><br><span class="line">  <span class="keyword">var</span> authorized = service.handleCallback(request);</span><br><span class="line">  <span class="keyword">if</span> (authorized) &#123;</span><br><span class="line">    <span class="keyword">return</span> HtmlService.createHtmlOutput(<span class="string">'Success!'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> HtmlService.createHtmlOutput(<span class="string">'Denied'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>reset</code>, <code>getService</code>, <code>authCallback</code> 関数はサンプルコードをそのまんま、 <code>postTweet</code> 関数はサンプルコードの <code>run</code> 関数を返り値があるように書き換えたモノだ。</p>
<p>次に、<a href="https://apps.twitter.com" target="_blank" rel="noopener">Twitter側</a>に <code>https://script.google.com/macros/d/{SCRIPT_ID}/usercallback</code> を Setting からの Callback URL に書き込む。<br>ここでの <code>SCRIPT_ID</code> は <code>ファイル</code> の <code>プロジェクトのプロパティ</code> にある <code>スクリプト ID</code> に書いてある文字列である(URLからも実はわかる)。</p>
<p>できたら、いちど <code>postTweet</code> 関数を GAS 側で実行すると、<strong>現在ログインしている Twitter アカウント</strong> でのアプリケーション連携の認証ページへ飛ばされるので許可すればよい。</p>
<p>そして最後に、GAS側の <code>公開</code> の <code>ウェブアプリケーションとして導入</code> に書いてある URL を Outgoing Webhook の URL(s) にコピペすれば Slack 側とも繫がることができる。</p>
<h4 id="1-3-ためしに実行"><a href="#1-3-ためしに実行" class="headerlink" title="1-3. ためしに実行"></a>1-3. ためしに実行</h4><p>こんな感じ</p>
<p><img s1c="/images/make-tweet-slack-bot/test1.jpg" alt></p>
<h3 id="2-適当にフィルタリング"><a href="#2-適当にフィルタリング" class="headerlink" title="2. 適当にフィルタリング"></a>2. 適当にフィルタリング</h3><p>なんでもかんでもツイートされては困るので、<code>http</code> ってキーワードとかでフィルターを掛けてみてはどうか、という話があったので、簡単にかけてみた。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doPost</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> prop = PropertiesService.getScriptProperties().getProperties();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 同じなので割愛 */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (message[<span class="number">0</span>] != (<span class="string">'@'</span> + BOT_NAME)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'invalid bot name.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> text = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> messageBody = message.slice(<span class="number">1</span>, message.length).join(<span class="string">'\n'</span>);</span><br><span class="line">  <span class="keyword">if</span> (messageBody.indexOf(<span class="string">'http'</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">    text = <span class="string">'Denied: do not include "http".'</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result = tweet(messageBody);</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="string">'error'</span>) &#123;</span><br><span class="line">      text = <span class="string">'Success!\n'</span> + <span class="string">'https://twitter.com/IGGGorg_PR/status/'</span> + result[<span class="string">'id_str'</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      text = <span class="string">'Denied...'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Logger.log(slackApp.postMessage(channelName, text, option));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GAS の JavaScript は古いため、文字列が任意の文字列を含むかどうかを <code>indexOf</code> メソッドで調べるしかないらしい。<br>雑な実装ですね…</p>
<h3 id="3-Tweet-Request-TR-によるレビュー"><a href="#3-Tweet-Request-TR-によるレビュー" class="headerlink" title="3. Tweet Request (TR) によるレビュー"></a>3. Tweet Request (TR) によるレビュー</h3><p>どう考えてもガバガバフィルターだなぁと思ってるところに神からのお告げが来た。</p>
<p><img s1c="/images/make-tweet-slack-bot/otsuge_from_kami.jpg" alt></p>
<p><a href="https://api.slack.com/rtm" target="_blank" rel="noopener">Real Time Messaging API</a> であれば何でも取得できるので実装できそうだったが、GAS では RTM は使えない…orz</p>
<p>だがしかし、Add Reaction をフックして投稿することはできないけど、</p>
<ol>
<li>PR を作るように Tweet Request を作成するメッセージを打つ</li>
<li>TR に LGTM な Add Reaction をする</li>
<li>PR をマージするみたいに TR を許可(ツイート)する用のメッセージを打つ<ul>
<li>但し、Add Reaction が少ないとツイートできない</li>
</ul>
</li>
</ol>
<p>って感じに、リクエストの作成とツイートをポストするのを PR みたいに分ければできそうだ！<br>Add Reaction の取得自体は RTM じゃなくても、<a href="https://api.slack.com/web" target="_blank" rel="noopener">Slack の REST API</a> の <a href="https://api.slack.com/methods/reactions.get" target="_blank" rel="noopener"><code>reactions.get</code></a> を使えばできる。</p>
<p>TR の管理にはスプレッドシートを使う(GitHub の Issue でもいい気はするけど)。<br>なので、スプレッドシート用に以下のプロパティを追加した。</p>
<ul>
<li><code>SPREAD_SHEET_ID</code>: TRを管理するためのスプレッドシートのID</li>
<li><code>SHEET_NAME</code>: TRを管理するためのスプレッドシートのシート名</li>
</ul>
<h4 id="コード書き直す"><a href="#コード書き直す" class="headerlink" title="コード書き直す"></a>コード書き直す</h4><p>ソースコードはこんな感じになった(無駄に長い気もする)</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doPost</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> prop = PropertiesService.getScriptProperties().getProperties();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prop.VERIFY_TOKEN != e.parameter.token) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'invalid token.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Load Spread Sheet */</span></span><br><span class="line">  <span class="keyword">var</span> sheet = SpreadsheetApp.openById(prop.SPREAD_SHEET_ID).getSheetByName(prop.SHEET_NAME);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* for Slack */</span></span><br><span class="line">  <span class="keyword">var</span> slackApp = SlackApp.create(prop.SLACK_API_TOKEN);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> BOT_NAME = <span class="string">'announcer'</span>;</span><br><span class="line">  <span class="keyword">const</span> BOT_ICON = <span class="string">'http://drive.google.com/uc?export=view&amp;id='</span> + prop.ICON_ID;</span><br><span class="line">  <span class="keyword">var</span> option = &#123; <span class="attr">username</span> : BOT_NAME, <span class="attr">icon_url</span> : BOT_ICON, <span class="attr">link_names</span> : <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> body = e.parameter.text.slice(e.parameter.trigger_word.length).trim();</span><br><span class="line">  <span class="keyword">var</span> timestamp = e.parameter.timestamp;</span><br><span class="line">  <span class="keyword">var</span> channelId = e.parameter.channel_id;</span><br><span class="line">  <span class="keyword">var</span> text = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> _ = Underscore.load();</span><br><span class="line">  <span class="keyword">switch</span> (e.parameter.trigger_word) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'$tweet?'</span>:</span><br><span class="line">      <span class="keyword">const</span> rowNum = sheet.getLastRow() + <span class="number">1</span>;</span><br><span class="line">      setTweetRequest(sheet, _.extend(e.parameter, &#123;<span class="attr">body</span>: body, <span class="attr">num</span>: rowNum&#125;));</span><br><span class="line">      text = <span class="string">'set tweet request: '</span> + rowNum;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'$tweet!'</span>:</span><br><span class="line">      <span class="keyword">var</span> tr = getTweetRequest(sheet, body);</span><br><span class="line">      <span class="keyword">if</span> (tr.ok) &#123;</span><br><span class="line">        <span class="keyword">var</span> result = tweetWithCheck(tr, prop.SLACK_API_TOKEN);</span><br><span class="line">        <span class="keyword">if</span> (result.ok)</span><br><span class="line">          sheet.getRange(tr.num, <span class="number">4</span>).setValue(<span class="number">1</span>);</span><br><span class="line">        text = result.text;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        text = tr.error;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      text = <span class="string">'undefined trigger word: '</span> + e.parameter.trigger_word;</span><br><span class="line">  &#125;</span><br><span class="line">  Logger.log(slackApp.postMessage(channelId, text, option));</span><br><span class="line"><span class="comment">//  Logger.log(text);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTweetRequest</span>(<span class="params">sheet, rowNum</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">isNaN</span>(rowNum)) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">error</span>: <span class="string">'please input number: '</span> + rowNum &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> body = sheet.getRange(rowNum, <span class="number">1</span>).getValue();</span><br><span class="line">  <span class="keyword">if</span> (body == <span class="string">''</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">error</span>: <span class="string">'not found tweet request: '</span> + rowNum &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ok: <span class="literal">true</span>,</span><br><span class="line">    body: body,</span><br><span class="line">    channel_id: sheet.getRange(rowNum, <span class="number">2</span>).getValue(),</span><br><span class="line">    timestamp: sheet.getRange(rowNum, <span class="number">3</span>).getValue().slice(<span class="number">1</span>),</span><br><span class="line">    num: rowNum,</span><br><span class="line">    done: sheet.getRange(rowNum, <span class="number">4</span>).getValue() == <span class="number">1</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setTweetRequest</span>(<span class="params">sheet, tr</span>) </span>&#123;</span><br><span class="line">  sheet.getRange(tr.num, <span class="number">1</span>).setValue(tr.body);</span><br><span class="line">  sheet.getRange(tr.num, <span class="number">2</span>).setValue(tr.channel_id);</span><br><span class="line">  sheet.getRange(tr.num, <span class="number">3</span>).setValue(<span class="string">'t'</span> + tr.timestamp);  </span><br><span class="line">  sheet.getRange(tr.num, <span class="number">4</span>).setValue(tr.done ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tweetWithCheck</span>(<span class="params">tr, token</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (tr.done) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">text</span>: <span class="string">'TR '</span> + tr.num + <span class="string">' has already been tweeted.'</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> url = <span class="string">'https://slack.com/api/reactions.get'</span>;</span><br><span class="line">  <span class="keyword">var</span> options = &#123;</span><br><span class="line">    method: <span class="string">'post'</span>,</span><br><span class="line">    payload: &#123;</span><br><span class="line">      token: token,</span><br><span class="line">      channel: tr.channel_id,</span><br><span class="line">      timestamp: tr.timestamp</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">var</span> result = <span class="built_in">JSON</span>.parse(UrlFetchApp.fetch(url, options));</span><br><span class="line">  <span class="keyword">if</span> (!result.ok) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">text</span>: <span class="string">'error: '</span> + result.error &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> borderline = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">var</span> lgtm = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> result.message.reactions) &#123;</span><br><span class="line">    <span class="keyword">var</span> reaction = result.message.reactions[i];</span><br><span class="line">    <span class="keyword">if</span> (reaction.name == <span class="string">'+1'</span>) &#123;</span><br><span class="line">      lgtm = reaction.count;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> emassage = <span class="string">'Few :+1: for tweet req: need '</span> + borderline + <span class="string">', now '</span> + lgtm;</span><br><span class="line">  <span class="keyword">return</span> lgtm &gt;= borderline ? tweet(tr) : &#123; <span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">text</span>: emassage &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tweet</span>(<span class="params">body</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result = postTweet(body);</span><br><span class="line"><span class="comment">//  var result = &#123; id_str: 'tweet!!' &#125;;</span></span><br><span class="line">  <span class="keyword">if</span> (result == <span class="string">'error'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">text</span>: <span class="string">'Denied...'</span> &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.errors != <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">text</span>: <span class="string">'Denied: '</span> + result.errors[<span class="number">0</span>].code + <span class="string">' '</span> + result.errors[<span class="number">0</span>].message &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">ok</span>: <span class="literal">true</span>, <span class="attr">text</span>: <span class="string">'Success!\n'</span> + <span class="string">'https://twitter.com/IGGGorg_PR/status/'</span> + result[<span class="string">'id_str'</span>] &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>あんまりスプレッドシートのオブジェクトを伝搬させたくなくて、奇妙な返り値になっている。<br>まぁとりあえずはこれで良しとします…</p>
<p><a href="https://twitter.com/gion_U" target="_blank" rel="noopener">CTO</a> の助言のもと、TRの作成とTRのツイートのコマンドを <code>$tweet?</code> と <code>$tweet!</code> にした。</p>
<p>スプレッドシートのカラムは、<code>ツイートしたい本文, チャンネルID, タイムスタンプ, ツイート済みかのフラグ</code> となっている。<br><code>reactions.get</code> を使って特定のメッセージの Add Reaction を取得するには、メッセージを特定するために、チャンネルIDとタイムスタンプが必要だ(<strong>チャンネル名ではダメ</strong>)。</p>
<p>ちなみに、チャンネル名からチャンネルIDを調べるには、<a href="https://api.slack.com/methods/channels.list/test" target="_blank" rel="noopener">ココ</a> を使うのが良い<a href="http://qiita.com/Yinaura/items/bd28c7b9ef614696fb7e" target="_blank" rel="noopener">みたい</a>。<br>また、タイムスタンプはメッセージの時刻を右クリックして取得できる URL、例えば <code>https://iggg.slack.com/archives/C06FXCF4K/p1496313613432037</code> の <code>1496313613432037</code> を <code>1496313613.432037</code> のように前から10-11番目の数字の間に <code>.</code> を入れるだけで良い。<br>まぁ実際は Slack から飛んできたメッセージの情報に載ってるので、わざわざ手作業で集める必要はないんだけど、テストしたいときとかに使った。</p>
<p>Slack API を便利に使う GAS ライブラリでは <code>reactions.get</code> を実行でき無さそうだったので、<code>UrlFetchApp.fetch</code> を以下のように直接使った。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> url = <span class="string">'https://slack.com/api/reactions.get'</span>;</span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">  method: <span class="string">'post'</span>,</span><br><span class="line">  payload: &#123;</span><br><span class="line">    token: token,</span><br><span class="line">    channel: tr.channel_id,</span><br><span class="line">    timestamp: tr.timestamp</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> result = <span class="built_in">JSON</span>.parse(UrlFetchApp.fetch(url, options));</span><br></pre></td></tr></table></figure>

<h2 id="実行"><a href="#実行" class="headerlink" title="実行"></a>実行</h2><p>いい感じ b</p>
<p><img s1c="/images/make-tweet-slack-bot/test3.jpg" alt></p>
<h2 id="おしまい"><a href="#おしまい" class="headerlink" title="おしまい"></a>おしまい</h2><p>みんなツイートしてくれるといいなぁ。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web/">Web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Slack/">Slack</a>, <a href="/tags/Bot/">Bot</a>, <a href="/tags/Google-Apps-Script/">Google Apps Script</a>, <a href="/tags/Twitter/">Twitter</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="SlackとGASとGitHubを使って部内の問題・情報管理を円滑にしたい話" style="display: none;">
    <div idplusp="SlackとGASとGitHubを使って部内の問題・情報管理を円滑にしたい話">
      <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      
        <img s1c="/images/make-manager-bot-for-slack/flow.jpg">
      
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2017-05-16T15:29:36.000Z"><a href="#">2017-05-17</a></time>
      
      
  
    <h1 class="depth title">Slack と GAS と GitHub を使って部内の問題・情報管理を円滑にしたい話</h1>
  

    </header>
    <div class="entry depth">
      
        <p>IGGG ソフトウェア基盤部のひげです。</p>
<p>特定の GitHub リポジトリの任意の Issue を任意の Slack のチャンネルに通知を飛ばすための Bot (これは公式のインテグレーションではできないはず) を GAS で作った話です。</p>
<h2 id="いきさつ"><a href="#いきさつ" class="headerlink" title="いきさつ"></a>いきさつ</h2><p>IGGG では予てより <a href="https://slack.com/" target="_blank" rel="noopener">Slack</a> というチャットサービスを利用して日々 <del>雑談</del> ディスカッションをしております。<br>しかし、フリープランの Slack では <strong>ログが一万件しか残らない！</strong><br>割と重要な事案が <del>しょーもない雑談</del> 活発な技術的な議論によって、気づいたら流れてしまう…。</p>
<p>皆を説得して有償プランにしようとか、ログの残るサービスに移ろうとか、何度かいろんな案で話し合ったのですが…いろいろな理由で難しい。<br>そこで、IGGG の <del>外圧担当</del> CTO こと <a href="https://twitter.com/gion_U" target="_blank" rel="noopener">擬音</a> より <strong>GitHub の Issue で管理しよう</strong> との提案が、今年の4月中旬ぐらいにされた。</p>
<p><img s1c="/images/make-manager-bot-for-slack/management_repo.jpg" alt="いい感じ"></p>
<p>しっかりと問題提起・議論が残り、とてもいい感じ。</p>
<h2 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h2><p>ただ、いくつか問題があった。</p>
<ol>
<li>IGGG の GitHub 組織アカウントに所属しないと議論が見れない<ul>
<li>誰しもが GitHub アカウントを持ってるわけでは…<ul>
<li><del>もっておこうよ</del></li>
</ul>
</li>
<li>Slack の GitHub Integration で特定のチャンネル(#management)に飛ばす<ul>
<li>飛ばしてるけど、決定事項(Issueの結論)だけ #general に飛ばしたい</li>
<li>全部 #general に飛ばしたらうるさい</li>
</ul>
</li>
</ul>
</li>
<li>特定のチャンネルで見たい特定の Issue がある<ul>
<li>インフラチャンネルで <em>IPアドレスが欲しい</em> という Issue が見たいとか</li>
<li>いちいち #management に移るのめんどい</li>
</ul>
</li>
</ol>
<p>要するに 1) #general に Issue の Open と Close だけをコメント付きで通知したいのと、 2) 任意の Issue のコメントを任意のチャンネルに通知したい。</p>
<p>ということで、これらの問題を解決するために Slack の Bot を作った。</p>
<h2 id="1-general-に-Issue-の-Open-と-Close-だけをコメント付きで通知する"><a href="#1-general-に-Issue-の-Open-と-Close-だけをコメント付きで通知する" class="headerlink" title="1. #general に Issue の Open と Close だけをコメント付きで通知する"></a>1. #general に Issue の Open と Close だけをコメント付きで通知する</h2><p>GitHub インテグレーションでも、Issue の Open, Close だけを飛ばすという設定はある。</p>
<p><img s1c="/images/make-manager-bot-for-slack/github_integration_setting.jpg" alt="GitHub インテグレーションにて"></p>
<p>だがしかし、これでは</p>
<p><img s1c="/images/make-manager-bot-for-slack/issue_test.jpg" alt="てすと"></p>
<p>という感じの Issue に対し(<code>てててすと</code> というコメントは Close 時に書いたコメント)</p>
<p><img s1c="/images/make-manager-bot-for-slack/slack_github_notification.jpg" alt="てーすと"></p>
<p>と感じに来る(そりゃそう)。<br>ここで、最後のコメントも通知してほしいのだ(Issueの結論を書いて)。</p>
<h3 id="Manager-1号"><a href="#Manager-1号" class="headerlink" title="Manager 1号"></a>Manager 1号</h3><p>ということで Bot を作った。<br>ソースコードは<a href="https://github.com/IGGG/google-apps-scripts/blob/master/management/GeneralManager.gs" target="_blank" rel="noopener">こちら</a>。</p>
<p>以下の3つのGASライブラリを用いている。</p>
<ul>
<li><a href="https://github.com/soundTricker/SlackApp" target="_blank" rel="noopener">SlackApp</a> : <code>M3W5Ut3Q39AaIwLquryEPMwV62A3znfOO</code></li>
<li><a href="https://github.com/matsubara0507/gasdump/tree/githubapi/GitHubAPI" target="_blank" rel="noopener">GitHubAPI</a> : <code>1F4yn329GjHKdcXu9nm0uBZHFo40NGRUF8dfZCTHM1KjXpOXYr2BzIIcJ</code></li>
<li><a href="https://github.com/simula-innovation/gas-underscore" target="_blank" rel="noopener">Underscore</a> : <code>M3i7wmUA_5n0NSEaa6NnNqOBao7QLBR4j</code></li>
</ul>
<p>また、<a href="https://api.slack.com/custom-integrations/legacy-tokens" target="_blank" rel="noopener">SlackBot の APIトークン</a> と <a href="https://github.com/blog/1509-personal-api-tokens" target="_blank" rel="noopener">GitHub の APIトークン</a> を利用している。</p>
<p>GitHub の Personal Token を利用しているので、念のため IGGG の GAS では無く、個人の GAS 上で作った。</p>
<h3 id="実装"><a href="#実装" class="headerlink" title="実装"></a>実装</h3><p>動作は Issue の Open と Close にフックして動作させ、POSTデータを解析し、適切なメッセージ作成して、Slack に投げている。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doPost</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> jsonString = e.postData.getDataAsString();</span><br><span class="line">  <span class="keyword">var</span> jsonData = <span class="built_in">JSON</span>.parse(jsonString);</span><br><span class="line">  postMessage(jsonData, <span class="string">'general'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postMessage</span>(<span class="params">data, channelName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> prop = PropertiesService.getScriptProperties().getProperties();</span><br><span class="line">  <span class="keyword">const</span> repo = prop.GITHUB_OWNER + <span class="string">'/'</span> + prop.GITHUB_REPO;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 念のためのフィルタリング */</span></span><br><span class="line">  <span class="keyword">if</span> (data[<span class="string">'repository'</span>][<span class="string">'full_name'</span>] != repo &amp;&amp; data[<span class="string">'comment'</span>] == <span class="literal">undefined</span> &amp;&amp; data[<span class="string">'issue'</span>] != <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"invalid repository."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* 余計なアクション(editedとか)は破棄 */</span></span><br><span class="line">  <span class="keyword">if</span> (data[<span class="string">'action'</span>] != <span class="string">'opened'</span></span><br><span class="line">      &amp;&amp; data[<span class="string">'action'</span>] != <span class="string">'closed'</span></span><br><span class="line">      &amp;&amp; data[<span class="string">'action'</span>] != <span class="string">'reopened'</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"undefined action: "</span> + data[<span class="string">'action'</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">　<span class="comment">/* メッセージを作成 */</span></span><br><span class="line">  <span class="keyword">var</span> number = data[<span class="string">'issue'</span>][<span class="string">'number'</span>];</span><br><span class="line">  <span class="keyword">var</span> message = makeMessage(data[<span class="string">'action'</span>], data[<span class="string">'issue'</span>], repo, prop);  </span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Slackに投げる */</span></span><br><span class="line">  <span class="keyword">var</span> slackApp = SlackApp.create(prop.SLACK_API_TOKEN);</span><br><span class="line">  <span class="keyword">const</span> BOT_NAME = <span class="string">'manager'</span>;</span><br><span class="line">  <span class="keyword">const</span> BOT_ICON = <span class="string">'http://drive.google.com/uc?export=view&amp;id='</span> + prop.ICON_ID;</span><br><span class="line">  <span class="keyword">var</span> option = &#123; <span class="attr">username</span> : BOT_NAME, <span class="attr">icon_url</span> : BOT_ICON, <span class="attr">link_names</span> : <span class="number">1</span> &#125;;</span><br><span class="line">  <span class="keyword">var</span> _ = Underscore.load();</span><br><span class="line">  slackApp.postMessage(channelName, <span class="string">''</span>, _.extend(option, message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>メッセージは Open, Close, ReOpen の場合に分けて作成している。<br>Close の場合だけ直近のコメントを GitHub API を使って取ってきている(<code>getIssueResentCommentBody</code>)。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeMessage</span>(<span class="params">action, issue, repo, prop</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> user = <span class="string">'&lt;'</span> + issue[<span class="string">'user'</span>][<span class="string">'html_url'</span>] + <span class="string">'|'</span> + issue[<span class="string">'user'</span>][<span class="string">'login'</span>] + <span class="string">'&gt;'</span>;</span><br><span class="line">  <span class="comment">/* アクションごとに分岐 */</span></span><br><span class="line">  <span class="keyword">var</span> actionText = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> text = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">switch</span>(action) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'opened'</span>:</span><br><span class="line">      actionText = <span class="string">'created'</span>;</span><br><span class="line">      text = issue[<span class="string">'body'</span>];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'closed'</span>:</span><br><span class="line">      actionText = <span class="string">'closed'</span>;</span><br><span class="line">      text = getIssueResentCommentBody(issue[<span class="string">'number'</span>], prop);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'reopened'</span>:</span><br><span class="line">      actionText = <span class="string">'re-opened'</span>;</span><br><span class="line">      text = issue[<span class="string">'body'</span>];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="keyword">var</span> pretext = <span class="string">'['</span> + repo + <span class="string">'] Issue '</span> + actionText + <span class="string">' by '</span> + user;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* いい感じなメッセージにするために */</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="string">'attachments'</span>: <span class="built_in">JSON</span>.stringify([&#123;</span><br><span class="line">      <span class="string">'pretext'</span>: pretext,</span><br><span class="line">      <span class="string">'title'</span>: <span class="string">'#'</span> + issue[<span class="string">'number'</span>] + <span class="string">': '</span> + issue[<span class="string">'title'</span>],</span><br><span class="line">      <span class="string">'title_link'</span>: issue[<span class="string">'html_url'</span>],</span><br><span class="line">      <span class="string">'color'</span>: prop.COLOR,</span><br><span class="line">      <span class="string">'text'</span>: text,</span><br><span class="line">      <span class="string">'footer'</span>: <span class="string">'詳細は #management かリポジトリで'</span></span><br><span class="line">    &#125;])</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIssueResentCommentBody</span>(<span class="params">number, prop</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> github = GitHubAPI.create(prop.GITHUB_OWNER, prop.GITHUB_REPO, prop.GITHUB_API_TOKEN);</span><br><span class="line">  <span class="keyword">var</span> comment = github.get(<span class="string">"/issues/"</span> + number + <span class="string">"/comments"</span>);</span><br><span class="line">  <span class="keyword">return</span> comment[comment.length<span class="number">-1</span>][<span class="string">'body'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://api.slack.com/docs/message-attachments" target="_blank" rel="noopener"><code>attachments</code></a>を使って、頑張っていい感じのメッセージにしている。<br>これを模索するために、テストとして無駄にメッセージを投げてしまった(ごめんね)。</p>
<p>ちなみに、webhook せずにテストするときは</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> prop = PropertiesService.getScriptProperties().getProperties();</span><br><span class="line">  <span class="keyword">var</span> data = &#123;</span><br><span class="line">    <span class="string">'action'</span>: <span class="string">'closed'</span>,</span><br><span class="line">    <span class="string">'repository'</span>: &#123;</span><br><span class="line">      <span class="string">'full_name'</span>: prop.GITHUB_OWNER + <span class="string">'/'</span> + prop.GITHUB_REPO</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'issue'</span>: &#123;</span><br><span class="line">      <span class="string">'number'</span>: <span class="number">15</span>,</span><br><span class="line">      <span class="string">'title'</span>: <span class="string">'このリポジトリは必要か'</span>,</span><br><span class="line">      <span class="string">'user'</span>: &#123;</span><br><span class="line">        <span class="string">'login'</span>: <span class="string">'matsubara0507'</span>,</span><br><span class="line">        <span class="string">'html_url'</span>: <span class="string">'https://github.com/matsubara0507'</span></span><br><span class="line">      &#125;,</span><br><span class="line">    <span class="string">'html_url'</span>: <span class="string">'https://github.com/'</span> + prop.GITHUB_OWNER + <span class="string">'/'</span> + prop.GITHUB_REPO + <span class="string">'/issues/15'</span>,</span><br><span class="line">    <span class="string">'body'</span>: <span class="string">'なんか知らぬ間に決まってる感じもある\n自分で見に行けってのもあるけどサ'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">/* テスト！！*/</span></span><br><span class="line">  postMessage(data, <span class="string">'bot-test'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>こんな感じの関数を作って実行する。</p>
<p>あとは、このスクリプトを、<em>公開</em> -&gt; <em>ウェブアプリケーションとして導入</em> を押して webhook 用の URL を発行し、これを リポジトリの Webhook に設定するだけ。</p>
<p><img s1c="/images/make-manager-bot-for-slack/webhook_setting1.jpg" alt="Issueだけチェックする"></p>
<h3 id="実行"><a href="#実行" class="headerlink" title="実行"></a>実行</h3><p><img s1c="/images/make-manager-bot-for-slack/slack_manager1_notification.jpg" alt="いい感じ"></p>
<h2 id="2-任意の-Issue-のコメントを任意のチャンネルに通知する"><a href="#2-任意の-Issue-のコメントを任意のチャンネルに通知する" class="headerlink" title="2. 任意の Issue のコメントを任意のチャンネルに通知する"></a>2. 任意の Issue のコメントを任意のチャンネルに通知する</h2><p>GitHub インテグレーションは特定のリポジトリと特定のチェンネルをつなぐ。<br>よって、特定のリポジトリの特定の Issue と特定の特定のチャンネル繋ぐことはできない。</p>
<h3 id="Manager-2号"><a href="#Manager-2号" class="headerlink" title="Manager 2号"></a>Manager 2号</h3><p>どのチャンネルにどの Issue のを通知するかの設定も Slack からしたいよね。<br>そのため、設定する側と、コメントにフックして通知する側の2つに分けて書くことにする。<br>それらのソースコードは、<a href="9https://github.com/IGGG/google-apps-scripts/blob/master/management/WriteManager.gs" target="_blank" rel="noopener">これ(設定)</a> と <a href="https://github.com/IGGG/google-apps-scripts/blob/master/management/ReadManager.gs" target="_blank" rel="noopener">これ(通知)</a>。</p>
<p>ライブラリは 1号のと同じ。</p>
<p>チャンネルと Issue の対応表は(めちゃ簡単な)スプレッドシートで残しておくことにした。</p>
<p><img s1c="/images/make-manager-bot-for-slack/table_ss.jpg" alt="雑な表"></p>
<h2 id="設定側の実装"><a href="#設定側の実装" class="headerlink" title="設定側の実装"></a>設定側の実装</h2><p>Slack の Outgoing Webhook Integration にフックしてスプレッドシートに対応関係を書き込むことにする。</p>
<p><code>@manager &lt;cmd&gt;: &lt;issue-num&gt;</code> というフォーマットでメッセージ送られてくると想定している。<br>コマンド (<code>&lt;cmd&gt;</code>)には、チャンネルと Issue の対応関係をセットする <code>set-issue</code> と、対応関係をアンセットする <code>unset-issue</code> がある。<br>また <code>set-issue</code> では、指定された Issue の番号 (<code>&lt;issue-num&gt;</code>) が本当に存在するかや、既にセット済みかを確認している(<code>existRow</code>)。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doPost</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> prop = PropertiesService.getScriptProperties().getProperties();  </span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Spread Sheet の読み取り*/</span></span><br><span class="line">  <span class="comment">/* 割愛 */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Slack の準備*/</span></span><br><span class="line">  <span class="comment">/* 割愛 */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* メッセージによって分岐 */</span>  </span><br><span class="line">  <span class="keyword">var</span> message = e.parameter.text.split(<span class="string">' '</span>);</span><br><span class="line">  <span class="keyword">var</span> channelName = e.parameter.channel_name;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (message[<span class="number">0</span>] != (<span class="string">'@'</span> + BOT_NAME)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'invalid bot name.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> _ = Underscore.load();</span><br><span class="line">  <span class="keyword">var</span> subcmd = message[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">var</span> text = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">switch</span>(subcmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'set-issue:'</span>:</span><br><span class="line">      <span class="keyword">var</span> number = message[<span class="number">2</span>];</span><br><span class="line">      <span class="keyword">var</span> issue = getIssue(number, prop);</span><br><span class="line">      <span class="keyword">if</span> (issue == <span class="string">'error'</span>) &#123;</span><br><span class="line">        text = <span class="string">'issuer #'</span> + number + <span class="string">' is not exist.'</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (existRow(table, channelName, number)) &#123;</span><br><span class="line">        text = <span class="string">'issue &lt;'</span> + issue[<span class="string">'html_url'</span>] + <span class="string">'| #'</span> + number + <span class="string">'&gt; has already been set for #'</span> + channelName;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        text = <span class="string">'OK! set issue.'</span>;</span><br><span class="line">        <span class="keyword">var</span> repo = prop.GITHUB_OWNER + <span class="string">'/'</span> + prop.GITHUB_REPO;</span><br><span class="line">        option = _.extend(option, makeMessage(issue, repo, prop));</span><br><span class="line">        sheet.getRange(rowNum + <span class="number">1</span>, <span class="number">1</span>).setValue(channelName);</span><br><span class="line">        sheet.getRange(rowNum + <span class="number">1</span>, <span class="number">2</span>).setValue(number);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'unset-issue:'</span>:</span><br><span class="line">      <span class="keyword">var</span> number = message[<span class="number">2</span>];</span><br><span class="line">      text = <span class="string">'not set yet: '</span> + channelName + <span class="string">' - '</span> + number;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; table.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (table[i][<span class="number">0</span>] == channelName &amp;&amp; table[i][<span class="number">1</span>] == number) &#123;</span><br><span class="line">          sheet.getRange(i + <span class="number">1</span>, <span class="number">1</span>).setValue(<span class="string">''</span>);</span><br><span class="line">          sheet.getRange(i + <span class="number">1</span>, <span class="number">2</span>).setValue(<span class="string">''</span>);</span><br><span class="line">          text = <span class="string">'OK! unset issue.'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      text = <span class="string">'undefined cmd: '</span> + subcmd;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  slackApp.postMessage(channelName, text, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">existRow</span>(<span class="params">table, channelName, number</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; table.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (table[i][<span class="number">1</span>] == number &amp;&amp; table[i][<span class="number">0</span>] == channelName)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>指定された Issue の番号が本当に存在するかを確認するために、GitHubAPI をたたいて、リポジトリ内の Issue を全て取得し、愚直に線形探索している。<br>見つかれば、その Issue をそのまま返し、無い場合は <code>&quot;error&quot;</code> という文字列を返している。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIssue</span>(<span class="params">number, prop</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> github = GitHubAPI.create(prop.GITHUB_OWNER, prop.GITHUB_REPO, prop.GITHUB_API_TOKEN);</span><br><span class="line">  <span class="keyword">var</span> issues = github.get(<span class="string">'/issues?state=all'</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; issues.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (issues[i][<span class="string">'number'</span>] == number)</span><br><span class="line">      <span class="keyword">return</span> issues[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'error'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>こいつも <code>attachments</code> でいい感じのメッセージにしている。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeMessage</span>(<span class="params">issue, repo, prop</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> user = <span class="string">'&lt;'</span> + issue[<span class="string">'user'</span>][<span class="string">'html_url'</span>] + <span class="string">'|'</span> + issue[<span class="string">'user'</span>][<span class="string">'login'</span>] + <span class="string">'&gt;'</span>;</span><br><span class="line">  <span class="keyword">var</span> pretext = <span class="string">'['</span> + repo + <span class="string">']  Issue created by '</span> + user;</span><br><span class="line">  <span class="keyword">var</span> title = <span class="string">'#'</span> + issue[<span class="string">'number'</span>] + <span class="string">' '</span> + issue[<span class="string">'title'</span>];</span><br><span class="line">  <span class="keyword">var</span> title_link = issue[<span class="string">'html_url'</span>];</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="string">'attachments'</span>: <span class="built_in">JSON</span>.stringify([&#123;</span><br><span class="line">      <span class="string">'pretext'</span>: pretext,</span><br><span class="line">      <span class="string">'title'</span>: title,</span><br><span class="line">      <span class="string">'title_link'</span>: title_link,</span><br><span class="line">      <span class="string">'color'</span>: prop.COLOR,</span><br><span class="line">      <span class="string">'text'</span>: issue[<span class="string">'body'</span>]</span><br><span class="line">    &#125;])</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="設定側の実行"><a href="#設定側の実行" class="headerlink" title="設定側の実行"></a>設定側の実行</h2><p><img s1c="/images/make-manager-bot-for-slack/slack_manager2-1_notification.jpg" alt="いい感じ"></p>
<h2 id="通知側の実装"><a href="#通知側の実装" class="headerlink" title="通知側の実装"></a>通知側の実装</h2><p>GitHub リポジトリに Issue のコメントだけに Webhook されるようにする。<br>そしたら POST データを解析し、スプレッドシートの中から2列目が等しい行の1列目だけ取ってきて(高階関数最高)、POST データからいい感じのメッセージ生成して、Slack Bot に通知している。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doPost</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> jsonString = e.postData.getDataAsString();</span><br><span class="line">  <span class="keyword">var</span> jsonData = <span class="built_in">JSON</span>.parse(jsonString);</span><br><span class="line">  postMessage(jsonData);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postMessage</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> prop = PropertiesService.getScriptProperties().getProperties();</span><br><span class="line">  <span class="keyword">const</span> repo = prop.GITHUB_OWNER + <span class="string">'/'</span> + prop.GITHUB_REPO;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* いい感じにフィルタリング */</span></span><br><span class="line">  <span class="keyword">if</span> (data[<span class="string">'repository'</span>][<span class="string">'full_name'</span>] != repo &amp;&amp; data[<span class="string">'comment'</span>] != <span class="literal">undefined</span> &amp;&amp; data[<span class="string">'issue'</span>] != <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'invalid repository.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Spread Sheet の読み取り*/</span></span><br><span class="line">  <span class="comment">/* 割愛 */</span></span><br><span class="line"></span><br><span class="line">　<span class="comment">/* 表からフックされた Issue の番号を線形探索 */</span></span><br><span class="line">  <span class="keyword">var</span> number = data[<span class="string">'issue'</span>][<span class="string">'number'</span>];</span><br><span class="line">  <span class="keyword">var</span> channels = table.filter(<span class="function"><span class="keyword">function</span>(<span class="params">row</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> row[<span class="number">1</span>] == number;</span><br><span class="line">  &#125;).map(<span class="function"><span class="keyword">function</span>(<span class="params">row</span>)</span>&#123; <span class="keyword">return</span> row[<span class="number">0</span>] &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* いい感じのメッセージを作成 */</span></span><br><span class="line">  <span class="keyword">var</span> message = makeMessage(data[<span class="string">'action'</span>], data[<span class="string">'comment'</span>], data[<span class="string">'issue'</span>], repo, prop);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Slack の準備*/</span></span><br><span class="line">  <span class="comment">/* 割愛 */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> _ = Underscore.load();</span><br><span class="line">  channels.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">channelName</span>)</span>&#123;</span><br><span class="line">    option = _.extend(option, message);</span><br><span class="line">    slackApp.postMessage(channelName, <span class="string">''</span>, option);  </span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>メッセージはコメントの作成・編集・削除ごとに異なる。<br>ただ、編集時には編集前のコメントしか手に入らないので、GitHub API をたたいて編集後のコメントを取りに行ってる(getIssueCommentBody)。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeMessage</span>(<span class="params">action, comment, issue, repo, prop</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> user = <span class="string">'&lt;'</span> + comment[<span class="string">'user'</span>][<span class="string">'html_url'</span>] + <span class="string">'|'</span> + comment[<span class="string">'user'</span>][<span class="string">'login'</span>] + <span class="string">'&gt;'</span>;</span><br><span class="line">  <span class="keyword">var</span> issueTitle = <span class="string">'&lt;'</span> + comment[<span class="string">'html_url'</span>] + <span class="string">'|'</span> + <span class="string">'#'</span> + issue[<span class="string">'number'</span>] + <span class="string">': '</span> + issue[<span class="string">'title'</span>] + <span class="string">'&gt;'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> actionText = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> text = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">switch</span>(action) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'created'</span>:</span><br><span class="line">      actionText = <span class="string">'New'</span>;</span><br><span class="line">      text = comment[<span class="string">'body'</span>];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'edited'</span>:</span><br><span class="line">      actionText = <span class="string">'Edit'</span>;</span><br><span class="line">      text = getIssueCommentBody(comment[<span class="string">'id'</span>], prop);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'deleted'</span>:</span><br><span class="line">      actionText = <span class="string">'Delet'</span>;</span><br><span class="line">      text = comment[<span class="string">'body'</span>];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> pretext = <span class="string">'['</span> + repo + <span class="string">'] '</span> + actionText + <span class="string">' comment by '</span> + user + <span class="string">' on isuue '</span> + issueTitle;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="string">'attachments'</span>: <span class="built_in">JSON</span>.stringify([&#123;</span><br><span class="line">      <span class="string">'pretext'</span>: pretext,</span><br><span class="line">      <span class="string">'color'</span>: prop.COLOR,</span><br><span class="line">      <span class="string">'text'</span>: text</span><br><span class="line">    &#125;])</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIssueCommentBody</span>(<span class="params">id, prop</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> github = GitHubAPI.create(prop.GITHUB_OWNER, prop.GITHUB_REPO, prop.GITHUB_API_TOKEN);</span><br><span class="line">  <span class="keyword">var</span> comment = github.get(<span class="string">'/issues/comments/'</span> + id);</span><br><span class="line">  <span class="keyword">return</span> comment[<span class="string">'body'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="通知側の実行"><a href="#通知側の実行" class="headerlink" title="通知側の実行"></a>通知側の実行</h2><p><img s1c="/images/make-manager-bot-for-slack/slack_manager2-2_notification.jpg" alt="いい感じ"></p>
<h2 id="おしまい"><a href="#おしまい" class="headerlink" title="おしまい"></a>おしまい</h2><p>これで部内の問題・情報管理がさらに円滑になるはず！(願望)</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web/">Web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/GitHub/">GitHub</a>, <a href="/tags/Slack/">Slack</a>, <a href="/tags/Bot/">Bot</a>, <a href="/tags/Google-Apps-Script/">Google Apps Script</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="IGGGのGitHubPagesの開発環境のDockerイメージを作る" style="display: none;">
    <div idplusp="IGGGのGitHubPagesの開発環境のDockerイメージを作る">
      <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2017-05-10T15:29:36.000Z"><a href="#">2017-05-11</a></time>
      
      
  
    <h1 class="depth title">IGGG の GitHub Pages の開発環境の Dockerイメージを作る</h1>
  

    </header>
    <div class="entry depth">
      
        <p>IGGG 名古屋支部のひげです。</p>
<p>久々に更新。</p>
<p><a href="https://www.docker.com/" target="_blank" rel="noopener">Docker</a> がマイブームだったので、この <a href="https://iggg.github.io/">iggg.github.io</a> の開発環境も Docker 化しようという話です。</p>
<p>基本的に話は簡単。<br>Windows上でやるせいで悪戦苦闘したという感じです。</p>
<h2 id="開発環境"><a href="#開発環境" class="headerlink" title="開発環境"></a>開発環境</h2><p>ワタシのパソコンはこんな感じ</p>
<ul>
<li>Windows10 Home</li>
<li>Docker ToolBox</li>
<li>Docker version 17.03.1-ce</li>
<li>VirtualBox 5.1.18</li>
</ul>
<p>Windows10 Home なので <a href="https://docs.docker.com/docker-for-windows/" target="_blank" rel="noopener">Docker for Windows</a> は使えず、仕方がないので VirtualBox を利用する <a href="https://www.docker.com/products/docker-toolbox" target="_blank" rel="noopener">Docker ToolBox</a> を使ってる。</p>
<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>いろいろ参考にしつつ、試した結果、これだけで良い。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">6</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm install -g hexo-cli</span></span><br></pre></td></tr></table></figure>

<p>このサイトは Hexo を使っているので、Node.js が必要だ。<br>なので、ベースは<a href="https://hub.docker.com/_/node/" target="_blank" rel="noopener">公式の <code>node</code> Docker イメージ</a>を使った。</p>
<p>これに，<code>hexo-cli</code> をインストールした。<br><code>-g</code> はグローバル環境にインストールするというオプション。</p>
<p>あとは、</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ cd C:\Users\hoge\git\iggg.github.io</span><br><span class="line">$ docker build -t iggg-ghio .</span><br><span class="line">$ docker run -it -v /c/Users/hoge/git/iggg.github.io:/app -p 4000:4000 iggg-ghio /bin/bash</span><br></pre></td></tr></table></figure>

<p>などして bash を実行する。<br><code>-v</code> オプションで、現在のディレクトリを <code>/app</code> にマウントしている。</p>
<p>そして、Dockerコンテナ内で</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ npm install --no-bin-links</span><br><span class="line">$ hexo clean</span><br><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>を実行する。<br>ワークディレクトリにマウントするため、ビルド時に <code>npm install</code> をするわけにはいかない。<br>そのため、ビルド後のコンテナ内で <code>npm install</code> をしている。<br>また、<code>--no-bin-links</code> を指定しないと、Windows ではうまくいかない。</p>
<p>これで、VirtualBox で指定したIPアドレス(ToolBoxを使ってなければ localhost)の4000ポートにアクセスすれば見れるはずだ。</p>
<h2 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h2><p><code>docker build</code> してからの操作が多いので <code>docker-compose</code> にまとめてしまおう。<br>本来の使い方とは異なってるが、こういう用途でも十分使える。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">blog:</span><br><span class="line">  build: .</span><br><span class="line">  volumes:</span><br><span class="line">    - .:/app</span><br><span class="line">  ports:</span><br><span class="line">    - &quot;4000:4000&quot;</span><br><span class="line">  command: ./run.sh</span><br><span class="line">  working_dir: /app</span><br></pre></td></tr></table></figure>

<p><code>run.sh</code> は</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#! /bin/sh</span><br><span class="line"></span><br><span class="line">npm install --no-bin-links</span><br><span class="line">hexo clean</span><br><span class="line">hexo server</span><br></pre></td></tr></table></figure>

<p>Windowsだと、ここで <code>docker-compose up</code> しても次のようなエラーが返ってくる。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ERROR: for browser  Cannot create container for service browser: invalid bind mount spec &quot;C:\\Users\\hoge\\git\\iggg.github.io:/app:rw&quot;: invalid volume specification: &apos;C:\Users\hoge\git\iggg.github.io:/app:rw&apos;</span><br><span class="line">ERROR: Encountered errors while bringing up the project.</span><br></pre></td></tr></table></figure>

<p>原因はパスの指定の仕方で、相対パスで <code>.:/app</code> としてるとおかしくなる。<br><a href="http://qiita.com/ryo-endo/items/edc8c6f16e60b7533749" target="_blank" rel="noopener">ググった結果</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">COMPOSE_CONVERT_WINDOWS_PATHS=1</span><br></pre></td></tr></table></figure>

<p>と書いてある <code>.env</code> ファイルをカレントディレクトリに置くことうまく動作した。</p>
<p>あと、よく怒られたのが、<code>run.sh</code> の改行文字で、LF でないといけないのに、Windows では時折 CRLF に書き換わる(gitで落としてきたときとか)。</p>
<h2 id="実行"><a href="#実行" class="headerlink" title="実行"></a>実行</h2><p><code>docker-compose up</code> して特定のIPアドレスの4000ポートを見ればうまくいく。</p>
<p><img s1c="/images/iggg-ghio-on-docker/dockercompose.jpg" alt></p>
<h2 id="おしまい"><a href="#おしまい" class="headerlink" title="おしまい"></a>おしまい</h2><p>思いのほか時間かかった。<br>やっぱ Windows での開発はなかなかきついね。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web/">Web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Docker/">Docker</a>, <a href="/tags/Node-js/">Node.js</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>





<div id="myCanvasContainer" class="animated fadeIn" style="display: none;">
 <canvas width="500" height="500" id="myCanvas">
 <ul>
  
    <li><h2><a href="/tags/Android/">Android</a></h2></li>
  
    <li><h2><a href="/tags/Bot/">Bot</a></h2></li>
  
    <li><h2><a href="/tags/CircleCI/">CircleCI</a></h2></li>
  
    <li><h2><a href="/tags/Docker/">Docker</a></h2></li>
  
    <li><h2><a href="/tags/GitHub/">GitHub</a></h2></li>
  
    <li><h2><a href="/tags/Google-Apps-Script/">Google Apps Script</a></h2></li>
  
    <li><h2><a href="/tags/HTML/">HTML</a></h2></li>
  
    <li><h2><a href="/tags/Heroku/">Heroku</a></h2></li>
  
    <li><h2><a href="/tags/Hugo/">Hugo</a></h2></li>
  
    <li><h2><a href="/tags/Java/">Java</a></h2></li>
  
    <li><h2><a href="/tags/JavaScript/">JavaScript</a></h2></li>
  
    <li><h2><a href="/tags/Linux/">Linux</a></h2></li>
  
    <li><h2><a href="/tags/Node-js/">Node.js</a></h2></li>
  
    <li><h2><a href="/tags/Python/">Python</a></h2></li>
  
    <li><h2><a href="/tags/Ruby/">Ruby</a></h2></li>
  
    <li><h2><a href="/tags/Scrapbox-io/">Scrapbox.io</a></h2></li>
  
    <li><h2><a href="/tags/Slack/">Slack</a></h2></li>
  
    <li><h2><a href="/tags/Twitter/">Twitter</a></h2></li>
  
    <li><h2><a href="/tags/WordPress/">WordPress</a></h2></li>
  
    <li><h2><a href="/tags/esa/">esa</a></h2></li>
  
    <li><h2><a href="/tags/guntohfes/">guntohfes</a></h2></li>
  
    <li><h2><a href="/tags/libnss-json/">libnss-json</a></h2></li>
  
  </ul>
 </canvas>
</div>
 


  <script>
  $(".archive").click(function (e) {
      if ($("title").text().indexOf( "群馬大学電子計算機研究会 IGGG" )>=0 ){
          if (e.target.href){
              $(".animated:contains(\'"+e.target.text+"\')").addClass("bounceOut");
              setTimeout(function(){
                  var pageTitle=e.target.text;
                  loadpage(pageTitle);
                  $(".animated:contains(\'"+e.target.text+"\')").removeClass("bounceOut");
                  history.pushState( pageTitle, $("title").text(), e.target.href);
              }, 500);
          }
      }
      return false;
  });
  </script>
  <script>
  $(".backtohome").click(function (e) {
      if ($("title").text() != "群馬大学電子計算機研究会 IGGG"){
          //go back to home
          setTimeout(function(){
              loadpage();
              history.pushState( null, $("title").text(), "/");
          }, 150);
      } else {
          //go to tag cloud
          loadpage("#tag");
          history.pushState( "#tag", $("title").text(), "#tag");
      }
      return false;
  });
  </script>

  <script>
  function loadpage(pageTitle) {
      scroll(0,0);
      if ( !pageTitle ){
          //home
          $('#myCanvasContainer').css("display","none");
          $("title").text("群馬大学電子計算機研究会 IGGG");
          $("[idplus]").css("display","none");
          $(".titlelist").css("display","");
      } else if ( pageTitle.indexOf("#tag")>=0 ) {
          //tagcloud
          $('#myCanvasContainer').css("display","");
          $("[idplus]").css("display","none");
          $(".titlelist").css("display","none");
          $("title").text("Tag Cloud | 群馬大学電子計算機研究会 IGGG");
      } else {
          //pages
          $('#myCanvasContainer').css("display","none");
          $("title").text(pageTitle + " | 群馬大学電子計算機研究会 IGGG");
          var pageIDplus=pageTitle.replace(/\s+/g,"")
          $(".titlelist").css("display","none");
          $("[idplus=\'" + pageIDplus +"\']" ).css("display","");
          $.ajaxPrefilter(function( options, originalOptions, jqXHR ) {
            options.async = true;
          });
          $("[idplusp=\'" + pageIDplus +"\']" ).replaceWith($("[idplus=\'" + pageIDplus +"\']").html().replace(/img\ s1c/g, "img src"));
          $.ajaxPrefilter(function( options, originalOptions, jqXHR ) {
            options.async = false;
          });
      }
  };
  </script>
  <script>
  window.addEventListener('popstate', function(e) {
      if (location.href.indexOf("#comment") > 0){
          location.reload();
      }else {
          loadpage(e.state);
      }
      },false);
  </script>
  <script>

  </script>



<nav id="pagination" class="titlelist">
  
  
    <a href="/page/2/" class="alignright next titlelist">Next</a>
  
  <div class="clearfix"></div>
</nav>

</div></div>
    <div class="clearfix"></div>
  </div>

  <footer id="footer" class="inner"></footer>
  
<script src="/js/jquery.imagesloaded.min.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



<script src="/js/headroom.min.and.gallery.js"></script>
<script>
$("#mini-toggle").click(function () {
    $( "#main-nav" ).css("display","inline");
    setTimeout(function(){
        $( "#main-nav" ).removeClass("slideInRight").addClass("slideOutRight");
    }, 3000);
    setTimeout(function(){
        $( "#main-nav" ).css("display","");
        $( "#main-nav" ).removeClass("slideOutRight").addClass("slideInRight");
    }, 3555);
});
</script>

<script>
$("#header").headroom({
  "tolerance": 0,
  "offset": 200,
  "classes": {
    "initial": "",
    "pinned": "slideInDown",
    "unpinned": "slideOutUp"
  }
});
$("#header").headroom("destroy");
</script>

<script>
$("a").click(function () {
    $( "#icon-photo-small"  ).removeClass( "rotateIn" ).addClass( "rotateOut" );
    $( "#icon-photo-normal" ).removeClass( "rotateIn" ).addClass( "rotateOut" );
    setTimeout(function(){
        $( "#icon-photo-small"  ).removeClass( "rotateOut" ).addClass( "rotateIn" );
        $( "#icon-photo-normal" ).removeClass( "rotateOut" ).addClass( "rotateIn" );
    }, 900);
});
</script>


<script type="text/javascript">
  var _gaq = _gaq || [];
  // 拡張リンクのアトリビューション分析用のタグをページに設定する
  var pluginUrl =
   '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-46141384-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    // ユーザー属性とインタレスト カテゴリに関するレポートを有効にする
    // ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



<!--[if lt IE 9]><script src="/js/excanvas.js"></script><![endif]-->
<script src="/js/jquery.tagcanvas.min.js"></script>
 <script type="text/javascript">
 $(document).ready(function() {
   if( ! $('#myCanvas').tagcanvas({
     textColour : '#6d6d6d',
     outlineThickness : 1,
     textHeight: 20,
     maxSpeed : 0.04,
     depth : 0.75
   })) {
     // TagCanvas failed to load
     $('#myCanvasContainer').hide();
   }
   // your other jQuery stuff here...
 });
 </script>



</body>
</html>
