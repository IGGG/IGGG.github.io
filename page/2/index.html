<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta name="theme-color" content="#1b7aca">
  <link rel="icon" href="/images/IGGG_l.png">
  <meta name="application-name" content="群馬大学電子計算機研究会 IGGG">
  <meta name="msapplication-TileColor" content="#1b7aca">
  <meta name="msapplication-square70x70logo" content="/images/IGGG_l.png">
  <meta name="msapplication-square150x150logo" content="/images/IGGG_l.png">
  <meta name="msapplication-wide310x150logo" content="/images/IGGG_l.png">
  <meta name="msapplication-square310x310logo" content="/images/IGGG_l.png">
  <meta name="msapplication-notification" content="frequency=30; polling-uri=/atom.xml">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="/images/IGGG_l.png">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-startup-image" href="/images/IGGG_l.png">

  
  <title>Page 2 | 群馬大学電子計算機研究会 IGGG</title>
  <meta name="author" content="IGGG">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="群馬大学電子計算機研究会 IGGG">

  
    <meta property="og:image" content="/IGGG_l.png">
  

  <link rel="alternate" href="/atom.xml" title="群馬大学電子計算機研究会 IGGG" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
    <link href="/css/animate.css" rel="stylesheet">
  
  
    <script src="/js/jquery-2.0.3.min.js"></script>
  
</head>
</html>

<body>
<!--[if lt IE9]>
<script>
alert("Please Update Your IE \n请升级您的IE浏览器");
</script>
< ![endif]-->
  <header id="header" class="header header--fixed hide-from-print animated slideInDown"><div class="alignleft backtohome">
  <a href="/">
    <img id="icon-photo-small" class="personal-photo  animated rotateIn" src="/images/IGGG_l.png" alt="IGGG">
  </a>
  <h1 id="title-mini" class=""><a href="/">群馬大学電子計算機研究会 IGGG</a></h1>
</div>
<a target="_blank" id="mini-toggle" class="more icon alignright"></a>
<nav id="main-nav" class="alignright animated slideInRight">

    
    
      <a target="_blank" class="icon twitter" href="http://twitter.com/IGGGorg"></a>
    
    
    
    
      <a target="_blank" class="icon github" href="http://github.com/IGGG"></a>
    
    
    
    
    
    
    
  <div class="clearfix"></div>
</nav>

</header>
  <aside id="sidebar" class="alignleft animated slideInLeft"><div class="personal-info">
  <figure>
    
    <div  class="backtohome">
      <a href="/">
        <img id="icon-photo-normal" class="personal-photo animated rotateIn" src="/images/IGGG_l.png" alt="IGGG">
      </a>
    </div>
    
    <figcaption>
      <h3 class=>IGGG</h3>
      <p>Information technology researching society</p><p> of the Gunmer,</p><p> by the Gunmer,</p><p> for the Gunmer</p>
    </figcaption>
  </figure>
  <section class="social">
    
    
      <a target="_blank" class="icon twitter depth" href="http://twitter.com/IGGGorg"></a>
    
    
    
    
      <a target="_blank" class="icon github depth" href="http://github.com/IGGG"></a>
    
    
    
    
    
    
    
  </section>
</div>
<div class="theme-info">
  <a target="_blank" href="https://github.com/heruoxin/hexo-persona-color" class="html5"> Persona Color Theme</a> 
  &copy; - 2019 IGGG
  
</div>
</aside>
  <div id="content" class="inner">
    <p id="header-fix"></p>
    <div id="main-col" class="alignright"><div id="wrapper">
  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2016/12/05/test-github-submodule/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2016/12/05/test-github-submodule/">Submodule と GitHub Pages についてイロイロとテストしてみた</a></h2>
            
            <time class="time title depth" datetime="2016-12-05T02:29:48.000Z">2016-12-05</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2016/12/03/vs-thumbnail/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2016/12/03/vs-thumbnail/">サムネイルを表示したい</a></h2>
            
            <time class="time title depth" datetime="2016-12-03T06:55:01.000Z">2016-12-03</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2016/12/01/adventar-slack-bot/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2016/12/01/adventar-slack-bot/">ADVENTAR の更新を通知する Slack BOT を作ってみた</a></h2>
            
            <time class="time title depth" datetime="2016-11-30T15:00:00.000Z">2016-12-01</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2016/10/19/create-where-is-this/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2016/10/19/create-where-is-this/">ジオタグ解析アプリを作りました</a></h2>
            
            <time class="time title depth" datetime="2016-10-19T10:41:38.000Z">2016-10-19</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2016/10/18/create-anaqram/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2016/10/18/create-anaqram/">AnaQRam を作りました</a></h2>
            
            <time class="time title depth" datetime="2016-10-18T04:58:04.000Z">2016-10-18</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2016/05/30/use-circle-ci/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2016/05/30/use-circle-ci/">GitHub Pages + Hexo + CircleCI + Heroku で自動デプロイ管理</a></h2>
            
            <time class="time title depth" datetime="2016-05-30T14:38:49.000Z">2016-05-30</time>
          </header>
      </div>
    </article>
  </div>

  <div class="archive titlelist">
    <article class="post">
      <div class="post-content animated fadeIn">
        <header>
            
              <div class="icon depth"><a href="/2016/05/29/started-github-pages/"> </a></div>
              <h2 class="depth title" ><a class="animated" href="/2016/05/29/started-github-pages/">Github Pages はじめました</a></h2>
            
            <time class="time title depth" datetime="2016-05-28T17:03:19.000Z">2016-05-29</time>
          </header>
      </div>
    </article>
  </div>




  <div class="animated fadeIn" idplus="SubmoduleとGitHubPagesについてイロイロとテストしてみた" style="display: none;">
    <div idplusp="SubmoduleとGitHubPagesについてイロイロとテストしてみた">
      <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2016-12-05T02:29:48.000Z"><a href="#">2016-12-05</a></time>
      
      
  
    <h1 class="depth title">Submodule と GitHub Pages についてイロイロとテストしてみた</h1>
  

    </header>
    <div class="entry depth">
      
        <p>名古屋支部長のひげです。</p>
<p>これは一応、<a href="http://www.adventar.org/calendars/1572" target="_blank" rel="noopener">IGGG アドベントカレンダー</a> 5日目の記事です。</p>
<p>今回は C91 に向けて GitHub の仕様をイロイロとテストしてみたときの話です。</p>
<h2 id="いきさつ"><a href="#いきさつ" class="headerlink" title="いきさつ"></a>いきさつ</h2><p>IGGG はココ何回か彼の有名なコミケに出展しています。<br>とある事情より、前回(C90) は GitHub にて編集・管理を行いました。<br>今回(C91)も同様に GitHub で編集・管理しようと思ったのですが、部誌(<a href="https://iggg.github.io/lollipop/">Lollipop</a>)用の Web ページを GitHub Pages で作ろうと考え、この野心との兼ね合いでイロイロと試行錯誤しました。</p>
<p>考えを整理すると以下の通りです。</p>
<ul>
<li>C90 のときのリポジトリがある (IGGG/lollipop-vol4)</li>
<li>C91 のリポジトリを作りたい (IGGG/lollipop-vol5 ?)</li>
<li>Lopllipop 用の GitHub Pages を作りたい</li>
</ul>
<p>考え得る案は2つ</p>
<ol>
<li>1つのリポジトリで全てを実現</li>
<li>全て各々のリポジトリで実現</li>
</ol>
<p>前者の場合は既にある <code>lollipop-vol4</code> リポジトリを次のように改変することになる。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">IGGG/lollipop</span><br><span class="line"> | - lollipop-vol4</span><br><span class="line"> | | - ...</span><br><span class="line"> | - lollipop-vol5</span><br><span class="line"> | | - ...</span><br><span class="line"> | - README.md</span><br><span class="line"> | ...</span><br></pre></td></tr></table></figure>

<p>これは新しい巻が出るたびにクローンせずに済むので有り難い。<br>しかし、古い巻に関係ない人も全ての巻のデータを落とさないといけなくなる(例えば vol.5 は寄稿するが vol.4 では寄稿しなかった人)。<br>これは重い気がする。</p>
<p>なので、後者を採用してひと工夫することにした。<br>それが Submodule である。</p>
<h3 id="Git-Submodule"><a href="#Git-Submodule" class="headerlink" title="Git Submodule"></a>Git Submodule</h3><p>詳しくはググってください。</p>
<p><a href="http://qiita.com/kinpira/items/3309eb2e5a9a422199e9" target="_blank" rel="noopener">この</a>あたりを読むとわかりやすい。</p>
<p>端的に言うと、Git Submodule は、リポジトリの下にリポジトリを追加する方法である。<br>自分的に一癖ある機能で、未だによくわかっていない。</p>
<h3 id="最終的なリポジトリ構成"><a href="#最終的なリポジトリ構成" class="headerlink" title="最終的なリポジトリ構成"></a>最終的なリポジトリ構成</h3><p>次のようなリポジトリ構成にした</p>
<ul>
<li>lollipop-vol4 : vol.4 のプライベートリポジトリ</li>
<li>lollipop-vol5 : vol.5 のプライベートリポジトリ</li>
<li>lollipop : lollipop 全体の管理用パブリックリポジトリ<ul>
<li>submodule として lollipop-vol4 と lollipop-vol5 のリポジトリを持つ</li>
</ul>
</li>
</ul>
<p><a href="https://github.com/IGGG/lollipop" target="_blank" rel="noopener">コレ</a></p>
<p>つまり、パブリックリポジトリの中にプライベートリポジトリを Submodule として持つことになる。</p>
<h2 id="本題"><a href="#本題" class="headerlink" title="本題"></a>本題</h2><p>で、パブリックリポジトリがプライベートリポジトリの Submodule を持つ場合</p>
<ul>
<li>そもそも可能か？</li>
<li>GitHub Pages の挙動はどうなるか<ul>
<li><code>docs</code> 以下に置いた場合</li>
<li><code>gh-pages</code> ブランチに置いた場合</li>
</ul>
</li>
</ul>
<p>という疑問が沸いたので検証してみた。<br>という話。</p>
<h2 id="検証"><a href="#検証" class="headerlink" title="検証"></a>検証</h2><p>検証用に利用したリポジトリは<a href="https://github.com/matsubara0507/test-submodule" target="_blank" rel="noopener">コチラ</a> 。</p>
<h3 id="パブリックリポジトリにプライベートリポジトリの-Submodule-を持たせる"><a href="#パブリックリポジトリにプライベートリポジトリの-Submodule-を持たせる" class="headerlink" title="パブリックリポジトリにプライベートリポジトリの Submodule を持たせる"></a>パブリックリポジトリにプライベートリポジトリの Submodule を持たせる</h3><p>できた。</p>
<p>ただし、プライベートリポジトリにリード権限が無い人が Submodule にアクセスしようとしても、エラーが返ってくる(そりゃそうか)。</p>
<p><img s1c="/images/test-github-submodule/click_private_submodule.jpg" alt="クリック!"></p>
<p><img s1c="/images/test-github-submodule/404_github.jpg" alt="404エラー..."></p>
<h3 id="docs-以下に-GitHub-Pages-を設定"><a href="#docs-以下に-GitHub-Pages-を設定" class="headerlink" title="docs 以下に GitHub Pages を設定"></a>docs 以下に GitHub Pages を設定</h3><p>最近のアップデートで、GitHub Pages の index.html を<a href="https://help.github.com/articles/configuring-a-publishing-source-for-github-pages/" target="_blank" rel="noopener">プロジェクトページであれば master ブランチの docs に置いても良くなった</a>。<br>その方が、無駄にブランチを分ける必要が無いので便利な場合がある。</p>
<p>今回も可能であればそうしようと思ったのだが…</p>
<p>どうやら、プライベートリポジトリの Submodule を持つビルドできないようだ。</p>
<p><img s1c="/images/test-github-submodule/error.jpg" alt="怒られた"></p>
<p>メールまで飛んでくる始末である。</p>
<h3 id="gh-pages-以下に-GitHub-Pages-を設定"><a href="#gh-pages-以下に-GitHub-Pages-を設定" class="headerlink" title="gh-pages 以下に GitHub Pages を設定"></a>gh-pages 以下に GitHub Pages を設定</h3><p>うまくいった。</p>
<p>まぁそりゃそうか。</p>
<p><a href="https://github.com/matsubara0507/test-submodule/tree/gh-pages" target="_blank" rel="noopener">コレ</a>と<a href="https://matsubara0507.github.io/test-submodule/" target="_blank" rel="noopener">ココ</a></p>
<p>GitHub Pages は<a href="https://matsubara0507.github.io/test-submodule/README.md" target="_blank" rel="noopener">リポジトリ内を漁れる</a>ので注意。</p>
<h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><ul>
<li>パブリックリポジトリにプライベートリポジトリの Submodule を持たせれる</li>
<li>プライベートリポジトリの Submodule を持つリポジトリを GitHub Pages のソース置き場にできない<ul>
<li>プライベートリポジトリの Submodule が無いブランチ(gh-pages)であれば可能</li>
</ul>
</li>
</ul>
<p>これ利用してできたのが<a href="https://iggg.github.io/lollipop/">このページ</a> 。</p>
<h2 id="おしまい"><a href="#おしまい" class="headerlink" title="おしまい"></a>おしまい</h2>
      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web/">Web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/GitHub/">GitHub</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="サムネイルを表示したい" style="display: none;">
    <div idplusp="サムネイルを表示したい">
      <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      
        <img s1c="/images/vs-thumbnail/before_after.png">
      
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2016-12-03T06:55:01.000Z"><a href="#">2016-12-03</a></time>
      
      
  
    <h1 class="depth title">サムネイルを表示したい</h1>
  

    </header>
    <div class="entry depth">
      
        <p>IGGG 名古屋支部のひげです。<br>(そろそろ、他の人にも書いてほしいなーと思ってます。)</p>
<p>たまにはラフな話題を。</p>
<h2 id="かなしい"><a href="#かなしい" class="headerlink" title="かなしい"></a>かなしい</h2><p>現在、<a href="http://www.adventar.org/calendars/1572" target="_blank" rel="noopener">IGGG アドベントカレンダー</a>をやっていて、このサイトをリンクさせたりしてたのですが…</p>
<p><img s1c="/images/vs-thumbnail/error_thumbnail.jpg" alt="サムネがうまく表示されない"></p>
<h2 id="結局"><a href="#結局" class="headerlink" title="結局"></a>結局</h2><p>今使ってるテーマこのテーマには <code>cover</code> というパラメータがあって、それを設定してあげればよかっただけ…</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">サムネイルを表示したい</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2016</span><span class="bullet">-12</span><span class="bullet">-03</span> <span class="number">15</span><span class="string">:55:01</span></span><br><span class="line"><span class="attr">tags:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">JavaScript</span></span><br><span class="line"><span class="attr">categories:</span> <span class="string">Web</span></span><br><span class="line"><span class="attr">cover:</span> <span class="string">"/images/vs-thumbnail/before_after.png"</span></span><br><span class="line"><span class="attr">photos:</span> <span class="string">"/images/vs-thumbnail/before_after.png"</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<p>デフォルトの設定がされてなかったのでエラーが出てた。<br>なので、<code>_config.yaml</code> に <code>cover: /IGGG_l.png</code> を追加した。</p>
<h2 id="試行錯誤"><a href="#試行錯誤" class="headerlink" title="試行錯誤"></a>試行錯誤</h2><p>こっからは無駄な試行錯誤…</p>
<p>サムネイル画像はそもそもどーやって決めてるのか分らなかったので、<a href="http://www.adventar.org/calendars/1137" target="_blank" rel="noopener">去年のカレンダー</a>を見て考えた。</p>
<p>なんとなく、一番最初の <code>img</code> タグをチェックしてるみたいだった(ホントはそれだけでは無かった)。</p>
<p>で、このサイトの最初の <code>img</code> タグの中身が空 <code>&lt;img s1c=&quot;&quot;&gt;</code> なのが問題なのかと思って(違う)、これを修正した。</p>
<h2 id="VS-空の-img-タグ"><a href="#VS-空の-img-タグ" class="headerlink" title="VS. 空の img タグ"></a>VS. 空の <code>img</code> タグ</h2><p>この原因はココ</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">"&lt;%= item.layout %&gt;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> (<span class="attr">item.photos</span>)&#123; %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%-</span> <span class="attr">partial</span>('<span class="attr">post</span>/<span class="attr">gallery</span>') %&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"post-content"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>本来、<code>photos</code> というパラメータが設定されてなければ書かれないはずなのだが、なぜか if 以下が実行される。<br>おそらく、デフォルトで食う文字が設定されている。</p>
<p>どこで設定されてるかは分らなかったので愚直に、</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">"&lt;%= item.layout %&gt;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> (<span class="attr">item.photos</span> &amp;&amp; <span class="attr">item.photos</span> != <span class="string">""</span>)&#123; %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%-</span> <span class="attr">partial</span>('<span class="attr">post</span>/<span class="attr">gallery</span>') %&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"post-content"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>とした。</p>
<p><strong><em>が直らない</em></strong> (そりゃそう)</p>
<p>ちなみに、このテーマは <code>photos</code> パラメータを設定すると、この記事の冒頭みたいな画像ギャラリーが出てくる。<br>知らなんだ。</p>
<h2 id="VS-相対パス"><a href="#VS-相対パス" class="headerlink" title="VS. 相対パス"></a>VS. 相対パス</h2><p>きっと原因は画像のパスが相対パスに違いない！と思って(違う)、絶対パスの <code>img</code> タグを HTML ファイルの冒頭に埋め込むことにした。</p>
<p><code>_config.yaml</code> に <code>url</code> として書いてあるのでそれと、<code>thumbnail</code> というパラメータを加えて</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"thumbnail"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&lt;%- config.url %&gt;&lt;%- item.thumbnail %&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>と頭に書いてみた。<br>CSS で <code>thumbnail</code> クラスの <code>display</code> パラメタを <code>none</code> にすれば画像は出てこない。</p>
<p>うまく、HTMLは埋め込めた。</p>
<p><strong><em>が直らない</em></strong> (そりゃそう)</p>
<h2 id="急がば回れ"><a href="#急がば回れ" class="headerlink" title="急がば回れ"></a>急がば回れ</h2><p>手詰まりになったので、 <strong><em>ちゃんと</em></strong> エラーのところを見ることにした(最初からそうしろ)。</p>
<p><code>https://iggg.github.io/2016/12/01/adventar-slack-bot/undefined</code> が無いと怒られている…</p>
<p>undefined … ?</p>
<p>HTML ソースコードを見ると</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:image"</span> <span class="attr">content</span>=<span class="string">"undefined"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>おまえかー</p>
<p>ということで、これを設定しているコードを調べてみると</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span>(<span class="attr">page.cover</span>) &#123; %&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:image"</span> <span class="attr">content</span>=<span class="string">"&lt;%= page.cover %&gt;"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125; <span class="attr">else</span> &#123; %&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:image"</span> <span class="attr">content</span>=<span class="string">"&lt;%= config.cover %&gt;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br></pre></td></tr></table></figure>

<p>あー、<code>cover</code> というパラメータがあるのね…<br>undefined が返ってたのは <code>_config.yaml</code> に <code>cover</code> が設定してなかったせいか…</p>
<p>前述したとおり、<code>_config.yaml</code> と記事の <code>cover</code> パラメータをちゃんと設定したら表示された。</p>
<p><img s1c="/images/vs-thumbnail/ok_thumbnail.jpg" alt></p>
<h2 id="おしまい"><a href="#おしまい" class="headerlink" title="おしまい"></a>おしまい</h2><p>こんなしょーもない事に4時間もかけてしまった…orz</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web/">Web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/JavaScript/">JavaScript</a>, <a href="/tags/HTML/">HTML</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="ADVENTARの更新を通知するSlackBOTを作ってみた" style="display: none;">
    <div idplusp="ADVENTARの更新を通知するSlackBOTを作ってみた">
      <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2016-11-30T15:00:00.000Z"><a href="#">2016-12-01</a></time>
      
      
  
    <h1 class="depth title">ADVENTAR の更新を通知する Slack BOT を作ってみた</h1>
  

    </header>
    <div class="entry depth">
      
        <p>IGGG 名古屋支部のひげです。</p>
<p>今年もとりあえずやってみた <a href="http://www.adventar.org/calendars/1572" target="_blank" rel="noopener">群馬大学電子計算機研究会 IGGG Advent Calendar 2016</a> 1日目の記事です。</p>
<p>1日目ということで、Advent Calendar に準じたネタを。</p>
<h2 id="いきさつ"><a href="#いきさつ" class="headerlink" title="いきさつ"></a>いきさつ</h2><p>去年、なんとなくやりはじめた Advent Calendar 。</p>
<p>その時の話。<br>とりあえずググってみた結果、まぁ、Qiita が人気ですよね。</p>
<p><img s1c="/images/adventar-slack-bot/google_advent_calendar.jpg" alt="Qiitaが人気ですよね"></p>
<p><a href="http://blog.qiita.com/post/152366526084/adventcalendar2016?utm_source=qiita&utm_medium=advent_calendar_jumbotron" target="_blank" rel="noopener">ここ</a> に簡単にまとめてある。</p>
<p>便利ではあるのだが、部活用の身内カレンダー(身内意外に書かれてもいいけど)を Qiita でやるのは憚られる。<br>で、次に使われてそうなのが <a href="http://www.adventar.org/" target="_blank" rel="noopener">ADVENTAR</a> 。</p>
<p>サークルとかでも使われた事例はある。</p>
<p><img s1c="/images/adventar-slack-bot/google_advent_circle.jpg" alt="サークルで使われてるのはADVENTAR"></p>
<p>で、問題はここから。</p>
<p>Qiita は RSS による通知機能がある。<br>なので、これを利用して、記事の追加や更新を Slack 等へと簡単に飛ばせる。<br>しかし、<strong>ADVENTAR にはない</strong> 。</p>
<h3 id="ADVENTAR-にはない"><a href="#ADVENTAR-にはない" class="headerlink" title="ADVENTAR にはない"></a>ADVENTAR にはない</h3><p>ということで、スクレイピングして飛ばすことにした。</p>
<p>あった。</p>
<p><img s1c="/images/adventar-slack-bot/google_slack_bot.jpg" alt="slack bot スクレイピング で検索"></p>
<h3 id="Google-Apps-Script"><a href="#Google-Apps-Script" class="headerlink" title="Google Apps Script"></a>Google Apps Script</h3><p>画像の通り、一番上にヒットしたのが <a href="https://developers.google.com/apps-script/" target="_blank" rel="noopener">Google Apps Script</a> (GAS) を用いたモノだった。</p>
<p>これは、JavaScript like な言語で書いたスクリプトを Google Drive に置いておくことで実行できるというモノ。<br>定期的に自動実行させたり、Webフックして実行したり、Google Apps を拡張したり、イロイロ使える。<br>なにより、タダで使えるのがうれしい。</p>
<p>まぁ詳しくはググってみてださい。</p>
<h2 id="Goal"><a href="#Goal" class="headerlink" title="Goal"></a>Goal</h2><p>今回の目的のために、作る GAS プログラムを3つのステップに分ける。</p>
<ol>
<li>ADVENTAR のサイトをWebスクレイピングして参加情報を取得くる</li>
<li>DBの代わりにスプレッドシートへ情報を保存・参照</li>
<li>前の情報との差分を取って更新情報を Slack に送信</li>
</ol>
<p>つまり、</p>
<ol>
<li>GAS によるWebスクレイピング</li>
<li>GAS によるスプレッドシートの操作</li>
<li>GAS による Slack へのメッセージ送受信</li>
</ol>
<p>を実現すればよい。</p>
<p>最終的なコードは<a href="https://gist.github.com/matsubara0507/dbe64f8bf319ab8b86d103a7cb04027d" target="_blank" rel="noopener">コチラ</a></p>
<h2 id="0-GAS-の準備"><a href="#0-GAS-の準備" class="headerlink" title="0. GAS の準備"></a>0. GAS の準備</h2><p>まずは GAS の準備から。</p>
<p>GASは、スプレッドシートやドキュメントと異なり、デフォルトではインストールされていません。<br>なので、機能を追加する必要があります。</p>
<p>Google Drive で <em>右クリック</em> し、一番下の <em>その他</em> から <em>アプリを追加</em> をクリックします。</p>
<p>そしたら、<code>google apps script</code> を検索してインストール(接続)。</p>
<p><img s1c="/images/adventar-slack-bot/google_drive_search_gas.jpg" alt="google apps script を検索"></p>
<p>あとは、スプレッドシートとかと同じように、Drive 内に作成できる。</p>
<p>専用のディレクトリを作成して、</p>
<ul>
<li>Bot 用の GAS ファイル</li>
<li>DB 用のスプレッドシート</li>
<li>Bot 用のアイコン画像</li>
</ul>
<p>を置いておいてください。</p>
<h2 id="1-GAS-によるWebスクレイピング"><a href="#1-GAS-によるWebスクレイピング" class="headerlink" title="1. GAS によるWebスクレイピング"></a>1. GAS によるWebスクレイピング</h2><p><img s1c="/images/adventar-slack-bot/google_gas_scraping.jpg" alt="まぁありますよね"></p>
<p>まぁ出てきますよね。</p>
<p>適当に参考にしながら作った。</p>
<h3 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h3><p>最初は以下のサイトを参考にしながら DOM Tree っぽく処理しようとしたのだが、<code>XmlService.parse</code> という関数は<a href="http://stackoverflow.com/questions/19455158/what-is-the-best-way-to-parse-html-in-google-apps-script" target="_blank" rel="noopener">正しい形式の HTML でないとパース出来ない</a> 。</p>
<ul>
<li>参考 : <a href="http://yoshiyuki-hirano.hatenablog.jp/entry/2015/10/01/231813" target="_blank" rel="noopener">［GAS］HTML/XMLをパースする - 技術のメモ帳</a></li>
</ul>
<p>よって、こっちの愚直にパースする方法をとることにした。</p>
<ul>
<li>参考 : <a href="http://qiita.com/fireowl11/items/e703e35073b600528e7c" target="_blank" rel="noopener">Google Apps ScriptでスクレイピングしてSlackに定期ポストするbotを瞬殺で作った - Qiita</a></li>
</ul>
<p><a href="http://www.kutil.org/2016/01/easy-data-scrapping-with-google-apps.html" target="_blank" rel="noopener">Parser</a> という外部ライブラリを用いる。</p>
<p>GAS に新しく外部ライブラリを追加するためには、以下の手順を行う必要がある。</p>
<ol>
<li>GAS ファイルを開いてツールバーの <em>リソース</em> をクリック</li>
<li><em>ライブラリ</em> をクリック</li>
<li><em>ライブラリを検索</em> にキーを入力して追加</li>
</ol>
<p>Parser のキーは <code>M1lugvAXKKtUxn_vdAG9JZleS6DrsjUUV</code> 。<br>バージョンは新しいのを選べばいいと思う(今回は 7 を使った)。</p>
<h3 id="テスト"><a href="#テスト" class="headerlink" title="テスト"></a>テスト</h3><p>例えば次のコードを書いて実行し、ログで確認。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postMessage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> url = <span class="string">'http://www.adventar.org/calendars/1137'</span></span><br><span class="line">  <span class="keyword">var</span> html = UrlFetchApp.fetch(url).getContentText();</span><br><span class="line">  <span class="keyword">var</span> doc = Parser.data(html)</span><br><span class="line">                  .from(<span class="string">'&lt;div class="mod-calendarHeader"'</span>)</span><br><span class="line">                  .to(<span class="string">'&lt;/div&gt;'</span>)</span><br><span class="line">                  .build()  </span><br><span class="line">  Logger.log(doc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ログはツールバーの <em>表示</em> から <em>ログ</em> をクリック。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[16-11-08 21:42:01:217 JST]  style=&quot;background: #8AC5D2&quot;&gt;&lt;div&gt;</span><br><span class="line">  &lt;h2&gt;群馬大学電子計算機研究会 IGGG Advent Calendar 2015&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;mod-calendarHeader-meta&quot;&gt;</span><br><span class="line">    &lt;p&gt;作成者：&lt;a href=&quot;/users/8528&quot; class=&quot;mod-userLink&quot;&gt;&lt;img s1c=&quot;http://www.gravatar.com/avatar/6491e85d52916cfb063372cec9edb6cc?size=23&amp;amp;d=mm&quot; width=&quot;23&quot; height=&quot;23&quot; class=&quot;mod-userIcon&quot; /&gt;&lt;span&gt;noob&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;登録状況：25/25人&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<p>もちろん、頭から探索しているだけなので、括弧やHTMLタグの対応を取ってはくれない。<br>つまり、同じタグが入れ子になっていると、最初の方の閉じタグを取ってきてしまう。<br>欲しい情報を望んだとおりに取得するためには工夫が必要だ。</p>
<h3 id="ADVENTAR-の場合"><a href="#ADVENTAR-の場合" class="headerlink" title="ADVENTAR の場合"></a>ADVENTAR の場合</h3><ul>
<li>参考： <a href="https://hotchpotchj37.wordpress.com/2015/12/05/adventer%E3%81%AE%E6%97%A5%E8%A8%98%E3%82%92slack%E3%81%AB%E6%B5%81%E3%81%97%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86%E4%B8%80%E4%BA%BA%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88/" target="_blank" rel="noopener">Adventerの日記をSlackに流してみよう一人プロジェクト - hotchpotch</a></li>
</ul>
<p>なるほど、下の方を取ればいいのか。</p>
<p>適当に書いてから共通部分を関数化して、最終的に次のようになった。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doPost</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> YEAR = <span class="string">'2016'</span>;</span><br><span class="line">  <span class="keyword">const</span> URL = <span class="string">'http://www.adventar.org/calendars/1572'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Scraping */</span></span><br><span class="line">  <span class="keyword">var</span> html = UrlFetchApp.fetch(URL).getContentText();</span><br><span class="line">  <span class="keyword">var</span> table = parseByTagAndClassId(html, <span class="string">'table'</span>, <span class="string">'mod-entryList'</span>);</span><br><span class="line">  <span class="comment">// Entry is [date, user name, comment, title, url]</span></span><br><span class="line">  <span class="keyword">var</span> entries = Parser.data(table)</span><br><span class="line">                      .from(<span class="string">'&lt;tr class="" id="list-'</span>)   </span><br><span class="line">                      .to(<span class="string">'&lt;/tr&gt;'</span>)</span><br><span class="line">                      .iterate()</span><br><span class="line">                      .map(<span class="function"><span class="keyword">function</span>(<span class="params">entry</span>)</span>&#123; <span class="keyword">return</span> parseEntry(entry, YEAR); &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseEntry</span>(<span class="params">entry, year</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> date = year + <span class="string">'/'</span> + parseByTagAndClassId(entry, <span class="string">'th'</span>, <span class="string">'mod-entryList-date'</span>);</span><br><span class="line">  <span class="keyword">var</span> user = parseByTag(parseByTagAndClassId(entry, <span class="string">'a'</span>, <span class="string">'mod-userLink'</span>), <span class="string">'span'</span>);</span><br><span class="line">  <span class="keyword">var</span> comment = parseByTagAndClassId(entry, <span class="string">'div'</span>, <span class="string">'mod-entryList-comment'</span>);</span><br><span class="line">  <span class="keyword">var</span> title = parseByTagAndClassId(entry, <span class="string">'div'</span>, <span class="string">'mod-entryList-title'</span>);</span><br><span class="line">  <span class="keyword">var</span> url = parseByTag(parseByTagAndClassId(entry, <span class="string">'div'</span>, <span class="string">'mod-entryList-url'</span>), <span class="string">'a'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [date,user,comment,title,url];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseByTagAndClassId</span>(<span class="params">data, tag, classId</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> temp = Parser.data(data)</span><br><span class="line">                   .from(<span class="string">'&lt;'</span> + tag + <span class="string">' class="'</span> + classId + <span class="string">'"'</span>)</span><br><span class="line">                   .to(<span class="string">'&lt;/'</span> + tag + <span class="string">'&gt;'</span>)</span><br><span class="line">                   .build();</span><br><span class="line">  <span class="keyword">return</span> temp.substring(temp.indexOf(<span class="string">'&gt;'</span>) + <span class="number">1</span>, temp.length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseByTag</span>(<span class="params">data, tag</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> temp = Parser.data(data)</span><br><span class="line">                   .from(<span class="string">'&lt;'</span> + tag)</span><br><span class="line">                   .to(<span class="string">'&lt;/'</span> + tag + <span class="string">'&gt;'</span>)</span><br><span class="line">                   .build();</span><br><span class="line">  <span class="keyword">return</span> temp.substring(temp.indexOf(<span class="string">'&gt;'</span>) + <span class="number">1</span>, temp.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>この Parser ライブラリでは、たぶん、行末までパースというのができないので、<code>temp.substring(temp.indexOf(&#39;&gt;&#39;) + 1, temp.length);</code> という感じに自分で書いた。</p>
<p>なんで、日付に年を加えてるのかと言うと、スプレッドシートに書き込むときに書いておかないと、今年の年を勝手に書き込むからだ。</p>
<h2 id="2-GAS-によるスプレッドシートの操作"><a href="#2-GAS-によるスプレッドシートの操作" class="headerlink" title="2. GAS によるスプレッドシートの操作"></a>2. GAS によるスプレッドシートの操作</h2><p>次に、スプレッドシートをDB代わりとして操作する。</p>
<ul>
<li>参考：<a href="http://tonari-it.com/gas-spreadsheet-speedup/" target="_blank" rel="noopener">Google Apps Scriptのスプレッドシート読み書きを格段に高速化をする方法</a></li>
</ul>
<p>と他にも Google の<a href="https://developers.google.com/apps-script/reference/spreadsheet/" target="_blank" rel="noopener">公式ドキュメント</a>を参考にした。</p>
<h3 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h3><p>実際にいじる前に必要な知識を一つ。</p>
<p>野生のコードを眺めてると、けっこう以下の行を見かける。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> prop = PropertiesService.getScriptProperties().getProperties();</span><br></pre></td></tr></table></figure>

<p>これは所謂、環境変数みたいのをとってきている。<br>なんらかのパスワードや ID を直接コードに書いておくのは望ましくないので、システムの中に書いておくのである。</p>
<p>正直はじめ、どーやって設定するかわからなかったがやっと見つけた。</p>
<p>ツールバーの <em>ファイル</em> から一番下の <em>プロジェクトのプロパティ</em> をクリック。<br>今回はスクリプト単位で設定したいので、スクリプトのプロパティに行を追加していく。</p>
<h3 id="スプレッドシートの準備"><a href="#スプレッドシートの準備" class="headerlink" title="スプレッドシートの準備"></a>スプレッドシートの準備</h3><p>予めスプレッドシートを作っておく。<br>スプレッドシートの名前は何でも良い。<br>シート名は <code>2015</code> とか <code>2016</code> などの <em>年</em> にする。</p>
<h3 id="スプレッドシートの読み取り"><a href="#スプレッドシートの読み取り" class="headerlink" title="スプレッドシートの読み取り"></a>スプレッドシートの読み取り</h3><p>読み取るためにはスプレッドシートの ID が必要だ。</p>
<p>開いたときのURL <code>docs.google.com/spreadsheets/d/XXXXX/edit#gid=0</code> の <code>XXXXX</code> という部分だ。<br>直書きしても良いが、前述した Properties に追加しておこう。</p>
<p>前のコードの <code>doPost</code> 関数を以下のように拡張する。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doPost</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Scraping */</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> DAYS = [ <span class="string">'12/01'</span>, <span class="string">'12/02'</span>, <span class="string">'12/03'</span>, <span class="string">'12/04'</span>, <span class="string">'12/05'</span></span><br><span class="line">               , <span class="string">'12/06'</span>, <span class="string">'12/07'</span>, <span class="string">'12/08'</span>, <span class="string">'12/09'</span>, <span class="string">'12/10'</span></span><br><span class="line">               , <span class="string">'12/11'</span>, <span class="string">'12/12'</span>, <span class="string">'12/13'</span>, <span class="string">'12/14'</span>, <span class="string">'12/15'</span></span><br><span class="line">               , <span class="string">'12/16'</span>, <span class="string">'12/17'</span>, <span class="string">'12/18'</span>, <span class="string">'12/19'</span>, <span class="string">'12/20'</span></span><br><span class="line">               , <span class="string">'12/21'</span>, <span class="string">'12/22'</span>, <span class="string">'12/23'</span>, <span class="string">'12/24'</span>, <span class="string">'12/25'</span></span><br><span class="line">               ];</span><br><span class="line">  <span class="keyword">const</span> COLUMN_NUM = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> prop = PropertiesService.getScriptProperties().getProperties();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Load Spread Sheet */</span></span><br><span class="line">  <span class="keyword">var</span> sheet = SpreadsheetApp.openById(prop.SPREAD_SHEET_ID).getSheetByName(YEAR);</span><br><span class="line">  <span class="keyword">var</span> oldEntries = sheet.getRange(<span class="number">1</span>, <span class="number">1</span>, DAYS.length, COLUMN_NUM).getValues();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>イロイロ考えた結果、日付を列挙しておいた方が楽だった。<br><code>getRange(a,b,c,d).getValues()</code> で <code>(a,b)</code> から <code>(c,d)</code> までの範囲を2次元配列として取得する。</p>
<p>直接アクセスする方法もあるが、必要な分だけ予め配列として読み取って、JavaScript として処理した方が速いらしい。<br>なのでそうしてる。</p>
<h3 id="スプレッドシートの更新"><a href="#スプレッドシートの更新" class="headerlink" title="スプレッドシートの更新"></a>スプレッドシートの更新</h3><p>スクレイピングして得た情報 <code>entries</code> から新しくスプレッドシートに書き込むデータを作成して、書き込む。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doPost</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Scraping */</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Load Spread Sheet */</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Update Spread Sheet */</span></span><br><span class="line">  <span class="keyword">var</span> newEntries = DAYS.map(<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> [YEAR + <span class="string">'/'</span> + d,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>]; &#125;);</span><br><span class="line">  entries.map(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">entry</span>)</span>&#123;</span><br><span class="line">      newEntries[getIndexByDate(newEntries, entry[<span class="number">0</span>])] = entry;</span><br><span class="line">    &#125;);</span><br><span class="line">  sheet.getRange(<span class="number">1</span>, <span class="number">1</span>, DAYS.length, COLUMN_NUM).setValues(newEntries);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIndexByDate</span>(<span class="params">entries, date</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; entries.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (entries[i][<span class="number">0</span>] == date)</span><br><span class="line">      <span class="keyword">return</span> i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>見ての通り、<code>getRange(a,b,c,d).setValues()</code> で書き込んでいる。</p>
<h2 id="3-GAS-による-Slack-へのメッセージ送受信"><a href="#3-GAS-による-Slack-へのメッセージ送受信" class="headerlink" title="3. GAS による Slack へのメッセージ送受信"></a>3. GAS による Slack へのメッセージ送受信</h2><p>最後にいよいよ Slack に Bot としてメッセージを飛ばす。</p>
<ul>
<li>参考 : <a href="https://reparade.com/log/tool/slackbot-gas.html" target="_blank" rel="noopener">非エンジニアがカップル専用アプリ「Slack」でGAS製Bot運用してみた - Webを楽しもう「リパレード」</a></li>
</ul>
<p>GAS 側にタイマーを仕掛けて、一日一回とってくるのも良いが、おそらく12月に入るまで更新は少ないだろうから、Slack の Advent Calendar チャネルで特定のキーワードを打ったら返ってくるようにする。</p>
<h3 id="Slack-の準備"><a href="#Slack-の準備" class="headerlink" title="Slack の準備"></a>Slack の準備</h3><p><em>Outgoing WebHooks</em> というインテグレーションを追加する。</p>
<p><a href="https://iggg.slack.com/apps" target="_blank" rel="noopener">ココ</a>にアクセスして <em>Outgoing WebHooks</em> と検索して追加。</p>
<p>設定項目のうち、重要なのは以下の4つ。</p>
<ul>
<li>Channel</li>
<li>Trigger Word(s)</li>
<li>URL(s)</li>
<li>Token</li>
</ul>
<p><code>Channel</code> で指定したチャネルで、 <code>Trigger Word(s)</code> で指定したワードから始まるメッセージを送信すると、<code>URL(s)</code> で指定したプログラムが動く、と言う感じ。<br><code>Token</code> は認証に使うので、<code>VERIFY_TOKEN</code> として GAS の Properties に追加しておく。</p>
<p>まぁ、認証は無くても良いが、GAS コードのURLが漏れると、実行されまくるので注意。</p>
<h3 id="Slack-API-for-GAS"><a href="#Slack-API-for-GAS" class="headerlink" title="Slack API for GAS"></a>Slack API for GAS</h3><p>作ってくれてた、ありがたい。</p>
<ul>
<li>参考 : <a href="http://qiita.com/soundTricker/items/43267609a870fc9c7453" target="_blank" rel="noopener">Slack BotをGASでいい感じで書くためのライブラリを作った - Qiita</a></li>
</ul>
<p>Parser ライブラリのときと同じように追加する。<br>キーは <code>M3W5Ut3Q39AaIwLquryEPMwV62A3znfOO</code> 。</p>
<p>Slack の API を使うには専用のトークンが必要なので、<a href="https://api.slack.com/web" target="_blank" rel="noopener">ココ</a>にアクセスして発行してもらう。<br>下の方にある <em>Generate test tokens</em> をクリックする。</p>
<p>生成されたトークンは <code>SLACK_API_TOKEN</code> として Properties に追加しておく。</p>
<h3 id="画像を利用"><a href="#画像を利用" class="headerlink" title="画像を利用"></a>画像を利用</h3><p>最初の方に用意した Bot 用のアイコンを利用するにはひと工夫が必要である。</p>
<ul>
<li>参考 : <a href="http://qiita.com/arribux/items/0394968fa318d9309d33" target="_blank" rel="noopener">Google Drive に保存した画像を直接呼び出せるURLの取得 - Qiita</a></li>
</ul>
<p>ドライブ中で画像を選択し、ツールバーの鎖のようなマークをクリックし、共有可能なリンクを取得する。<br>すると、<code>drive.google.com/open?id={id}</code>のようなフォーマットのURLを得るはずだ。</p>
<p>Webサイトなんかに埋め込むためには、このURLを <code>drive.google.com/uc?export=view&amp;id={id}</code> のように書き換えて使う。</p>
<p>なので、この <code>{id}</code> を <code>ICON_ID</code> として Properties に追加しておく。</p>
<h3 id="GAS-コード"><a href="#GAS-コード" class="headerlink" title="GAS コード"></a>GAS コード</h3><p>以下のように拡張する。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doPost</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> prop = PropertiesService.getScriptProperties().getProperties();</span><br><span class="line">  <span class="keyword">const</span> BOT_NAME = <span class="string">'Gunmer'</span>;</span><br><span class="line">  <span class="keyword">const</span> BOT_ICON = <span class="string">'http://drive.google.com/uc?export=view&amp;id='</span> + prop.ICON_ID;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prop.VERIFY_TOKEN != e.parameter.token) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"invalid token."</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Scraping */</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Load Spread Sheet */</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Update Spread Sheet */</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Post Message to Slack */</span></span><br><span class="line">  <span class="keyword">var</span> slackApp = SlackApp.create(prop.SLACK_API_TOKEN);</span><br><span class="line">  <span class="keyword">var</span> channelId = slackApp.channelsList().channels[<span class="number">0</span>].id;</span><br><span class="line">  <span class="keyword">var</span> option = &#123; <span class="attr">username</span> : BOT_NAME, <span class="attr">icon_url</span> : BOT_ICON &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> noUpdate = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; newEntries.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> text = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">switch</span>(diffEntry(newEntries[i], oldEntries[i])) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'updated'</span>:</span><br><span class="line">        text = <span class="string">'更新がありました！\n'</span> + makeMessage(newEntries[i]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'added_entry'</span>:</span><br><span class="line">        text = <span class="string">'新しい記事です！\n'</span> + makeMessage(newEntries[i]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'deleted_entry'</span>:</span><br><span class="line">        <span class="keyword">var</span> text = <span class="string">'キャンセルがありました...\n'</span></span><br><span class="line">                 + newEntries[i][<span class="number">0</span>] +<span class="string">' の記事です'</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (text != <span class="literal">null</span>) &#123;</span><br><span class="line">      slackApp.postMessage(prop.CHANNEL_ID, text, option);</span><br><span class="line">      noUpdate = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (noUpdate)</span><br><span class="line">    slackApp.postMessage(prop.CHANNEL_ID, <span class="string">"更新はありません"</span>, option);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeMessage</span>(<span class="params">entry</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> title = entry[<span class="number">3</span>];</span><br><span class="line">  <span class="keyword">if</span> (title == <span class="string">''</span>)</span><br><span class="line">    title = <span class="string">'link this!'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> message = entry[<span class="number">0</span>] + <span class="string">' : @'</span> + entry[<span class="number">1</span>] + <span class="string">'\n'</span></span><br><span class="line">              + entry[<span class="number">2</span>] + <span class="string">'\n'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> url = entry[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">if</span> (url != <span class="string">''</span>)</span><br><span class="line">   message = message + <span class="string">'&lt;'</span> + url + <span class="string">'|'</span> + title + <span class="string">'&gt;'</span> ;</span><br><span class="line">  <span class="keyword">return</span> message;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffEntry</span>(<span class="params">newEntry, oldEntry</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> equality = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; newEntry.length; i++)</span><br><span class="line">    equality = equality &amp;&amp; newEntry[i] == oldEntry[i];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (equality)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'no_update'</span>;</span><br><span class="line">  <span class="keyword">if</span> (isEntry(newEntry) &amp;&amp; isEntry(oldEntry))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'updated'</span>;</span><br><span class="line">  <span class="keyword">if</span> (isEntry(newEntry))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'added_entry'</span>;</span><br><span class="line">  <span class="keyword">if</span> (isEntry(oldEntry))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'deleted_entry'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">"undefined"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isEntry</span>(<span class="params">entry</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !(entry[<span class="number">1</span>] == <span class="string">''</span> || entry[<span class="number">1</span>] == <span class="literal">undefined</span> || entry[<span class="number">1</span>] == <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>順に説明する。</p>
<h4 id="認証"><a href="#認証" class="headerlink" title="認証"></a>認証</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (prop.VERIFY_TOKEN != e.parameter.token) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"invalid token."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>は言わずもがな前述した認証を行っている。<br>これで、自分たちの Slack からしか実行できない。</p>
<h4 id="メッセージの送信"><a href="#メッセージの送信" class="headerlink" title="メッセージの送信"></a>メッセージの送信</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> noUpdate = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; newEntries.length; i++) &#123;</span><br><span class="line">  <span class="keyword">var</span> text = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">switch</span>(diffEntry(newEntries[i], oldEntries[i])) &#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (text != <span class="literal">null</span>) &#123;</span><br><span class="line">    slackApp.postMessage(prop.CHANNEL_ID, text, option);</span><br><span class="line">    noUpdate = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (noUpdate)</span><br><span class="line">  slackApp.postMessage(prop.CHANNEL_ID, <span class="string">"更新はありません"</span>, option);</span><br></pre></td></tr></table></figure>

<p>で日付ごとに前との差分を取って、更新があればメッセージを送信している。<br>なにも更新が無ければ、最後に <code>更新はありません</code> というメッセージを送信している。</p>
<h4 id="差分をとる"><a href="#差分をとる" class="headerlink" title="差分をとる"></a>差分をとる</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffEntry</span>(<span class="params">newEntry, oldEntry</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> equality = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; newEntry.length; i++)</span><br><span class="line">    equality = equality &amp;&amp; newEntry[i] == oldEntry[i];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (equality)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'no_update'</span>;</span><br><span class="line">  <span class="keyword">if</span> (isEntry(newEntry) &amp;&amp; isEntry(oldEntry))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'updated'</span>;</span><br><span class="line">  <span class="keyword">if</span> (isEntry(newEntry))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'added_entry'</span>;</span><br><span class="line">  <span class="keyword">if</span> (isEntry(oldEntry))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'deleted_entry'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">"undefined"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>で、差分をとっている。<br>引数はどちらも、要素数を5と仮定した配列で、同じ日付のエントリに関する新旧情報の行を想定している。</p>
<p><code>for</code> 文を見ると、1から始まっている。<br>つまり、日付では比較していない。<br>理由は、スプレッドシートから読み込んだ旧情報の日付は <code>Date</code> 型として保存されており、文字列ではないので、比較できない(もとい必ず <code>false</code> が返る)。<br>なので、日付は同じと仮定して、比較している。</p>
<p>もし、</p>
<ul>
<li>更新が無ければ <code>no_update</code> という文字列を、</li>
<li>何らかの更新はある場合は <code>updated</code></li>
<li>記事が新しく追加された場合は <code>added_entry</code> を、</li>
<li>登録がキャンセルされている場合は <code>deleted_entry</code> を、</li>
<li>それ以外の場合は (ないけど) <code>undefined</code></li>
</ul>
<p>という文字列を返す。</p>
<p>数値でもよかったが可読性優先して文字列にした。</p>
<h4 id="メッセージの作成"><a href="#メッセージの作成" class="headerlink" title="メッセージの作成"></a>メッセージの作成</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeMessage</span>(<span class="params">entry</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> title = entry[<span class="number">3</span>];</span><br><span class="line">  <span class="keyword">if</span> (title == <span class="string">''</span>)</span><br><span class="line">    title = <span class="string">'link this!'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> message = entry[<span class="number">0</span>] + <span class="string">' : @'</span> + entry[<span class="number">1</span>] + <span class="string">'\n'</span></span><br><span class="line">              + entry[<span class="number">2</span>] + <span class="string">'\n'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> url = entry[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">if</span> (url != <span class="string">''</span>)</span><br><span class="line">    message = message + <span class="string">'&lt;'</span> + url + <span class="string">'|'</span> + title + <span class="string">'&gt;'</span> ;</span><br><span class="line">  <span class="keyword">return</span> message;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>[日付, ユーザー名, 記事に関するコメント, 記事のタイトル, 記事のURL]</code> の配列を受け取って文字列を返している。<br>この文字列が Slack へ送信される。</p>
<p>こんなメッセージを想定している。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2016/12/01 : @noob</span><br><span class="line">ADVENTAR の更新を Slack に通知させる Bot の作成</span><br></pre></td></tr></table></figure>

<p>ユーザー名に <code>@</code> を付けてるのは、同一の slack でのユーザー名であればリンクが付くかと期待したからだ。<br>結局付かなかったので、わざわざ <code>@</code> を付ける必要はないです。</p>
<p><code>message = message + &#39;&lt;&#39; + url + &#39;|&#39; + title + &#39;&gt;&#39; ;</code> でただURLを貼るのではなく、記事のタイトルにハイパーリンクを付けている。<br>ただし、記事によってはタイトルが無い場合があるので、2~4行目あたりで、タイトルがない場合は <code>link this!</code> という文字列を代用している。</p>
<h3 id="URLを指定する。"><a href="#URLを指定する。" class="headerlink" title="URLを指定する。"></a>URLを指定する。</h3><p><em>Slack の準備</em> のとこで説明した、URL(s) に指定するURLを取得する。</p>
<p>GAS のツールバーの <em>公開</em> から <em>ウェブアプリケーションとして導入</em> をクリック。</p>
<p>ここで、<em>アプリケーションにアクセスできるユーザー</em> を <em>全員（匿名ユーザーを含む）</em> にする必要がある。</p>
<p><em>導入</em> を押せば、URLが発行されるので、それを Slack のインテグレーションの Outgoing WebHooks の URL(s) にコピペする。</p>
<h2 id="4-コードの更新"><a href="#4-コードの更新" class="headerlink" title="4. コードの更新"></a>4. コードの更新</h2><p>最後に注意点。</p>
<p>コードを <del>更新するたびに必要かはわからないが、</del> (必要でした) 更新してもうまく実行されない場合は、もう一度、上記の手順で<br> <em>ウェブアプリケーションとして導入</em> をし、<em>プロジェクトのバージョン</em> をあげること。</p>
<p>ちなみに、仮にコードを更新するたびにバージョンをあげないといけないならば、ADVENTAR のURLや年が変わるたびに、あげないといけなくなる。<br>なので、最終的にはそれらを Properties にした。</p>
<h2 id="最終的に"><a href="#最終的に" class="headerlink" title="最終的に"></a>最終的に</h2><p>こんなかんじ</p>
<p><img s1c="/images/adventar-slack-bot/slack_bot.jpg" alt="ひとりさみしく"></p>
<h2 id="ついでに"><a href="#ついでに" class="headerlink" title="ついでに"></a>ついでに</h2><p>定期ポストしたい場合の手っ取り場合方法は、Bot をフックするためのメッセージを定期ポストする GAS コードの Slack Bot を作るのがよさそう。</p>
<p>コードはサクッとこんな感じ</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postMessage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> prop = PropertiesService.getScriptProperties().getProperties();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> BOT_NAME = <span class="string">'Gunmer BOT'</span>;</span><br><span class="line">  <span class="keyword">const</span> BOT_ICON = <span class="string">'http://drive.google.com/uc?export=view&amp;id='</span> + prop.ICON_ID;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Post Message to Slack */</span></span><br><span class="line">  <span class="keyword">var</span> slackApp = SlackApp.create(prop.SLACK_API_TOKEN);</span><br><span class="line">  <span class="keyword">var</span> option = &#123; <span class="attr">username</span> : BOT_NAME, <span class="attr">icon_url</span> : BOT_ICON &#125;;</span><br><span class="line"></span><br><span class="line">  slackApp.postMessage(prop.CHANNEL_ID, prop.MESSAGE, option);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CHANNEL_ID</code> は <code>#randome</code> とかで良い。<br>後は、GAS の設定で定期ポストをするだけ。</p>
<p><img s1c="/images/adventar-slack-bot/regular_post.jpg" alt="半日置きに定期ポストされるはず"></p>
<p><img s1c="/images/adventar-slack-bot/bot2bot.jpg" alt="Bot から Bot へ"></p>
<h2 id="追記"><a href="#追記" class="headerlink" title="追記"></a>追記</h2><p><img s1c="/images/adventar-slack-bot/req_hurry.jpg" alt="まかせろ"></p>
<p><a href="https://gist.github.com/matsubara0507/dbe64f8bf319ab8b86d103a7cb04027d#file-hurry-gs" target="_blank" rel="noopener">ほい</a></p>
<p><img s1c="/images/adventar-slack-bot/hurry.jpg" alt="できたぜ"></p>
<h2 id="おしまい"><a href="#おしまい" class="headerlink" title="おしまい"></a>おしまい</h2>
      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web/">Web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Slack/">Slack</a>, <a href="/tags/Bot/">Bot</a>, <a href="/tags/Google-Apps-Script/">Google Apps Script</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="ジオタグ解析アプリを作りました" style="display: none;">
    <div idplusp="ジオタグ解析アプリを作りました">
      <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2016-10-19T10:41:38.000Z"><a href="#">2016-10-19</a></time>
      
      
  
    <h1 class="depth title">ジオタグ解析アプリを作りました</h1>
  

    </header>
    <div class="entry depth">
      
        <p>IGGG 名古屋支部 支部長の ひげ です。<br>前回に続いて今回も群大理工学部の学園祭 <a href="http://guntohfes.com/" target="_blank" rel="noopener">群桐祭</a> のイベント、テクノドリームツアー用に作成した、ジオタグ解析アプリ、Where-is-This (名前は適当)について紹介したいと思います。</p>
<h2 id="Where-is-This-とは"><a href="#Where-is-This-とは" class="headerlink" title="Where-is-This とは"></a>Where-is-This とは</h2><p>画像を与えると、画像の位置情報を解析して、Google Map にマッピングした情報が返ってくるというモノです。</p>
<p><img s1c="/images/create-where-is-this/whereisthis.jpg" alt="送信前(左)と送信後(右)"></p>
<p>このプログラム自体は IGGG の期待の新星 <a href="https://github.com/atpons" target="_blank" rel="noopener">atpons</a> くんが10分くらいでこしらえてくれたものです(はやい)。<br>それを少しだけ修正して IGGG の <a href="https://dashboard.heroku.com/" target="_blank" rel="noopener">Heroku</a> にあげました。</p>
<p><a href="https://where-is-this.herokuapp.com/" target="_blank" rel="noopener">ココ</a> でアクセスできますが、無料枠なんでアクセスが集中すると止まると思います。</p>
<p>コンセプトとしては、来場者に画像には位置情報が含まれているということを知ってもらおうというモノでした。<br>画像には位置情報が含まれていて、撮った場所を特定することできる。<br>なので、外にあげるときは気を付けよう、という感じです(まぁ最近のSNSは位置情報の部分を消されちゃうらしいですが)。</p>
<p>実はこのアプリ、結局のところ本番では、運用する余裕が無くて(テクノってすごく忙しいんです)、用意はしたのですが、使いませんでした…(ごめんね atpons)</p>
<p>(いいわけではないですけど、ジオタグがどーのこーのと説明する時間が無くて)</p>
<h2 id="実装"><a href="#実装" class="headerlink" title="実装"></a>実装</h2><p>別に私が作ったわけじゃないけど、ドヤ顔で紹介します。</p>
<p>Ruby で書かれていて、なんとたったの15行しかない！<br>流石 Ruby ですねぇ。</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">"sinatra"</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">"exifr"</span></span><br><span class="line"></span><br><span class="line">get <span class="string">"/"</span> <span class="keyword">do</span></span><br><span class="line">  erb <span class="symbol">:index</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">post <span class="string">"/upload"</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> params[<span class="symbol">:file</span>]</span><br><span class="line">    file = EXIFR::JPEG.new(params[<span class="symbol">:file</span>][<span class="symbol">:tempfile</span>].path)</span><br><span class="line">    @latitude = file.gps.latitude</span><br><span class="line">    @longitude = file.gps.longitude</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  erb <span class="symbol">:upload</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Sinatra"><a href="#Sinatra" class="headerlink" title="Sinatra"></a>Sinatra</h3><p>2つのライブラリを使っています。<br>その一つが <a href="http://www.sinatrarb.com/" target="_blank" rel="noopener">Sinatra</a> です。<br>(公式サイト曰く) Sinatra は</p>
<blockquote>
<p>Sinatraは最小の労力でRubyによるWebアプリケーションを手早く作るためのDSL</p>
</blockquote>
<p>だそうです。<br>Model View Controller（MVC）に基づかない設計で作成されており、小さく、柔軟性があるプログラミングが可能となるよう意識されている、そうです(wikipedia より)。</p>
<p>正直、Sinatra の仕組みについてちっっっとも知りませんが、なんとなく読める通りに動くのでしょう(適当)。</p>
<p>流石 Ruby ですねぇ。</p>
<h3 id="Exifr"><a href="#Exifr" class="headerlink" title="Exifr"></a>Exifr</h3><p>もう一つが <a href="https://github.com/remvee/exifr" target="_blank" rel="noopener">Exifr</a> です。<br>察しの付く通り、Exif Reader ですね。<br>位置情報を含む画像の <a href="https://ja.wikipedia.org/wiki/Exchangeable_image_file_format" target="_blank" rel="noopener">Exif</a> をすごく簡単に取得するためのライブラリ群です。</p>
<p>上のコードの10-12行目が exifr に相当します。<br>正直、こっちも仕組みについてはちっっっとも知りませんが、なんとなく読める通りに動くのでしょう(適当)。</p>
<p>流石 Ruby ですねぇ(それしか言ってない)。</p>
<h3 id="修正"><a href="#修正" class="headerlink" title="修正"></a>修正</h3><p>Heroku にあげるために以下の点を修正しました。</p>
<ul>
<li>次のように書かれた config.ru を作成<ul>
<li>atpons のはローカルで動かすまでだったので無かった。</li>
<li>コレがないと Heroku とかではデプロイしても動かない(当たり前？)</li>
</ul>
</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'bundler'</span></span><br><span class="line">Bundler.<span class="keyword">require</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./app'</span></span><br><span class="line">run Sinatra::Application</span><br></pre></td></tr></table></figure>

<ul>
<li>Google Map の URL を HTTPs に変更<ul>
<li>Heroku の URL が HTTPs なので、変更しないと動かないみたい</li>
</ul>
</li>
</ul>
<h3 id="その他"><a href="#その他" class="headerlink" title="その他"></a>その他</h3><p>Heroku へのデプロイはググれば出てくる一般的な方法(<a href="http://please-sleep.cou929.nu/deploy-sinatra-app-to-heroku.html" target="_blank" rel="noopener">こういうのとか</a>)でできました。<br>ただ、Heroku のリモートリポジトリと、GitHub のリモートリポジトリで、そこら辺の知識なくて、ごっちゃんになり苦労しました。</p>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>正直、これ以上書くことないです。<br>すごく簡単なんで。</p>
<p>流石 Ruby ですねぇ。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Application/">Application</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Heroku/">Heroku</a>, <a href="/tags/Ruby/">Ruby</a>, <a href="/tags/guntohfes/">guntohfes</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="AnaQRamを作りました" style="display: none;">
    <div idplusp="AnaQRamを作りました">
      <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2016-10-18T04:58:04.000Z"><a href="#">2016-10-18</a></time>
      
      
  
    <h1 class="depth title">AnaQRam を作りました</h1>
  

    </header>
    <div class="entry depth">
      
        <p>IGGG 名古屋支部 支部長の ひげ です。<br>今回は群大理工学部の学園祭 <a href="http://guntohfes.com/" target="_blank" rel="noopener">群桐祭</a> のイベント、テクノドリームツアー用に作成した、AnaQRam という Android アプリについて紹介したいと思います。</p>
<h2 id="AnaQRam-とは"><a href="#AnaQRam-とは" class="headerlink" title="AnaQRam とは"></a>AnaQRam とは</h2><p>宝探しとパズルをコンセプトにした、すごく簡易的なゲームです。<br>テクノドリームツアーは小学校低学年前後を対象にした科学体験イベントであり、それ用に作成したので、ゲーマーにはかなり退屈なゲームです。</p>
<p>遊び方は簡単で、まずQRコードをスキャンしまくって、パズルのピースとなる文字を集めます。<br>文字を見つけると <code>？</code> が対応する文字に変わります。</p>
<p><img s1c="/images/create-anaqram/anaqram1.gif" alt="文字を集めている"></p>
<p>文字を集めきったら次はパズルです。<br>集めた文字を並び替えて正しい文字列を作ります(アナグラム)。</p>
<p><img s1c="/images/create-anaqram/anaqram2.gif" alt="文字を並び替えている"></p>
<p>ゲームとしてはこんな感じです。</p>
<p>このQRコードを色んな所に隠せば、結構面白いかなぁと考えて作りました。</p>
<p>(本番ではスペース的に隠す余裕無くて、全部壁一面に貼られてしまったが…)</p>
<h2 id="実装"><a href="#実装" class="headerlink" title="実装"></a>実装</h2><p>他の IGGG メンバもコードを読めるように(誰も読んでないだろうけど)、ベーシックに Java と <a href="https://developer.android.com/studio/" target="_blank" rel="noopener">Android Studio</a> を使って作成しました。</p>
<p>コードは全て、<a href="https://github.com/matsubara0507/AnaQRam" target="_blank" rel="noopener">私のリポジトリ</a> に公開してあります。</p>
<p>全体的に、WEB上を検索して得た機能をどんどんマッシュアップしていった感じです。</p>
<p>(そもそも、自分で一から Android アプリを作ったのは始めて)</p>
<h3 id="端末の環境"><a href="#端末の環境" class="headerlink" title="端末の環境"></a>端末の環境</h3><p>端末は群大情報科で借りた、Nexus7 を使うのですが、Android のバージョンが 5.1.1 (Lollipop) だったので、それに合わせて開発しました。</p>
<p>(そのため Java8 が使えない…)</p>
<p>また、Google Play 開発サービスの <a href="https://developers.google.com/vision/" target="_blank" rel="noopener">Mobile Vision API</a> のQRコードを読み取るライブラリを使ったため、開発サービスのバージョンを 7.8 以上にする必要があります。</p>
<p>(このため、前日に端末の開発サービスのバージョンを全て挙げる作業が…)</p>
<p>他にも日本語入力するのに Google 日本語キーボードや端末の言語を日本語にする必要があります( <del>ゲーム自体は日本語でなくても動作するので、英語のみでアナグラムをするのであれば必要ない</del> 伏字の <code>？</code> が全角なのでダメだ、あとで直します…)。</p>
<h3 id="開発環境"><a href="#開発環境" class="headerlink" title="開発環境"></a>開発環境</h3><ul>
<li>Windows 10 Home</li>
<li>Android SDK Build-tools 24.0.2<ul>
<li>min SDK 21</li>
</ul>
</li>
<li>Android Studio 2.2</li>
</ul>
<h3 id="QRコードを読み取る"><a href="#QRコードを読み取る" class="headerlink" title="QRコードを読み取る"></a>QRコードを読み取る</h3><p>以下のWEBサイトを参考にしました。</p>
<ul>
<li><a href="https://code.tutsplus.com/tutorials/reading-qr-codes-using-the-mobile-vision-api--cms-24680" target="_blank" rel="noopener">Reading QR Codes Using the Mobile Vision API</a></li>
</ul>
<p>上述したとおり、Google の Mobile Vision API を利用しています。</p>
<p>QRコードを読み取る他の方法として、サードパーティ製の <a href="https://github.com/zxing/zxing" target="_blank" rel="noopener">ZXing</a> というライブラリもありましたが、なんとなく純正のやつを使ってみました。</p>
<p>記事の通りに書いていったらうまく動きました。<br>特に難しいことしておらず、<code>SurfaceView</code> にカメラを貼り付けて、読み取った画像を API で解析し、見つけた時の動作を後から与えているだけです。<br>API の仕組み等までは流石に知らないので説明しません。</p>
<p>精度はかなり良く、画面に複数のQRコードが写っていても、すぐに全部読み取ってくれます。<br>QRコードは小さくても良く、ピントさへ合えば問題なさげです。</p>
<p>ただ、API のせいか、実機デバッグに使っていた私の端末のせいかわからないのですが、使ってると時々カメラが真っ暗になって映らなくなってしまいます…(再起動すればまた映りますが…)</p>
<h3 id="中の仕組み"><a href="#中の仕組み" class="headerlink" title="中の仕組み"></a>中の仕組み</h3><p><img s1c="/images/create-anaqram/anaqramDesign.jpg" alt="超概略図"></p>
<p>文字は <code>CharBox</code> という <code>char</code> 型のラッパークラスを使って管理しています。<br>既に見つけたかどうかの <code>flag</code> も <code>boolean</code> 型で持っていて、これの真偽で <code>toString</code> した時の返す文字列が変わります(もちろん <code>false</code> のときが <code>?</code>)。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CharBox</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">char</span> value;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> flag;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">char</span> defaultValue = <span class="string">'？'</span>;</span><br><span class="line"></span><br><span class="line">    CharBox(<span class="keyword">char</span> c) &#123; ... &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setFlag</span><span class="params">()</span> </span>&#123; ... &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">resetFlag</span><span class="params">()</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(flag ? value : defaultValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AnaQRam の内部では答えの文字列を決めると、それを <code>CharBox</code> の配列へと変換します。</p>
<p>QRコードは実は、文字では無くただの <strong>数字を表していて、スキャンすると対応する <code>CharBox</code> 配列のインデックスにアクセス</strong> して、フラグを立てます。<br>こうすることで、<strong>アプリ内で答えの文字列を変更しても、貼るQRコードを変更しなくても良い</strong> ようにしてます。</p>
<p>もちろん、インデックス以上の数字を読み取っても例外を投げて落ちたりしません。<br>数字以外の場合は、「QRコードが対応してないよ！」的なメッセージを出します。<br>数字の場合は、インデックスに使う前に、答えの文字列長で Modulo (余りを求める演算) を取ります。<br>そうすることで、文字列長以上の数字が来ても、問題なく扱うことができます(文字列長に合わせて貼りなおす必要がない、もちろん最大に合わせる必要はあるが)。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">String <span class="title">displayChar</span><span class="params">(String qrText)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 剰余を取って文字数未満の数字が出ても大丈夫にしている</span></span><br><span class="line">        <span class="keyword">int</span> index = Integer.valueOf(qrText) % charBoxes.length;</span><br><span class="line">        charBoxes[index].setFlag();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"「"</span> + charBoxes[index] + <span class="string">"」をみつけた！v(≧∇≦)v"</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        <span class="comment">// qrText が数字以外の場合</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ちがうQRコードだよ！(*￣∀￣)\"b\" ﾁｯﾁｯﾁｯ"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>画面への表示はタダのボタンになっています。<br>このボタン配列に <code>CharBox</code> 配列をマッピングします。<br>ボタンを押して入れ替えるときは、このマッピングを変えています。</p>
<p>正解かどうかを確かめるときは、ボタン配列から文字列を生成(つまり、伏字が混ぜっていれば <code>り？ご</code> となる)して、答えの文字列との <code>equals</code> を取ります。</p>
<h3 id="その他の機能"><a href="#その他の機能" class="headerlink" title="その他の機能"></a>その他の機能</h3><p>他にも、トーストを用いたクリアメッセージ表示や、タイマー機能の追加などをしています。<br>参考文献は全てREADMEに書いてあるので、見てください。</p>
<h2 id="困った点"><a href="#困った点" class="headerlink" title="困った点"></a>困った点</h2><p>そもそも Android をあまりやってなかったので、初めの方はデバッグで苦労しました。<br>Android Studio にはブレークポイントや逐次実行もあるので慣れてしまえばどうとでもなりますが、やっぱり普段関数型を使ってる身としては、例外ばっかのデバッグはつらいですね…</p>
<p>あとは、画面の回転時にビューを再構築してしまう仕様に苦労しました。<br>再構築してしまうため、履歴がリセット、見つけた文字が伏字に戻ってしまう。<br>結局、一番簡単な方法で落ち着いたのですが、その代わりにカメラが回転してくれないので、実質回転不可です。<br>今後直していきたいですね。</p>
<h2 id="今後"><a href="#今後" class="headerlink" title="今後"></a>今後</h2><p>個人的には気にっているので、機能を追加・修正していこうと思ってます。<br>ただ、単体では面白くない(QRコードがないとダメ、つまりイベントとかでしか使えない)なので、Play Store にはあげないと思います。</p>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>端末にインストールするのにそこそこ苦労したんですが、他に用意した Unity のゲームは難なくインストールできててスゲーって思いました。<br>今度は Unity もいじってみたいですねぇ。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Application/">Application</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/guntohfes/">guntohfes</a>, <a href="/tags/Android/">Android</a>, <a href="/tags/Java/">Java</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="GitHubPages+Hexo+CircleCI+Herokuで自動デプロイ管理" style="display: none;">
    <div idplusp="GitHubPages+Hexo+CircleCI+Herokuで自動デプロイ管理">
      <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2016-05-30T14:38:49.000Z"><a href="#">2016-05-30</a></time>
      
      
  
    <h1 class="depth title">GitHub Pages + Hexo + CircleCI + Heroku で自動デプロイ管理</h1>
  

    </header>
    <div class="entry depth">
      
        <p>IGGG 名古屋支部 支部長の ひげ です。<br>今回も寂しく孤軍奮闘しております。<br>嘘です。<br>Slack 使って騒いでるんで一人ではないです。<br>早速プルリクエストあったし。</p>
<p>さて、今回は前言通り デプロイの自動化 を行いました。</p>
<p>実は GitHub Pages 利用する少し前に Slack 上で CI (継続的インテグレーション) について(ほんの少しだけ)話していて、<br>GitHub Pages の話題が上がったときに、CI の簡単な例がだよ、といつものお意見番が下記の記事を教えてくれました。</p>
<ul>
<li><a href="http://blog.otakumode.com/2014/08/08/Blogging-with-hexoio/" target="_blank" rel="noopener">チームブログをGitHubとHexoではじめよう！</a></li>
</ul>
<p>早速、 <del>パクッて</del> 参考にしてみました！</p>
<h2 id="Goal"><a href="#Goal" class="headerlink" title="Goal"></a>Goal</h2><p>結局何をしたいのかというと</p>
<ol>
<li>GitHub に大本である source ブランチを <strong>プッシュしたら自動でデプロイ</strong> してほしい</li>
<li>source ブランチ以外をプッシュした場合は <strong>ステージ環境に自動でデプロイ</strong> してほしい</li>
</ol>
<p>の2点です。<br>前者の理由は単純に手間を省くためです。<br>後者の理由は、新しい記事の精査を実行環境のない人でも行えるようにです。</p>
<p>(まぁ本音は単純に私が面白そうだと思ったからですけど)</p>
<p>そのために、GitHub へのプッシュに対して自動でデプロイしてくれるサービスとステージング環境が必要です。<br>前述した記事を参考にして、前者には <a href="https://circleci.com/" target="_blank" rel="noopener">CircleCI</a> を、後者には <a href="https://dashboard.heroku.com/" target="_blank" rel="noopener">Heroku</a> を利用したいと思います。  </p>
<p><strong>追記 (2016.6.2)</strong><br>ブランチの構成を変更しました。<br>例の相談役さんがステージング環境へのデプロイが競合しないようにステージング用のブランチを作った方が良いと助言してくれました。<br>なので</p>
<ul>
<li><strong>source</strong> master へ自動デプロイされるブランチ</li>
<li><strong>staging</strong> ステージング環境へ自動デプロイされるブランチ</li>
<li>それ以外のブランチはデプロイされない</li>
</ul>
<p>の構成に変更しました。<br>変更箇所は後述します。</p>
<h2 id="CircleCI"><a href="#CircleCI" class="headerlink" title="CircleCI"></a>CircleCI</h2><p>CircleCI は GitHub と連携して実行やテスト、デプロイなどを自動で行ってくれるサービスです。<br>このように、プログラミングに付随する様々な作業を自動化して継続的に管理する事を <strong>継続的インテグレーション</strong> と言います(たぶん)。<br>私はコノコトについてちゃんと勉強してないので、後は自分で調べてください(おい)</p>
<p>継続的インテグレーションをサポートするサービスは他にもイロイロあります。<br>CircleCI の特徴については以下のスライドでも見てください(おい)</p>
<ul>
<li><a href="http://www.slideshare.net/mogproject/circleci-51253223" target="_blank" rel="noopener">はじめての CircleCI</a></li>
</ul>
<p>では順に準備を行っていきます。</p>
<h2 id="CircleCI-の準備"><a href="#CircleCI-の準備" class="headerlink" title="CircleCI の準備"></a>CircleCI の準備</h2><p>CircleCI は既存の GitHub と認証を行います。<br>今回は、私のアカウントを使う事にします。</p>
<p>まず、<a href="https://circleci.com/" target="_blank" rel="noopener">公式サイト</a> に行きます。<br>後は、Sign up のところを押して、ポチポチしていくだけです(ざっくり)。</p>
<p>登録が完了したら、GitHub の方で認証を行います(たぶん)。<br><a href="https://github.com/integrations/circle-ci" target="_blank" rel="noopener">ココ</a>に行って Add to GitHub を押せばいいはずです。</p>
<p>これで、CircleCI のダッシュボードに GitHub のリポジトリが出てくるはずです。</p>
<p>出てきたら、CircleCI で管理したいリポジトリを選択します。</p>
<p>選択すると早速リポジトリのビルドを始めようとしますが、設定ファイルを入れてないのでコケるはずです。</p>
<h2 id="Heroku"><a href="#Heroku" class="headerlink" title="Heroku"></a>Heroku</h2><p>いったんハナシを脱線して Heroku について簡単に説明します。<br>Heroku とは <strong>AWSのIaaS上に構築されたPaaSで、Gitでデプロイできたり、Webアプリの開発から公開までがミラクルスペシャルウルトラスーパーメガトン簡単にできるプラットフォーム</strong> だそうです。<br>次のサイトに書いてありました。<br>残りは参照してください(おい)</p>
<ul>
<li><a href="https://gist.github.com/konitter/5370904" target="_blank" rel="noopener">Heroku導入メモ - GitHub</a></li>
</ul>
<p>と言っても、上記のサイトの情報は少し古く、料金体系が結構変わって、無料枠の容量の上限が 300MB に増えていたり、無料枠では日に6時間はスリープさせないといけなかったり、になっています。<br>そのうえ、また無料枠を変更するみたいです。</p>
<p>まぁ、詳しくは公式サイトを読めばいいんじゃないかな…(おいおい)</p>
<h2 id="Heroku-の準備"><a href="#Heroku-の準備" class="headerlink" title="Heroku の準備"></a>Heroku の準備</h2><p>イロイロと料金体系が変わっているみたいですが、(たぶん)ステージング環境としてならまだ使えそうなんで使っていきます。</p>
<p>まず、<a href="https://dashboard.heroku.com/" target="_blank" rel="noopener">公式サイト</a> にアクセスして、Sign Up します。<br><strong>Pick your primary development language</strong> は単純によく使うプログラミングを聞いてるだけです。</p>
<p>次に App を作成します。<br><a href="https://toolbelt.heroku.com/" target="_blank" rel="noopener">Heroku Toolkit</a> をインストールして、下記コマンドを実行しても良いですし、ダッシュボードからでもできるはずです。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ heroku login</span><br><span class="line">$ heroku create</span><br></pre></td></tr></table></figure>

<h2 id="CircleCI-と-Heroku-を連携させる"><a href="#CircleCI-と-Heroku-を連携させる" class="headerlink" title="CircleCI と Heroku を連携させる"></a>CircleCI と Heroku を連携させる</h2><p><a href="https://circleci.com/docs/continuous-deployment-with-heroku/" target="_blank" rel="noopener">公式サイト</a> の指示に従って、CircleCI から Heroku を認証させます。</p>
<p>CircleCI のダッシュボードでリポジトリ固有のページに移動します。<br>そしたら、右上の <code>Project Settings</code> をクリックします。<br>次に、左下の方にある <code>Heroku Deployment</code> をクリックします。</p>
<ul>
<li><strong>Step 1</strong><br>CircleCI アカウントの<a href="https://circleci.com/account/heroku" target="_blank" rel="noopener">コノページ</a>に Heroku API Key を登録します。<br>Heroku API Key は <a href="https://dashboard-preview.heroku.com/account" target="_blank" rel="noopener">Heroku のアカウントページ</a> の下の方にあります。</li>
<li><strong>Strp 2</strong><br>Heroku と SSH 認証を設定します。<br>とはいっても、Heroku Deployment の Step 2 のところをクリックするだけで出来てしまいます。</li>
</ul>
<p>後は、リポジトリに circle.yml という設定ファイルを置くだけです。</p>
<h2 id="circle-yml-の作成"><a href="#circle-yml-の作成" class="headerlink" title="circle.yml の作成"></a>circle.yml の作成</h2><p>最初に紹介したサイトを参考にして、GitHub Pages 用のリポジトリに以下のような設定ファイル(circle.yml)を加えました。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">machine:</span></span><br><span class="line"><span class="attr">  timezone:</span> <span class="string">Asia/Tokyo</span></span><br><span class="line"><span class="attr">  node:</span></span><br><span class="line"><span class="attr">    version:</span> <span class="number">4.4</span><span class="number">.5</span></span><br><span class="line"><span class="attr">deployment:</span></span><br><span class="line"><span class="attr">  production:</span></span><br><span class="line"><span class="attr">    branch:</span> <span class="string">source</span></span><br><span class="line"><span class="attr">    commands:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.name</span> <span class="string">"IGGGorg"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.email</span> <span class="string">"contact@iggg.org"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">submodule</span> <span class="string">init</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">submodule</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./node_modules/.bin/hexo</span> <span class="string">clean</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./node_modules/.bin/hexo</span> <span class="string">generate</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./node_modules/.bin/hexo</span> <span class="string">deploy</span></span><br><span class="line"><span class="attr">  staging:</span></span><br><span class="line"><span class="attr">    branch:</span> <span class="string">/.*/</span></span><br><span class="line"><span class="attr">    commands:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.name</span> <span class="string">"IGGGorg"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.email</span> <span class="string">"contcat@iggg.org"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./node_modules/.bin/hexo</span> <span class="string">clean</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./node_modules/.bin/hexo</span> <span class="string">generate</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./node_modules/.bin/hexo</span> <span class="string">deploy</span> <span class="bullet">--branch</span> <span class="string">$CIRCLE_BRANCH</span> <span class="bullet">--config</span> <span class="string">_staging_config.yml</span></span><br><span class="line"><span class="attr">general:</span></span><br><span class="line"><span class="attr">  branches:</span></span><br><span class="line"><span class="attr">    ignore:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line"><span class="attr">  override:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">"test"</span></span><br></pre></td></tr></table></figure>

<p>source ブランチか、それ以外かでデプロイ内容を分けています。<br>但し、ページ自体のブランチである、master ブランチは無視するように下の方に書いてあります。<br><code>hexo deploy --branch $CIRCLE_BRANCH --config _staging_config.yml</code> とすることで、デプロイの際に参照する Hexo の設定ファイルを <code>_staging_config.yml</code> に指定できます。</p>
<p><strong>追記 (2016.6.2)</strong><br>前述したとおり、ブランチ構成を変更したので、上記の circle.yml を一部書き換えました。</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">staging:</span><br><span class="line"><span class="deletion">-     branch: /.*/</span></span><br><span class="line"><span class="addition">+     branch: staging</span></span><br><span class="line">  commands:</span><br></pre></td></tr></table></figure>

<p>追記終わり。</p>
<p>次に、その設定ファイル(<code>_staging_config.yml</code>)を加えましょう。<br>またもや、例のサイトを参考にして、<code>deployment</code> のところを次のように書き換えます。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/deployment.html</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">heroku</span></span><br><span class="line"><span class="attr">  repo:</span> <span class="string">git@heroku.com:&lt;作成したAPP名&gt;.git</span></span><br></pre></td></tr></table></figure>

<p>更に、上の方の <code>url:</code> も書き換えておきましょう。  </p>
<h2 id="package-json-ファイルの書き換え"><a href="#package-json-ファイルの書き換え" class="headerlink" title="package.json ファイルの書き換え"></a>package.json ファイルの書き換え</h2><p>最後に、<code>package.json</code> を書き換えます。</p>
<p>Hexo で Heroku にデプロイするには専用のパッケージ、<code>hexo-deployer-heroku</code> が必要です。<br><code>package.json</code> の <code>&quot;dependencies&quot;:</code> に書き加えましょう。</p>
<h2 id="push"><a href="#push" class="headerlink" title="push !"></a>push !</h2><p>後はプッシュするだけのはずです ！</p>
<p><strong>追記 (2016.6.2)</strong><br>もし、source ブランチの自動デプロイで ssh 鍵について怒られた場合は以下のページを参考にしてください。</p>
<ul>
<li><a href="https://circleci.com/docs/adding-read-write-deployment-key/" target="_blank" rel="noopener">Adding read/write deployment key - CircleCI</a></li>
</ul>
<p>新しい ssh 鍵を生成して、GitHub に公開鍵を、CircleCI に秘密鍵を登録すればいいはずです。<br>ちなみに、鍵を生成する際にパスフレーズを付けないようにと注意書きされてます。</p>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>実は、こういうサービスいじるの初めてでして、まぁまぁてこずりました(笑)</p>
<p>IGGG のみんな、つかってくれるとうれしいなぁ。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web/">Web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Heroku/">Heroku</a>, <a href="/tags/GitHub/">GitHub</a>, <a href="/tags/CircleCI/">CircleCI</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>



  <div class="animated fadeIn" idplus="GithubPagesはじめました" style="display: none;">
    <div idplusp="GithubPagesはじめました">
      <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2016-05-28T17:03:19.000Z"><a href="#">2016-05-29</a></time>
      
      
  
    <h1 class="depth title">Github Pages はじめました</h1>
  

    </header>
    <div class="entry depth">
      
        <p>2代目IGGG会長の ひげ です。<br>既にグンマーですらない私ですが、相も変わらず IGGG を盛り上げようと日々奮闘しています。<br>嘘です。<br>暇なだけです。</p>
<p>見ての通り、IGGG で Github Pages を始めることにしました。<br>主な用途は技術寄りな話題を書いていこうかなーっとゆるく考えています。</p>
<p>今回は、このページができるまでの私の奮闘を軽く書いておこうかなと思います。</p>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>そもそもなんで Github Pages しようかとなったかってハナシなんですけど、</p>
<ul>
<li>新学期(既に5月末)になって、</li>
<li>IGGG もやっとこさ新メンバーが増えてきて、</li>
<li>彼ら用に Slack の使い方をまとめたものを作ろうとなって、</li>
<li>最初は Gist でやろうとしたんだけど、</li>
<li>記述量が多かったので、いっそのコト Github Pages でいいんじゃないというハナシが出たので、</li>
<li>面白そうなので 勝手にひげがやっちゃった</li>
</ul>
<p>というハナシです。</p>
<h2 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h2><p>IGGG のアカウントはあったので、適当なページを参考にしてリポジトリを作成しました。</p>
<p>ゴリゴリと HTML 書くのはつらそうなので、Markdown で書いて変換してデプロイしたいですよね？</p>
<p>問題は変換するのに何を使うか。<br>一番使われてるのは <a href="https://jekyllrb.com/" target="_blank" rel="noopener">Jekyll</a> という <a href="http://rubyonrails.org/" target="_blank" rel="noopener">Rails</a> のライブラリ。<br><del>しかし、うちはどちらかというと Pythonista の方が多く、Rails なんか使った暁には刺されかねません。</del><br>しかし、Rails の環境を構築するのはめんどうなので(特にWindows)、誰でも環境構築しやすいやつがいいですよね＾＾<br>そこで、<a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> という <a href="https://nodejs.org/en/" target="_blank" rel="noopener">Node.js</a> のライブラリを使うことにしました！</p>
<p>Node.js のインストールは<a href="https://nodejs.org/en/" target="_blank" rel="noopener">公式サイト</a>のインストーラーなんかでおしまい。</p>
<p>Hexoは</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ npm install hexo</span><br></pre></td></tr></table></figure>

<p>でおしまい。</p>
<p>とっても楽ですね＾＾</p>
<h2 id="デザインを変更"><a href="#デザインを変更" class="headerlink" title="デザインを変更"></a>デザインを変更</h2><p>SSH でひと悶着あったのち、なんとかデプロイ成功。</p>
<p>で、まずはデザイン変えたくなりますよね？</p>
<p><a href="https://github.com/hexojs/hexo/wiki/Themes" target="_blank" rel="noopener">ココ</a>のテーマ一覧を眺めながら、<a href="https://github.com/heruoxin/hexo-persona-color" target="_blank" rel="noopener">いいの</a>を見つけたのまでは良かった。</p>
<p>しかし、このテーマ(今実際に使ってるやつ)は Hexo の新しいバージョンに対応して無いせいで、コンパイルできない(<a href="https://github.com/hexojs/hexo/issues/1517" target="_blank" rel="noopener">コレ</a>と同じ)。<br>たまたま、<a href="https://github.com/shulhi/hexo-theme-damnclean/commit/4af21ddaa474bbf0f6dfdef206239cae55569c33" target="_blank" rel="noopener">別のテーマで同じエラーに対し Fix してるコミットログ</a>があったので、参考にして直したところうまくいった！</p>
<p>このテーマ、くるくるアイコンが回るのがいいよね(小並感)</p>
<h2 id="シンタックスハイライト"><a href="#シンタックスハイライト" class="headerlink" title="シンタックスハイライト"></a>シンタックスハイライト</h2><p>このテーマのシンタックスハイライトが残念だったので書き換えた。<br>まぁ書き換えた結果が良いかと言われると怪しんだけど…</p>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>今後は、このサイトで、皆で、Markdown でサクッと更新していきたいですね、イロイロと。</p>
<p>無駄に、継続的インテグレーションとか入れて遊んでみたいなーっとか思ってる。</p>
<h2 id="ちなみに、"><a href="#ちなみに、" class="headerlink" title="ちなみに、"></a>ちなみに、</h2><p>昨日でちょうど IGGG 2周年です！<br>やったぜ！</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Web/">Web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Node-js/">Node.js</a>, <a href="/tags/GitHub/">GitHub</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



      
    </div>
  </div>





<div id="myCanvasContainer" class="animated fadeIn" style="display: none;">
 <canvas width="500" height="500" id="myCanvas">
 <ul>
  
    <li><h2><a href="/tags/Android/">Android</a></h2></li>
  
    <li><h2><a href="/tags/Bot/">Bot</a></h2></li>
  
    <li><h2><a href="/tags/CircleCI/">CircleCI</a></h2></li>
  
    <li><h2><a href="/tags/Docker/">Docker</a></h2></li>
  
    <li><h2><a href="/tags/GitHub/">GitHub</a></h2></li>
  
    <li><h2><a href="/tags/Google-Apps-Script/">Google Apps Script</a></h2></li>
  
    <li><h2><a href="/tags/HTML/">HTML</a></h2></li>
  
    <li><h2><a href="/tags/Heroku/">Heroku</a></h2></li>
  
    <li><h2><a href="/tags/Hugo/">Hugo</a></h2></li>
  
    <li><h2><a href="/tags/Java/">Java</a></h2></li>
  
    <li><h2><a href="/tags/JavaScript/">JavaScript</a></h2></li>
  
    <li><h2><a href="/tags/Linux/">Linux</a></h2></li>
  
    <li><h2><a href="/tags/Node-js/">Node.js</a></h2></li>
  
    <li><h2><a href="/tags/Python/">Python</a></h2></li>
  
    <li><h2><a href="/tags/Ruby/">Ruby</a></h2></li>
  
    <li><h2><a href="/tags/Scrapbox-io/">Scrapbox.io</a></h2></li>
  
    <li><h2><a href="/tags/Slack/">Slack</a></h2></li>
  
    <li><h2><a href="/tags/Twitter/">Twitter</a></h2></li>
  
    <li><h2><a href="/tags/WordPress/">WordPress</a></h2></li>
  
    <li><h2><a href="/tags/esa/">esa</a></h2></li>
  
    <li><h2><a href="/tags/guntohfes/">guntohfes</a></h2></li>
  
    <li><h2><a href="/tags/libnss-json/">libnss-json</a></h2></li>
  
  </ul>
 </canvas>
</div>
 


  <script>
  $(".archive").click(function (e) {
      if ($("title").text().indexOf( "群馬大学電子計算機研究会 IGGG" )>=0 ){
          if (e.target.href){
              $(".animated:contains(\'"+e.target.text+"\')").addClass("bounceOut");
              setTimeout(function(){
                  var pageTitle=e.target.text;
                  loadpage(pageTitle);
                  $(".animated:contains(\'"+e.target.text+"\')").removeClass("bounceOut");
                  history.pushState( pageTitle, $("title").text(), e.target.href);
              }, 500);
          }
      }
      return false;
  });
  </script>
  <script>
  $(".backtohome").click(function (e) {
      if ($("title").text() != "群馬大学電子計算機研究会 IGGG"){
          //go back to home
          setTimeout(function(){
              loadpage();
              history.pushState( null, $("title").text(), "/");
          }, 150);
      } else {
          //go to tag cloud
          loadpage("#tag");
          history.pushState( "#tag", $("title").text(), "#tag");
      }
      return false;
  });
  </script>

  <script>
  function loadpage(pageTitle) {
      scroll(0,0);
      if ( !pageTitle ){
          //home
          $('#myCanvasContainer').css("display","none");
          $("title").text("群馬大学電子計算機研究会 IGGG");
          $("[idplus]").css("display","none");
          $(".titlelist").css("display","");
      } else if ( pageTitle.indexOf("#tag")>=0 ) {
          //tagcloud
          $('#myCanvasContainer').css("display","");
          $("[idplus]").css("display","none");
          $(".titlelist").css("display","none");
          $("title").text("Tag Cloud | 群馬大学電子計算機研究会 IGGG");
      } else {
          //pages
          $('#myCanvasContainer').css("display","none");
          $("title").text(pageTitle + " | 群馬大学電子計算機研究会 IGGG");
          var pageIDplus=pageTitle.replace(/\s+/g,"")
          $(".titlelist").css("display","none");
          $("[idplus=\'" + pageIDplus +"\']" ).css("display","");
          $.ajaxPrefilter(function( options, originalOptions, jqXHR ) {
            options.async = true;
          });
          $("[idplusp=\'" + pageIDplus +"\']" ).replaceWith($("[idplus=\'" + pageIDplus +"\']").html().replace(/img\ s1c/g, "img src"));
          $.ajaxPrefilter(function( options, originalOptions, jqXHR ) {
            options.async = false;
          });
      }
  };
  </script>
  <script>
  window.addEventListener('popstate', function(e) {
      if (location.href.indexOf("#comment") > 0){
          location.reload();
      }else {
          loadpage(e.state);
      }
      },false);
  </script>
  <script>

  </script>



<nav id="pagination" class="titlelist">
  
    <a href="/" class="alignleft prev titlelist">Prev</a>
  
  
  <div class="clearfix"></div>
</nav>

</div></div>
    <div class="clearfix"></div>
  </div>

  <footer id="footer" class="inner"></footer>
  
<script src="/js/jquery.imagesloaded.min.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



<script src="/js/headroom.min.and.gallery.js"></script>
<script>
$("#mini-toggle").click(function () {
    $( "#main-nav" ).css("display","inline");
    setTimeout(function(){
        $( "#main-nav" ).removeClass("slideInRight").addClass("slideOutRight");
    }, 3000);
    setTimeout(function(){
        $( "#main-nav" ).css("display","");
        $( "#main-nav" ).removeClass("slideOutRight").addClass("slideInRight");
    }, 3555);
});
</script>

<script>
$("#header").headroom({
  "tolerance": 0,
  "offset": 200,
  "classes": {
    "initial": "",
    "pinned": "slideInDown",
    "unpinned": "slideOutUp"
  }
});
$("#header").headroom("destroy");
</script>

<script>
$("a").click(function () {
    $( "#icon-photo-small"  ).removeClass( "rotateIn" ).addClass( "rotateOut" );
    $( "#icon-photo-normal" ).removeClass( "rotateIn" ).addClass( "rotateOut" );
    setTimeout(function(){
        $( "#icon-photo-small"  ).removeClass( "rotateOut" ).addClass( "rotateIn" );
        $( "#icon-photo-normal" ).removeClass( "rotateOut" ).addClass( "rotateIn" );
    }, 900);
});
</script>


<script type="text/javascript">
  var _gaq = _gaq || [];
  // 拡張リンクのアトリビューション分析用のタグをページに設定する
  var pluginUrl =
   '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-46141384-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    // ユーザー属性とインタレスト カテゴリに関するレポートを有効にする
    // ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



<!--[if lt IE 9]><script src="/js/excanvas.js"></script><![endif]-->
<script src="/js/jquery.tagcanvas.min.js"></script>
 <script type="text/javascript">
 $(document).ready(function() {
   if( ! $('#myCanvas').tagcanvas({
     textColour : '#6d6d6d',
     outlineThickness : 1,
     textHeight: 20,
     maxSpeed : 0.04,
     depth : 0.75
   })) {
     // TagCanvas failed to load
     $('#myCanvasContainer').hide();
   }
   // your other jQuery stuff here...
 });
 </script>



</body>
</html>
